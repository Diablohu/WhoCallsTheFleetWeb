"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?t[Symbol.hasInstance](e):e instanceof t}function _b(e){return _support.check(e)}function addHandler(e,t,i){if("undefined"!=typeof e.addEventListener)e.addEventListener(t,i,!1);else{if("undefined"==typeof e.attachEvent)throw"Incompatible browser";e.attachEvent("on"+t,i)}}function eventName(e,t){return t=t?"."+t:"",_g.event[e]?_g.event[e].split(" ").map(function(e){return e+t}).join(" "):e+t}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},$window=$(window),$document=$(document),$html=$("html"),$body=$("body"),$body_preventMouseover=!1,$body_isTouch=!1,_g={isinit:!1,isload:!1,isfocus:document.hasFocus?document.hasFocus():!0,everfocus:document.hasFocus?document.hasFocus():!0,posttime:[],time_format:"m月d日",time_format2:"Y年m月d日",time_diff_range:3456e5,time_diff_range2:31536e6,last:{width:0,height:0},interval:{},initSize:20,baseSize:10,baseMultiper:1,lastBaseSize:10,pixelRatio:window.devicePixelRatio?window.devicePixelRatio:screen.deviceXDPI?screen.deviceXDPI/72:1,maxMultiper:Math.max(1,Math.ceil((screen.availHeight||screen.height||$window.height())/800*10)/10),strings:{},inputIndex:0,lang:"zh_cn",_:!1},_p={comp:{},el:{}},_frame={dom:{},init_all:function(){for(var e in _frame)_frame[e].init&&_frame[e].init()}},_module={},_page={},_data={};if("undefined"==typeof _huScrolled)var _huScrolled={};if(!_huScrolled.ver||_huScrolled.ver<1.2){_huScrolled.ver=1.2,_huScrolled.timeout=!1,_huScrolled.throttle=_huScrolled.throttle||100;var bIEnew=/\(Windows NT [0-9\.]+.+Trident\/[0-9\.]+.+rv.{1}[0-9\.]+\)/.test(navigator.userAgent),bIE=!(!window.attachEvent||window.opera)||bIEnew,el=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<9?$window:$document;el.on({"scroll.huScrolled":function(){return _huScrolled.timeout?!0:void(_huScrolled.timeout=setTimeout(function(){$document.trigger("huScrolled"),_huScrolled.timeout=null},_huScrolled.throttle))}})}if("undefined"==typeof _huResized)var _huResized={};if((!_huResized.ver||_huResized.ver<2.1)&&(_huResized.ver=2.1,_huResized.throttle=_huResized.throttle||300,_huResized.startSize={},_huResized.viewport=function(){var e=window,t="inner";return"innerWidth"in window||(t="client",e=document.documentElement||document.body),{width:e[t+"Width"],height:e[t+"Height"]}},$window.on({"resize.huResized":function(e,t){t=t||{};var i=_huResized.viewport(),n=_huResized.startSize.width||i.width,a=_huResized.startSize.height||i.height,o=Math.abs(i.width-n)>50||Math.abs(i.height-a)>50;_huResized.timeout&&(clearTimeout(_huResized.timeout),_huResized.timeout=null),_huResized.topmask||(_huResized.topmask=$("<div/>").css({"z-index":"16777269",display:"none",position:"fixed",width:"100%",height:"100%",top:0,left:0,"background-color":"rgba(0,0,0,.5)"}).appendTo($body)),!o||t.isInitial||_huResized.maskShowing||(_huResized.topmask.css("display","block"),_huResized.maskShowing=!0),o||_huResized.isChanging||(_huResized.startSize={width:i.width,height:i.height}),_huResized.isChanging=!0,_huResized.timeout=setTimeout(function(){$window.trigger("huResized"),_huResized.timeout=null,_huResized.maskShowing=!1,_huResized.isChanging=!1,_huResized.topmask.css("display","none"),i=_huResized.viewport(),_huResized.startSize={width:i.width,height:i.height}},t.isInitial?0:_huResized.throttle)}})),"undefined"==typeof _huCss)var _huCss={};(!_huCss.ver||_huCss.ver<1.2)&&(_huCss.ver=1.2,_huCss.cssprefix_result={},_huCss.csscheck=function(e){if(_huCss.csscheck_div||(_huCss.csscheck_div=document.documentElement),e in _huCss.csscheck_div.style)return!0;var t=e.split("-");e=t[0];for(var i=1;i<t.length;i++)e+=t[1].substr(0,1).toUpperCase()+t[1].substr(1);return e in _huCss.csscheck_div.style},_huCss.csscheck_full=function(e){return _huCss.cssprefix(e,null,!0)},_huCss.cssprefix=function(e,t,i){if(_huCss.cssprefix_result[e])var n=_huCss.cssprefix_result[e];else if(_huCss.cssprefix_result[e]===!1){if(i)return!1;var n=""}else{var n="",a=["-webkit-","-moz-","-ms-","-o-"],o=_huCss.csscheck(e);if(!o){n=!1;for(var s=0;s<a.length;s++)if(_huCss.csscheck(a[s]+e)){n=a[s];break}}if(_huCss.cssprefix_result[e]=n,i)return n=n===!1?!1:!0}return n=n===!1?"":n,t?n:n+e},_huCss.csscheck_3d=function(){return _huCss.csscheck_full("perspective")},_huCss.createSheet=function(e){var t=document.createElement("style");if(e&&(t.title=e),document.getElementsByTagName("head")[0].appendChild(t),window.createPopup||t.appendChild(document.createTextNode("")),e)for(var i=0;i<document.styleSheets.length;i++)if(document.styleSheets[i].title==e)return document.styleSheets[i];return document.styleSheets[document.styleSheets.length-1]},_huCss.getSheet=function(e){return e=e||_huCss.sheet,e||(_huCss.sheet=_huCss.createSheet("__huCss_sheet"),e=_huCss.sheet),e},_huCss.getCssRulesNum=function(e){return e=_huCss.getSheet(e),e.cssRules?e.cssRules.length:0},_huCss.addRule=function(e,t,i,n){var a="";n=_huCss.getSheet(n);for(var o in t)_huCss.csscheck_full(o)?a+=_huCss.cssprefix(o)+":"+t[o]+";":"opacity"==o&&_huCss.csscheck_full("filter")&&(a+="filter:alpha(opacity="+100*t[o]+")");if(i||0===i||(i=n.cssRules?n.cssRules.length:_huCss.getCssRulesNum()),n.insertRule)n.insertRule(e+"{"+a+"}",i);else for(e=e.split(","),o=0;o<e.length;o++)n.addRule(e[o],a,i)},_huCss.removeRule=function(e,t){if(!e&&0!==e)return!1;t=_huCss.getSheet(t);try{t.deleteRule(e)}catch(i){t.removeRule(e)}});var _UA=navigator.userAgent,bChrome=/Chrome/.test(_UA),bChromeVer=bChrome?/Chrome\/([0-9\.]+)/.exec(navigator.appVersion):!1,bSafari=/Safari/.test(_UA)&&!bChrome,bFirefox=/Firefox/.test(_UA),bOpera=/Opera/.test(_UA),bWebkit=/WebKit/.test(_UA),bWebkitVer=bWebkit?/(AppleWebKit|Safari)\/([0-9\.]+)/.exec(navigator.appVersion):!1,bIEnew=/\(Windows NT [0-9\.]+.+Trident\/[0-9\.]+.+rv.{1}[0-9\.]+\)/.test(_UA),bIEnewVer=bIEnew?parseFloat(_UA.split("rv:")[1]):!1,bIE=!(!window.attachEvent||window.opera)||bIEnew,bIE6=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<7,bIE7=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<8,bIE8=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<9,bIE9=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<10,bIE10=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<11,bIE11=bIEnewVer&&12>bIEnewVer,bGecko=!bIE&&!bIEnew&&!bWebkit&&-1!=_UA.indexOf("Gecko"),bIphone=/iPhone/i.test(_UA),bIpad=/iPad/i.test(_UA),bAndroid=/Android/i.test(_UA),bIOS=!1,bIOSver=bIphone||bIpad?/CPU.*OS\s*([0-9_]+)/i.exec(navigator.appVersion):!1,bMobile=bIphone||bIpad||bAndroid,bCSSrem=!bIE8,bCSS3=_huCss.csscheck_full("border-radius"),bCSS3A=_huCss.csscheck_full("animation"),bCSS3flex=_huCss.csscheck_full("flex"),b3D=_huCss.csscheck_full("perspective"),bCSS3calc=bCSSrem,bTouch=/Touch/.test(_UA),bUnsupport=bIE7,bHTML5m3u8=bMobile,bAccessYoutube=!1,bAccessTwitter=!1,bAccessFacebook=!1;if(bWebkitVer&&bWebkitVer.length&&(bWebkitVer=bWebkitVer[2]),bChromeVer&&bChromeVer.length&&(bChromeVer=parseFloat(bChromeVer[1])),bIOSver&&bIOSver.length&&(bIOSver=parseFloat(bIOSver[1].replace(/_/,".")),bIOS=!0),(bChromeVer&&29>bChromeVer||bIOSver&&7>bIOSver)&&(bCSS3flex=!1),bIOSver&&6>bIOSver&&(bCSS3calc=!1),bGecko?$html.addClass("is-gecko"):bIE11&&!bIE10?$html.removeClass("ie9").addClass("ie11"+(bTouch?" ie-touch":"")):bIE10&&!bIE9?$html.removeClass("ie9").addClass("ie10"+(bTouch?" ie-touch":"")):bMobile?($html.addClass("mobile"),bIOS&&$html.addClass("ios"),bIphone&&$html.addClass("iphone"),bIpad&&$html.addClass("ipad"),bAndroid&&$html.addClass("android")):537>bWebkitVer&&$html.addClass("oldwebkit"),bTouch&&$html.addClass("touch"),navigator.userAgent.match(/IEMobile\/10\.0/)){var msViewportStyle=document.createElement("style");msViewportStyle.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(msViewportStyle)}_g.getUrl=function(){return location.href.split("#")[0]},_g.uriSearchArr={},_g.uriHashArr={},_g.timeHash=function(){var e=new Date;return e=e.getTime()},_g.uriSearch=function(e){if(!_g.uriSearchArr.length){var t=location.search?location.search.split("?")[1]:"";t=t.split("&");for(var i=0;i<t.length;i++){var n=t[i].split("=");_g.uriSearchArr[n[0]]=n[1]||""}}return e?_g.uriSearchArr[e]:location.search.substr(location.search.indexOf("?")+1)},_g.uriHash=function(e,t,i){var n=location.hash,a=n?n.split("#")[1]:"";if(a=a.split("&"),!_g.uriHashInited){_g.uriHashArr={};for(var o in a){var s=a[o].split("=");""!==s[0]&&(_g.uriHashArr[s[0]]=s[1]||!1)}_g.uriHashInited=!0}if("object"==("undefined"==typeof e?"undefined":_typeof(e))){for(var r in e)n=_g.uriHash(r,e[r],n);location.hash=n}else if(t===!1||""===t)n=n.replace("&"+e+"="+_g.uriHashArr[e],"").replace(e+"="+_g.uriHashArr[e],""),"#"!=n&&""!=n&&n||(n="_"),location.hash=n;else if("undefined"!=typeof t){if(t==_g.uriHashArr[e])return t;var l=_g.uriHashArr[e]?n.replace(e+"="+_g.uriHashArr[e],e+"="+t):n+(""==n?"#":"&")+e+"="+t;return _g.uriHashArr[e]=t,i?l:(location.hash=l,t)}return e?_g.uriHashArr[e]||!1:location.hash.substr(location.hash.indexOf("#")+1)},_g.randNumber=function(e){var t=new Date;return t=t.getTime(),t=(9301*t+49297)%233280,e||(e=1e3),Math.ceil(t/233280*e)},_g.randInt=function(e,t){return Math.floor(Math.random()*parseInt(e)+(t?parseInt(t):0))},_g.scrollTo=function(e,t){if(isNaN(e)){e=$(e);var i=e.scrollTop()}else{t=e,e=$("html,body");var i=$window.scrollTop()}var n=Math.abs(i-t),a=$window.height(),o=a>=n?200:200*(n/a)*(2/3);e.stop().animate({scrollTop:t},o)},_g.get_em=function(e,t,i){var n=parseFloat(e);return t=t||$body,i=i||0,isNaN(n)?e:n/parseFloat(t.css("font-size"))+i+"em"},_g.get_fontsize=function(e){return e=e||$body,parseInt(e.css("font-size"))},_g.get_basesize=function(){return parseInt($body.css("font-size"))/_g.initSize*10},_g.get_basesize_true=function(){return parseInt($body.css("font-size"))},_g.get_basemultiper=function(){return parseFloat(_g.get_basesize()/10)},_g.get_rem=function(e){var t=parseFloat(e);return isNaN(t)?e:bCSSrem?t/_g.initSize+"rem":e},_g.rem=function(e,t){var i=parseFloat(e);return isNaN(i)?e:bCSSrem?(i=i/(_g.get_basesize()/10)/_g.initSize,t?i+"rem":Math.round(10*i)/10+"rem"):e},_g.px=function(e,t){var i=parseFloat(e);return isNaN(i)?e:bIE8?e:i*_g.initSize+(t?0:"px")},_g.get_animate_duration=function(e){return _g.isfocus?e:0},_g.goto_hash=function(e,t){if(e=e||location.hash,e=e.replace(/^([\#]{0,1})(.+)/,"$2"),"!"==e[0])return!1;var i=$("#"+e);if(!i.length)return!1;var n=i.offset().top,a=$window.scrollTop(),o=Math.abs(a-n),s=$window.height();return t=null==t?s>=o?200:200*(o/s)*(2/3):t,t?$("html,body").stop().animate({scrollTop:n},t,function(){location.hash=e}):($("html,body").scrollTop(n),location.hash=e),e},_g.time=function(e){if(!e)return _g.timeNow();for(var t,i=[{exp:/(\d{4}).(\d{1,2}).(\d{1,2})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})([\+\-])(\d{2})\:(\d{2})/i,p:{year:1,month:2,day:3,hour:4,min:5,sec:6,zoneD:7,zoneH:8,zoneM:9}},{exp:/(\d{1,2}).(\d{1,2}).(\d{4})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})/i,p:{year:3,month:1,day:2,hour:4,min:5,sec:6}},{exp:/(\d{4}).(\d{1,2}).(\d{1,2})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})/i,p:{year:1,month:2,day:3,hour:4,min:5,sec:6}}],n=0;n<i.length;n++){var a=i[n].exp,o=e.match(a);if(!t&&o&&o.length){var s=parseInt(o[i[n].p.year]),r=parseInt(o[i[n].p.month])||0,l=parseInt(o[i[n].p.day])||1,d=parseInt(o[i[n].p.hour])||0,u=parseInt(o[i[n].p.min])||0,c=parseInt(o[i[n].p.sec])||0;if(t=new Date(s,r-1,l,d,u,c,0),i[n].p.zoneD&&o[i[n].p.zoneD]){var h="+"==o[i[n].p.zoneD]?-1:1,d=parseInt(o[i[n].p.zoneH])||0,u=parseInt(o[i[n].p.zoneM])||0,p=h*(u+60*d+t.getTimezoneOffset())*60*1e3;t=new Date(t.valueOf()+p)}}}return t},_g.timeCal=function(e,t){return 6e4>e?Math.floor(e/1e3)+"秒"+(t?"前":""):36e5>e?Math.floor(e/6e4)+"分钟"+(t?"前":""):864e5>e?Math.floor(e/36e5)+"小时"+(t?"前":""):1728e5>e?"昨天":2592e6>e?Math.floor(e/864e5)+"天"+(t?"前":""):31536e6>e?Math.floor(e/2592e6)+"月"+(t?"前":""):Math.floor(e/31536e6)+"年"+(t?"前":"")},_g.timeNow=function(){var e=new Date;return e.getTime()},_g.timeDiff=function(e){var t={time:_g.timeNow(),obj:null,format:_g.time_format,format2:_g.time_format2,range:_g.time_diff_range,range2:_g.time_diff_range2,is_init:!0};return $.extend(t,e),t.obj?e=t:!1},_g.timeDiffInterval=function(){function e(){if(!_g.isfocus)return!1;for(var e=0;e<_g.posttime.length;e++){var t=_g.posttime[e].is_init?_g.posttime[e]:_g.timeDiff(_g.posttime[e]),i=new Date,n=i.getTime()-t.time,a=t.range,o=t.range2;if(a>n)t.obj.html(6e4>n?"刚刚":_g.timeCal(n,!0));else{var s=n>o?t.format2:t.format,r=t.time;s=s.replace(/Y/g,r.getFullYear()),s=s.replace(/M/g,r.getMonth()+1<10?"0"+(r.getMonth()+1):r.getMonth()+1),s=s.replace(/m/g,r.getMonth()+1),s=s.replace(/D/g,r.getDate()<10?"0"+r.getDate():r.getDate()),s=s.replace(/d/g,r.getDate()),t.obj.html(s)}}}clearInterval(_g.interval.posttime),e(),_g.interval.posttime=setInterval(function(){e()},6e4)};var _support={cache:{},check:function(e){return e=e.toLowerCase().replace(/[ :-_]/g,""),"undefined"==typeof _support.cache[e]&&_support["_"+e]&&(_support.cache[e]=_support["_"+e]()),_support.cache[e]}};_support._css3=function(){return _huCss.csscheck_full("border-radius")},_support._css3animation=function(){return _huCss.csscheck_full("animation")},_support._css3transition=function(){return _huCss.csscheck_full("transition")},_support._css3flex=function(){return _huCss.csscheck_full("flex")},_support._css33d=function(){return _huCss.csscheck_full("perspective")},_support._css3d=_support._css33d,_support._css3mediaquery=function(){return window.matchMedia||window.msMatchMedia?!0:!1},_support._mediaquery=_support._css3mediaquery,_support._css3imageset=function(){function e(e){i.css("background-image","image-set(url("+_g.pathImg+"_g-p.gif) 1x)");var t=i.css("background-image");return t&&"none"!=t?!0:e&&(i.css("background-image",e+"image-set(url("+_g.pathImg+"_g-p.gif) 1x)"),t=i.css("background-image"),t&&"none"!=t)?e:!1}var t=null,i=$("<div/>",{style:"background-image:url("+_g.pathImg+"_g-p.gif)"});return t=bWebkit?e("-webkit-"):bGecko?e("-moz-"):bIE?e("-ms-"):e()},_support._pluginflash=function(){var e=!1;try{e="undefined"!=typeof navigator.plugins&&"object"==_typeof(navigator.plugins["Shockwave Flash"])||window.ActiveXObject&&0!=new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(t){}return e},_support._flash=_support._pluginflash,_support._html5attrdownload=function(){return"download"in document.createElement("a")},_support._html5download=_support._html5attrdownload,_support._html5attributedownload=_support._html5attrdownload,_support._html5videomp4=function(){var e=document.createElement("video"),t=!1;return e.canPlayType&&e.canPlayType("video/mp4").replace(/no/,"")&&(t=!0),t},_support._html5mp4=_support._html5videomp4,_g.init=function(){if(_g.baseSize=_g.get_basesize(),_g.baseMultiper=parseFloat(_g.baseSize/10),_g.lastBaseSize=_g.get_basesize(),_g.isfocus="visible"==Visibility.state(),_g.everfocus=_g.isfocus,Visibility.change(function(e,t){"visible"==t?(_g.isfocus=!0,_g.everfocus||(_g.everfocus=!0,_g.last.width=-1,_g.last.height=-1,_frame.main.last.width=-1,_frame.main.last.height=-1),$window.trigger("resized_check._g"),_g.timeDiffInterval()):_g.isfocus=!1}),$window.on({orientationchange:function(){$window.trigger("resize")},huResized:function(){$window.trigger("resized_check._g")},"resized_check._g":function(){if(!_g.isfocus)return!1;var e=$window,t=e.width(),i=e.height();if(_g.baseSize=_g.get_basesize(),_g.orientation=t>=i?"landscape":"portrait",_g.baseSize!=_g.lastBaseSize&&(_g.baseMultiper=parseFloat(_g.baseSize/10),_g.lastBaseSize=_g.baseSize,_g.isBaseChange=!0,e.trigger("basechange")),t!=_g.last.width||i!=_g.last.height){var n={is_widthchange:t!=_g.last.width,is_heightchange:i!=_g.last.height};e.trigger("resized_before",[n]).trigger("resized",[n]),_g.isEverResized=!0}_g.last.width=t,_g.last.height=i},basechange:function(){_g.isBaseChange&&(_g.isBaseChange=!1,setTimeout(function(){$window.trigger("resized_before").trigger("resized",[{is_basechange:!0}])},_g.animate_duration_delay))},"load.trigger_resized":function(){return _g.isfocus?(setTimeout(function(){$window.trigger("resized_before",[{is_load:!0}]).trigger("resized",[{is_load:!0}])},_g.readyLock?4*_g.animate_duration+10:0),void(_g.isload=!0)):!1},"hashchange._global":function(e){_g.uriHashArr={};var t=(location.hash?location.hash.split("#")[1]:"").split("&");for(var i in t){var n=t[i].split("=");""!==n[0]&&(_g.uriHashArr[n[0]]=n[1]||!1)}_g.uriHashInited=!0,_g.uriHash()&&""!=_g.uriHash()||(e.preventDefault(),e.stopPropagation())},"unload.focuswindow":function(){$(this).focus()}}),setTimeout(function(){$window.trigger("hashchange")},_g.animate_duration_delay+10),$document.on({huScrolled:function(){$window.trigger("scrolled")}}),$body.on({"touchstart.preventMouseover":function(){$body.removeClass("hover"),$body_preventMouseover=!0,$body_isTouch=!0},pointerenter:function(e){"touch"==e.originalEvent.pointerType?$body.trigger("touchstart.preventMouseover"):($body_preventMouseover=!1,$body_isTouch=!1)},mouseover:function(){$body_isTouch?($body_isTouch=!1,$body_preventMouseover=!0):($body.addClass("hover"),$body_preventMouseover=!1)},mouseleave:function(){$body.removeClass("hover")}}),top!=self)try{self.location.host!=top.location.host&&top.location.replace(self.location.href),self.location.host==top.location.host&&($body.addClass("only-content"),_g.changeTheme(top._g.getTheme())),$html.css("font-size",top.$html.css("font-size")),$window.on({"resized.iframe_resize":function(){$html.css("font-size",top.$html.css("font-size"))}})}catch(e){}_hotkey.init(),_frame.init_all(),_p.init_document_ready(),$html.addClass("ready"),$window.trigger("resize",[{isInitial:!0}]),_g.readyLock=!0,setTimeout(function(){_g.readyLock=null},4*_g.animate_duration+10);try{window.external.msSiteModeClearBadge()}catch(e){}return _g.isinit=!0,!1},jQuery.cookie=function(e,t,i){if("undefined"==typeof t){var n=null;if(document.cookie&&""!=document.cookie)for(var a=document.cookie.split(";"),o=0;o<a.length;o++){var s=jQuery.trim(a[o]);if(s.substring(0,e.length+1)==e+"="){n=decodeURIComponent(s.substring(e.length+1));break}}return n}i=i||{},null===t&&(t="",i.expires=-1);var r="";if(i.expires&&("number"==typeof i.expires||i.expires.toUTCString)){var l;"number"==typeof i.expires?(l=new Date,l.setTime(l.getTime()+24*i.expires*60*60*1e3)):l=i.expires,r="; expires="+l.toUTCString()}var d="; path="+(i.path?i.path:"/"),u=i.domain?"; domain="+i.domain:/(.*)([\.]*)acgdb\.com/.test(location.host)?"; domain=.acgdb.com":"",c=i.secure?"; secure":"";document.cookie=[e,"=",encodeURIComponent(t),r,d,u,c].join("")},function(e){e.fn.innerWidth=function(){return parseFloat(this.css("width"))},e.fn.innerHeight=function(){return parseFloat(this.css("height"))}}(jQuery),$.fn.serializeObject=function(){function e(i,n,a){if(!n.length)return i;var o=n[0];"undefined"==typeof i[o]?i[o]=n.length>1?{}:a:1==n.length&&(i[o].push||(i[o]=[i[o]]),i[o].push(t(a))),n.shift(),e(i[o],n,a)}function t(e){return"number"==typeof e&&0===e?e:e||""}var i={},n=this.serializeArray();return $.each(n,function(){if(!/^_tabview\-/.test(this.name))if(this.value=isNaN(this.value)||!this.value?this.value:parseFloat(this.value),this.name.indexOf(".")>-1){var n=this.name.split(".");e(i,n,this.value)}else i[this.name]||0===i[this.name]?(i[this.name].push||(i[this.name]=[i[this.name]]),i[this.name].push(t(this.value))):i[this.name]=t(this.value)}),i},_p.initDOM=function(e){return e=e||_frame.dom.layout||_frame.dom.layout||$body,e.initAll()},_p.initAll=_p.initDOM,$.fn.initDOM=function(){for(var e in _p.el)_p.el[e].init&&_p.el[e].init(this);return this},$.fn.initAll=$.fn.initDOM,_p.init_document_ready=function(){_p.is_init_document_ready||(_p.initDOM($body),_p.is_init_document_ready=!0)},_p.getSummary=function(){var e=$("#summary").text()||!1;return!e&&$("head").find("meta[name=keywords]").length&&(e=$("head").find("meta[name=Description]").attr("content"),e=e.substr(0,e.indexOf(" - ACGDB"))),e},_p.get_tar=function(e,t,i){return e=e||_frame.dom.layout||$("#layout")||$body,"."==t.substr(0,1)&&(t=t.substr(1)),e.hasClass(t)?e:i?e.find('[class^="'+t+'"]'):e.find("."+t)},_p.hashlinks=function(e){e=e||$body,e.find("a[href^=#]").each(function(){$(this).off("click.hashlink").on({"click.hashlink":function(){return _g.goto_hash($(this).attr("href")),!1}})})},_p.get_lines=function(e,t){return t=t||e,Math.max(1,Math.floor(Math.min(e.innerHeight(),e.height())/parseFloat(t.css("line-height"))))},_p.el.time={init:function(e){var t=_p.get_tar(e,".time");t.each(function(){var e=$(this),t=e.text();time=t?_g.time(t):null,time&&_g.posttime.push({time:time,obj:e})}),_g.timeDiffInterval()}},_p.el.timeSec={init:function(e){var t=_p.get_tar(e,".time-sec");t.each(function(){var e=$(this);if(e.data("acgdb-time-sec"))return e.data("acgdb-time-sec");var t=e.text(),i=/\s*([0-9]+)/.exec(t);if(i&&i.length>1){i=parseInt(i[1]);var n=Math.floor(i/60),a=i%60,o=(10>n?"0":"")+n+":"+(10>a?"0":"")+a+"'";e.text(o)}e.data("acgdb-time-sec",i)})}},_p.removeEmptyTextNode=function(e){return e=$(e),e.length?void e.contents().filter(function(){return 3===this.nodeType}).remove():!1},Object.defineProperty(Array.prototype,"mergeFrom",{enumerable:!1,value:function(e){return Array.prototype.push.apply(this,_instanceof(e,Array)?e:[e]),this}}),Date.prototype.format=function(e,t){return _g.formatTime(this,e,t)},_g.formatTime_string={zh_CN:{Midnight:"深夜",Sunday:"周日",Monday:"周一",Tuesday:"周二",Wednesday:"周三",Thursday:"周四",Friday:"周五",Saturday:"周六"}},_g.formatTime_weekdaymappding=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],_g.formatTime=function(e,t,i){function n(e){return 10>e?"0"+e:e}if(!e)return!1;i=i||{},t=t||"%Y年%m月%d日","date"!=typeof e&&(e=new Date(e));var a=e.valueOf();"undefined"!=typeof i.output_timezone&&(a+=60*(i.output_timezone+e.getTimezoneOffset()/60)*60*1e3,e=new Date(a));var o=e.getHours(),s=n(o);return i.midnight_astoday&&(6>o||24==o)?(o+=24,s=o,a-=864e5,e=new Date(a),t=t.replace(/\%midnight/g,"Midnight"._(_g.formatTime_string))):t=t.replace(/\%midnight/g,""),t.replace(/\%Y/g,e.getFullYear()).replace(/\%m/g,n(e.getMonth()+1)).replace(/\%n/g,e.getMonth()+1).replace(/\%d/g,n(e.getDate())).replace(/\%j/g,e.getDate()).replace(/\%G/g,o).replace(/\%H/g,s).replace(/\%i/g,n(e.getMinutes())).replace(/\%s/g,n(e.getSeconds())).replace(/\%l/g,_g.formatTime_weekdaymappding[e.getDay()]._(_g.formatTime_string))},Object.defineProperty(Object.prototype,"_size",{enumerable:!1,get:function(){var e=0;for(var t in this)e++;return e}}),String.prototype.getText=function(e,t){return _g.getText(this,e,t,!0)},String.prototype._=String.prototype.getText,_g.getText=function(e,t,n,a){function o(e){return"object"==("undefined"==typeof e?"undefined":_typeof(e))&&e.length?e[0]:e}if(!e||!t)return e;n=n||_g.lang;if(t[e]){if("string"==typeof t[e])return o(t[e]);if(t[e][n])return o(t[e][n])}if(t[n]&&t[n][e])return o(t[n][e]);if("string"!=typeof e&&a){for(_t="",i=0;i<e.length;i++)_t+=e[i];e=_t}return o(e)},_g.hashCode=function(e){var t=5;e=encodeURIComponent(e);try{return e.split("").reduce(function(e,i){return e=(e<<t)-e+i.charCodeAt(0),e&e},0).toString(16)}catch(i){var n,a,o=0;if(0==e.length)return o;for(n=0,l=e.length;n<l;n++)a=e.charCodeAt(n),o=(o<<t)-o+a,o|=0;return o.toString(16)}},String.prototype.hashCode=function(){return _g.hashCode(this)},String.prototype.filter=function(){return _g.stringFilter(this)},String.prototype.filterCensored=function(){return _g.stringFilterCensored(this)},String.prototype.escape=function(){return $("<div />").text(this).html()};var _tmpl={"export":function(e,t){return e.attr&&t?e.prop("outerHTML"):e.attr&&!t?e:!e.attr&&t?e:e.attr||t?void 0:$(e)}},_hotkey={allowed:!0,keyCodeBindings:{}};_hotkey.bind=function(e,t,i,n){if("function"==typeof t)return _hotkey.bind(e,null,t,i);if(!e||!i)return!1;e=parseInt(e),t="text"==typeof t?[t]:t||[],n=n||{},"undefined"==typeof _hotkey.keyCodeBindings[e]&&(_hotkey.keyCodeBindings[e]={"default":[],meta:[],alt:[],shift:[],"meta+alt":[],"meta+shift":[],"alt+shift":[],"meta+alt+shift":[]});var a=!1,o=!1,s=!1;for(var r in t)t[r]=t[r].toLowerCase(),("ctrl"==t[r]||"meta"==t[r])&&(a=!0),"alt"==t[r]&&(o=!0),"shift"==t[r]&&(s=!0);return a&&o&&s?_hotkey.keyCodeBindings[e]["meta+alt+shift"].push(i):a&&o?_hotkey.keyCodeBindings[e]["meta+alt"].push(i):a&&s?_hotkey.keyCodeBindings[e]["meta+shift"].push(i):o&&s?_hotkey.keyCodeBindings[e]["alt+shift"].push(i):a?_hotkey.keyCodeBindings[e].meta.push(i):o?_hotkey.keyCodeBindings[e].alt.push(i):s?_hotkey.keyCodeBindings[e].shift.push(i):_hotkey.keyCodeBindings[e]["default"].push(i),!0},_hotkey._run=function(e){for(var t in e)e[t]()},_hotkey.init=function(){return _hotkey.is_init?_hotkey:($window.on("keydown._hotkey",function(e){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"SELECT"!=document.activeElement.tagName&&!document.activeElement.hasAttribute("contenteditable")&&_hotkey.allowed){var t=parseInt(e.keyCode||e.which);_hotkey.keyCodeBindings[t]&&((e.ctrlKey||e.metaKey)&&e.altKey&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+alt+shift"]):(e.ctrlKey||e.metaKey)&&e.altKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+alt"]):(e.ctrlKey||e.metaKey)&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+shift"]):e.altKey&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["alt+shift"]):e.ctrlKey||e.metaKey?_hotkey._run(_hotkey.keyCodeBindings[t].meta):e.altKey?_hotkey._run(_hotkey.keyCodeBindings[t].alt):e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t].shift):e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||_hotkey._run(_hotkey.keyCodeBindings[t]["default"]))}}),void(_hotkey.is_init=!0))};var _form={};_form.section=function(e,t,i,n,a,o){if(!e)return!1;if("object"==("undefined"==typeof e?"undefined":_typeof(e)))return _form.section(e.type,e.name||null,e.label||null,e.value||null,e.suffix||null,e);if("object"==("undefined"==typeof t?"undefined":_typeof(t)))return _form.section(e,t,t.label||null,t.value||null,t.suffix||null,t);if("object"==("undefined"==typeof i?"undefined":_typeof(i)))return _form.section(e,t,i.label||null,i.value||null,i.suffix||null,i);if("object"==("undefined"==typeof n?"undefined":_typeof(n)))return _form.section(e,t,d,n.value||null,n.suffix||null,n);if("object"==("undefined"==typeof a?"undefined":_typeof(a)))return _form.section(e,t,d,n||null,a.suffix||null,a);o=o||{};var s=$("<dl/>").addClass(e,o.className),r=$("<dt/>").appendTo(s),l=$("<dd/>").appendTo(s),d="_input_g"+_g.inputIndex;switch(_g.inputIndex++,e){case"directory":$("<label/>").html(i).appendTo(r);break;default:a?$("<label/>").html(i).appendTo(r):$('<label for="'+d+'"/>').html(i).appendTo(r)}return _form.element(e,t,d,n,o).appendTo(l),a&&$('<label for="'+d+'"/>').html(a).appendTo(l),o.add&&l.append(o.add),l},_form.line=_form.section,_form.element=function(e,t,i,n,a){if(!e)return!1;if("object"==("undefined"==typeof e?"undefined":_typeof(e)))return _form.element(e.type,e.name||null,e.id||null,e.value||null,e);if("object"==("undefined"==typeof t?"undefined":_typeof(t)))return _form.element(e,t,t.id||null,t.value||null,t);if("object"==("undefined"==typeof i?"undefined":_typeof(i)))return _form.element(e,t,i.id||null,i.value||null,i);if("object"==("undefined"==typeof n?"undefined":_typeof(n)))return _form.element(e,t,i,n.value||null,n);a=a||{},i=i||null,null===i&&(i="_input_g"+_g.inputIndex,_g.inputIndex++);var o=$(),s=a["default"]||a.defaultValue;switch(e){default:o=$("<input/>",{type:e,name:t,id:i}).val(n);break;case"select":o=$("<select/>",{name:t,id:i}).val(n);var r=$('<option value=""/>').appendTo(o);for(var l in n){if("object"==_typeof(n[l]))var d=n[l].value||n[l].val,u=$('<option value="'+d+'"/>').html(n[l].title||n[l].name).appendTo(o);else var d=n[l],u=$('<option value="'+d+'"/>').html(d).appendTo(o);"undefined"!=typeof s&&d==s&&u.prop("selected",!0),u.val()||u.attr("disabled",!0)}n&&n.length||r.html("..."),a["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),o.on("change.___new___",function(){"___new___"==o.val()&&(o.val(""),a["new"](o))}));break;case"select_group":case"selectGroup":o=$("<select/>",{name:t,id:i}).val(n);var r=$('<option value=""/>').appendTo(o);for(var l in n){var c=$('<optgroup label="'+n[l][0]+'"/>').appendTo(o);for(var h in n[l][1]){var p=n[l][1][h];if("object"==("undefined"==typeof p?"undefined":_typeof(p)))var u=$('<option value="'+("undefined"==typeof p.val?p.value:p.val)+'"/>').html(p.title||p.name).appendTo(c);else var u=$('<option value="'+p+'"/>').html(p).appendTo(c);"undefined"!=typeof s&&u.val()==s&&u.prop("selected",!0),u.val()||u.attr("disabled",!0)}}n&&n.length||r.html("..."),a["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),o.on("change.___new___",function(){"___new___"==o.val()&&(o.val(""),a["new"](o))}));break;case"checkbox":o=$("<input/>",{type:e,name:t,id:i}),"string"==typeof n&&"true"!==n.toLowerCase()?o.val(n).prop("checked",a.checked):o.prop("checked","undefined"==typeof a.checked?n:a.checked);break;case"checkboxes":for(var l in n){var d=n[l];"object"!=("undefined"==typeof d?"undefined":_typeof(d))&&(d=[d,!1]),parseInt(l)&&(_g.inputIndex++,i="_input_g"+_g.inputIndex),o=o.add($('<input type="checkbox" name="'+t+'" id="'+i+'" value="'+d[0]+'" />').prop("checked",d[1])).add($('<label for="'+i+'"/>').html(d[2]||d[0]))}break;case"directory":case"file":o=$('<input type="text" name="'+t+'" id="'+i+'" />').on({input:function(){o.trigger("change")},click:function(){o.val()||f.trigger("click")}}).val(n);var m=$('<input type="file" class="none"'+("directory"==e?" nwdirectory":"")+" />").on("change",function(){o.val($(this).val()).trigger("change")}),f=$('<button type="button" value="Browse..."/>').html("Browse...").on("click",function(){m.trigger("click")}),_=o.add(m).add(f);a.accept&&m.attr("accept",a.accept)}return a.required&&o.prop("required",!0),a.onchange&&(o.on("change.___onchange___",a.onchange),a["default"]&&o.trigger("change")),_?_:o},_frame.dom={},_frame.main={last:{}},_frame.global={key_registerd:[],esc_funcs:[],allowKeyNav:!0,esc_register:function(e){_frame.global.esc_funcs.push(e)},disableBodyScroll:function(){$(document.body).on("touchmove.disableBodyScroll mousewheel.disableBodyScroll",function(e){e.preventDefault(),e.stopPropagation()})},enableBodyScroll:function(){$(document.body).off("touchmove.disableBodyScroll mousewheel.disableBodyScroll")}},_frame.global.init=function(){return _frame.global.is_init?!0:(_frame.dom={layout:$("#layout")},$body.on({"keydown.esckey":function(e){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"SELECT"!=document.activeElement.tagName&&!$(document.activeElement).attr("contenteditable")&&_frame.global.allowKeyNav){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=window.event?e.keyCode:e.which;t=t.toString()}}else if(!_frame.global.allowKeyNav&&!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){
var t=window.event?e.keyCode:e.which;switch(t=t.toString()){case"27":for(var i=0;i<_frame.global.esc_funcs.length;i++)_frame.global.esc_funcs[i]()}}}}),_frame.dom.hidden=$("<div/>",{"class":"none"}).appendTo($body),_frame.dom.hiddenVisible=$("<div/>",{"class":"none-visible"}).appendTo($body),_frame.dom.hiddenIframe=$("<iframe/>",{"class":"none",name:"hiddeniframe"}).appendTo($body),$body.on("submit.check_submitting_status","form",function(e){var t=$(this);(t.hasClass("submitting")||t.hasClass("loading")||t.hasClass("disabled"))&&e.preventDefault()}),_frame.global.is_init=!0,!0)};var _menu=function(e){this.settings||(this.settings=$.extend(!0,{},this.defaults,e||{}),this.init())};_menu.prototype.defaults={items:[],target:null,className:null,showBlured:!0},_menu.prototype.init=function(){var e=this;this.dom={},this.dom.menu=$('<div class="menu"/>').addClass(this.settings.className).on("click",function(){e.timeout_hideself||(e.timeout_hideself=setTimeout(function(){e.timeout_hideself=null,e.hide()},10))}),this.dom.body=$('<div class="body"/>').appendTo(this.dom.menu),this.dom.menu.on({"transitionend.menu_hide webkitTransitionEnd.menu_hide mozTransitionEnd.menu_hide":function(t){t.currentTarget==t.target&&"opacity"==t.originalEvent.propertyName&&0===parseFloat(e.dom.menu.css("opacity"))&&e.hideTrue()}});for(var t,i=0;t=this.settings.items[i];i++)if(t){switch(t){case"separator":t=$("<hr/>")}t.hasClass("donot_hide")&&t.on("click",function(){setTimeout(function(){clearTimeout(e.timeout_hideself),e.timeout_hideself=null},1)}),e.appendItem(t)}this.dom.body.find('input[type="checkbox"]+label').addClass("checkbox"),this.settings.showBlured&&_huCss.csscheck_full("backdrop-filter")?this.dom.menu.addClass("mod-blur-backdrop"):this.settings.showBlured&&"undefined"!=typeof node&&this.dom.menu.addClass("mod-blur-shot"),_frame.menu.menus.push(this)},_menu.prototype.show=function(e,t,i){if(this.showing)return this;if("number"==typeof e)return this.show("mouse",e,t);var n,a,o,s,r,l;if(e=e||this.settings.target,clearTimeout(_frame.menu.timeout_hideall),_frame.menu.timeout_hideall=null,this.dom.menu.appendTo(_frame.menu.dom.container).addClass("show"),_frame.menu.dom.container.addClass("on"),this.showing=!0,this.dom.body.children().trigger("show"),e&&_instanceof(e,jQuery)){var d=e.offset();n=d.top+e.height()-$body.scrollTop()+(i||0),a=d.left-$body.scrollLeft()+(t||0)}else("mouse"==e||!e&&"number"==typeof t)&&(a=t||0,n=i+5||0);o=$window.height()-10,s=$window.width()-10,r=this.dom.menu.outerHeight(),l=this.dom.menu.outerWidth(),this.dom.menu.css({top:n+r>o?o-r:n,left:a+l>s?s-l:a}),this.settings.showBlured&&"undefined"!=typeof node?node.win.capturePage(this.capturePage_callback.bind(this),"jpg","datauri"):this.dom.menu.addClass("on")},_menu.prototype.hide=function(){return this.showing?(this.dom.menu.hasClass("on")||this.hideTrue(),void this.dom.menu.removeClass("on")):!1},_menu.prototype.hideTrue=function(){this.dom.menu.removeClass("show").css({top:"",left:""}).detach(),_instanceof(this.dom.blured,jQuery)&&(this.dom.blured.remove(),delete this.dom.blured),this.showing=!1,_frame.menu.dom.container.removeClass("on")},_menu.prototype.appendItem=function(e){return _instanceof(e,jQuery)?e.appendTo(this.dom.body):void 0},_menu.prototype.capturePage_callback=function(e){this.showing&&(this.dom.blured=$('<s class="blured"/>').css("background-image","url("+e+")").appendTo(this.dom.menu.addClass("on")))},_menu.hideAll=function(e){_frame.menu.timeout_hideall=setTimeout(function(){for(var e in _frame.menu.menus)_frame.menu.menus[e].hide&&_frame.menu.menus[e].hide();_frame.menu.timeout_hideall=null},e||1)},_frame.menu={dom:{},menus:[],init:function(){return this.is_init?this:(this.dom.container=$('<div class="menus"/>').on({click:function(e,t){_menu.hideAll(t)},contextmenu:function(){_frame.menu.dom.container.trigger("click")}}).appendTo($body),$body.on("click.cancel_hideall",".menus>.menu",function(e){clearTimeout(_frame.menu.timeout_hideall),_frame.menu.timeout_hideall=null}),void(this.is_init=!0))}},_frame.modal={dom:{},defaults:{classname:"",showBlured:!0},show:function(e,t,i,n){clearTimeout(this.hide_timeout),this.hide_timeout=null,this.dom.container.addClass("show"),this.showing=!0;var a=$.extend({},this.defaults,i);a.detach&&(this.content=e),e.appendTo(this.dom.content),t?(this.dom.titlebar.html(t),this.dom.container.addClass("hastitle")):(this.dom.titlebar.html(""),this.dom.container.removeClass("hastitle")),this.dom.box.css({width:a.width||null,height:a.height||null}),a.showBlured&&(_huCss.csscheck_full("backdrop-filter")?this.dom.container.addClass("mod-blur-backdrop"):this.dom.blured||"undefined"==typeof node||(node.win.capturePage(function(e){_frame.modal.dom.blured=$("<img/>").attr("src",e).appendTo(_frame.modal.dom.bg)},"jpg","datauri"),this.dom.container.addClass("mod-blur-shot"))),setTimeout(function(){_frame.modal.dom.container.addClass("on "+a.classname).data("customclass",a.classname)},0),_p.initDOM(this.dom.content),this.dom.bg.off("click.blank_to_close").on("click.blank_to_close",function(){a.blank_to_close&&_frame.modal.dom.btn_close.trigger("click")}),n&&n(this.dom.content)},hide:function(){return this.showing?(clearTimeout(this.hide_timeout),this.hide_timeout=null,void this.dom.container.removeClass("on")):!1},reset:function(){this.resetContent(),this.dom.blured&&(parseInt(this.dom.container.css("opacity"))||(this.dom.blured.remove(),this.dom.blured=null),this.dom.container.removeClass("mod-blur-backdrop mod-blur-shot"))},resetContent:function(){this.content&&(this.content.detach(),this.content=null),this.dom.content.empty(),this.dom.container.removeClass(this.dom.container.data("customclass")),this.dom.container.data("customclass",""),this.dom.titlebar.html(""),this.dom.container.removeClass("hastitle")}},_frame.modal.init=function(){return this.is_init?!0:(this.dom.container=$('<div class="modal" />').on({"transitionend.modal_hide webkitTransitionEnd.modal_hide mozTransitionEnd.modal_hide":function(e){_frame.modal.showing&&e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.modal.dom.container.css("opacity")&&(_frame.modal.hide_timeout=setTimeout(function(){_frame.modal.reset(),_frame.modal.dom.container.removeClass("show"),_frame.modal.showing=!1},10))}}).prependTo($body),this.dom.box=$("<div/>").appendTo(this.dom.container),this.dom.titlebar=$("<header/>").appendTo(this.dom.box),this.dom.content=$("<section/>").appendTo(this.dom.box),this.dom.btn_close=$('<button class="close" />').html("&times;").on("click",function(){_frame.modal.hide()}).appendTo(this.dom.box),this.dom.bg=$("<s/>").appendTo(this.dom.container),_hotkey.bind("27",function(){_frame.modal.hide()}),this.is_init=!0,!0)},_p.tip={pos:"bottom",size_indicator:8,filters:[],countdown_fade:250,init_global:function(){return this.is_init?!1:(this.dom=$('<div id="tip"/>').on("transitionend webkitTransitionEnd mozTransitionEnd",function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_p.tip.dom.css("opacity")&&(_p.tip.dom.removeClass("show").css({top:"",left:""}).attr({"data-tip-indicator-pos":"","data-tip-indicator-offset-x":"","data-tip-indicator-offset-y":""}),_p.tip.dom_bluredbg&&_p.tip.dom_bluredbg.css("background-image",""))}).appendTo($body),this.dom_body=$('<div class="body"/>').appendTo(this.dom),_huCss.csscheck_full("backdrop-filter")?this.dom.addClass("mod-blur-backdrop"):"undefined"!=typeof node&&(this.dom.addClass("mod-blur-shot"),this.dom_bluredbg=$("<div/>").appendTo($('<div class="bluredbg"/>').appendTo(this.dom))),void(this.is_init=!0))},show:function(e,t,i){return e?(clearTimeout(this.timeout_fade),this.timeout_fade=null,t=t||"body",this.el=$(t),i=i||this.pos,e=this.content(e),this.init_global(),this.dom.hasClass("show")||(this.dom_bluredbg&&"undefined"!=typeof node&&node.win.capturePage(function(e){_p.tip.dom_bluredbg.css("background-image","url("+e+")")},"jpg","datauri"),this.dom.addClass("show")),this.position(e,i),void(this.is_showing=!0)):!1},position:function(e,t){var i=e.hashCode();this.curContent!=i&&(this.dom.css({top:"-1000px",left:"-1000px"}),this.dom_body.html(e),_p.initDOM(this.dom_body),this.curContent=i);var n=this["pos_"+t](this.dom.outerWidth(),this.dom.outerHeight());n&&this.move(n.x,n.y)},hide:function(e){return this.is_init&&this.is_showing?void(this.timeout_fade=setTimeout(function(){_p.tip.el=null,_p.tip.dom.removeClass("on"),_p.tip.is_showing=!1,_p.tip.curContent=null,_p.tip.timeout_fade=null},e?0:this.countdown_fade)):!1},content:function(e,t){return t=t||this.el,e},move:function(e,t){this.dom.css({top:t,left:e}).addClass("on")},get_indicator_size:function(){return this.size_indicator*_g.baseMultiper},pos_mouse:function(e,t){this.el.unbind("mousemove.tooltip").bind("mousemove.tooltip",function(i){var n=25,a=i.pageX+n,o=i.pageY+20,s=jQuery(window).innerWidth(),r=jQuery(window).innerHeight(),l=jQuery(window).scrollTop(),d=jQuery(window).scrollLeft();a+e+n>s+d&&(a=a-e-n-20),o+10+t>r+l&&(o=r+l-t-10),_p.tip.move(a,o)})},pos_bottom:function(e,t){var i=this.el,n=this.dom,a=i.offset(),o=a.left+(i.outerWidth()-n.outerWidth())/2,s=a.top+i.outerHeight()+this.get_indicator_size();return this.dom.attr("data-tip-indicator-pos","top"),this.checkpos(o,s,e,t)},pos_top:function(e,t){var i=this.el,n=this.dom,a=i.offset(),o=a.left+(i.outerWidth()-n.outerWidth())/2,s=a.top-t-this.get_indicator_size();return this.dom.attr("data-tip-indicator-pos","bottom"),this.checkpos(o,s,e,t)},pos_left:function(e,t){var i=this.el,n=this.dom,a=i.offset(),o=a.left-e-this.get_indicator_size(),s=a.top+(i.outerHeight()-n.outerHeight())/2;return this.dom.attr("data-tip-indicator-pos","right"),this.checkpos(o,s,e,t)},pos_right:function(e,t){var i=this.el,n=this.dom,a=i.offset(),o=a.left+i.outerWidth()+this.get_indicator_size(),s=a.top+(i.outerHeight()-n.outerHeight())/2;return this.dom.attr("data-tip-indicator-pos","left"),this.checkpos(o,s,e,t)},checkpos:function(e,t,i,n){var a=this.el,o=this.dom,s=a.offset(),r=e,l=t,d={x:r,y:l},u=$document.width()||$window.width();return e+i>u?d=i>s.left?{x:u-i-2,y:t}:this.pos_left(i,n):0>e&&(d=this.pos_right(i,n)),t+n>$(window).scrollTop()+$(window).height()?d=this.pos_top(i,n):t<$(window).scrollTop()&&(d=this.pos_bottom(i,n)),o.attr({"data-tip-indicator-offset-x":e-r+"px","data-tip-indicator-offset-y":t-l+"px"}),d},trigger_by_el:function(e){var t=e.data("tip");e.data("tip-filtered")||(this.filters.forEach(function(e){t=e(t)||t}),e.data({tip:t,"tip-filtered":!0})),this.show(t,e,e.data("tip-position"))}},_p.el.tip={init:function(){return _p.el.tip.isInit?!1:($body.on("mouseenter._tip","[data-tip]",function(){$body_preventMouseover||_p.tip.trigger_by_el($(this))}).on("mouseleave._tip","[data-tip]",function(){_p.tip.hide()}).on("click._tip","[data-tip]",function(){_p.tip.hide(!0)}).on("tipshow._tip","[data-tip]",function(){_p.tip.trigger_by_el($(this))}).on("tiphide._tip","[data-tip]",function(){_p.tip.hide()}),void(_p.el.tip.isInit=!0))}},_p.el.links={is_init:!1,click:function(e,t){e.attr("href");return e.hasClass("disabled")?(t&&(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation()),!1):void 0},init:function(e){_p.el.links.is_init||($body.on("click.link_delegate","a",function(e){var t=$(this),i=t.attr("target");return"undefined"!=typeof node&&(this.hostname!=window.location.hostname&&(i="_external"),"_external"==i||"_blank"==i)?(node.gui.Shell.openExternal(t.attr("href")),e.preventDefault(),!0):void _p.el.links.click(t,e)}),_p.el.links.is_init=!0)}},_p.el.form={init_el:function(e){return e.data("is_init_form_el")?!0:(e.find("textarea").on({"keyup.ctrl_enter_submit":function(t){var i=window.event?t.keyCode:t.which;switch(i=i.toString()){case"13":(t.metaKey||t.ctrlKey)&&e.submit()}}}),void e.data("is_init_form_el",!0))},init:function(e,t){e=e||$body,t=t||e.find("form"),t.each(function(){_p.el.form.init_el($(this))})}},_p.el.flexgrid={create:function(){var e=$('<div class="flexgrid"/>');return _p.el.flexgrid.init_el(e),e},init_el:function(e){if(e.data("is_init_flexgrid"))return!0;if(!e.data("append_before_this")){e.data("append_before_this",$('<div class="unit"/>').appendTo(e));for(var t=0;9>t;)$('<div class="unit"/>').appendTo(e),t++}e.data("is_init_flexgrid",!0)},init:function(e,t){e=e||$body,t=t||e.find(".flexgrid"),t.each(function(){_p.el.flexgrid.init_el($(this))})}},jQuery.fn.extend({appendDOM:function(e){return"function"==typeof e&&(e=e()),e&&e.insertBefore(this.data("append_before_this")),this}}),$document.ready(function(){$body=$("body");for(var e in _g.func_first)_g.func_first[e]();_g.init();for(var e in _g.func_last)_g.func_last[e]()}),_g.animate_duration_delay=320,_g.inputIndex=0,_g.lang="zh_cn",_g.joint="・",_g.defaultHqLv=90,_g.shipMaxLv=155,_g.isNWjs="undefined"!=typeof node||"undefined"!=typeof nw,_g.isWebApp=navigator.standalone||"web_app_manifest"==_g.uriSearch("utm_source"),_g.isClient=_g.isNWjs||_g.isWebApp,_g.updateDefaultHqLv=function(e){e=parseInt(e)||_g.defaultHqLv,0>=e&&(e=_g.defaultHqLv),e!=Lockr.get("hqLvDefault",_g.defaultHqLv)&&(Lockr.set("hqLvDefault",e),clearTimeout(_g.delay_updateDefaultHqLv),_g.delay_updateDefaultHqLv=setTimeout(function(){$body.trigger("update_defaultHqLv",[e]),clearTimeout(_g.delay_updateDefaultHqLv),_g.delay_updateDefaultHqLv=null},200))},_g.statSpeed={5:"低速",10:"高速"},_g.statRange={1:"短",2:"中",3:"长",4:"超长"},_g.textRank={1:"|",2:"||",3:"|||",4:"\\",5:"\\\\",6:"\\\\\\",7:"》"},_g.getStatSpeed=function(e){return _g.statSpeed[parseInt(e)]},_g.getStatRange=function(e){return _g.statRange[parseInt(e)]},_g.getSize=function(e,t){function i(e){return Math.floor(100*e)/100}return t=t.toUpperCase(),"B"==t[t.length-1]&&(t=t.substr(0,t.length-1)),e/=1024,"K"==t?i(e)+"KB":(e/=1024,"M"==t?i(e)+"MB":(e/=1024,"G"==t?i(e)+"GB":(e/=1024,"T"==t?i(e)+"TB":void 0)))};var _l={};String.prototype.printf=function(){return"undefined"!=typeof vsprintf?vsprintf(this,Array.prototype.slice.call(arguments)):this},_g.badge=function(e,t){switch("string"==typeof t&&(t=t.toLowerCase()),t){case"error":return _g.badgeError(e);default:return _g.badgeMsg(e)}},_g.badgeMsg=function(e){_frame.dom.layout.attr("data-msgbadge",e),clearTimeout(this.timeout_badgeMsg_hiding),this.timeout_badgeMsg_hiding=setTimeout(function(){_frame.dom.layout.removeAttr("data-msgbadge"),delete _g.timeout_badgeMsg_hiding},3e3)},_g.badgeError=function(e){_frame.dom.layout.attr("data-errorbadge",e),clearTimeout(this.timeout_badgeError_hiding),this.timeout_badgeError_hiding=setTimeout(function(){_frame.dom.layout.removeAttr("data-errorbadge"),delete _g.timeout_badgeError_hiding},3e3)},_g.pageChangeBefore=function(){_frame.dom.mobilemenu.prop("checked",!1)},_g.title=function(e){if(!e){var t=document.title.split(" - ");return 1==t.length?t[0]:(t.pop(),t.join(" - "))}return _frame.dom.title&&_frame.dom.title.text(e===!0?"是谁呼叫舰队":e),e},_g.index={ships:{},equipments:{}},_g.buildIndex=function(){function e(e,t){for(var i in e){var n="ships"==t?e[i].getSeriesData().map(function(e){return e.id}):[e[i].id];n.push&&0==n.length&&(n=[e[i].id]);for(var a in e[i].name)e[i].name[a]&&"suffix"!=a&&!function(){var o=e[i].name[a].toLowerCase();_g.index[t][o]||(_g.index[t][o]=[]),n.forEach(function(i){_g.index[t][o].some(function(e){return e.id==i})||_g.index[t][o].push(e[i])})}()}}e(_g.data.ships,"ships"),e(_g.data.items,"equipments")},_g.search=function(e,t){function i(e){n=n.concat(e.filter(function(e){return a.indexOf(t+e.id)>-1?!1:(a.push(t+e.id),!0)}))}t=_g.index[t];var n=[],a=[];if(!t||!e)return n;e=e.trim().toLowerCase(),t[e]&&i(t[e]);for(var o in t)e!==o&&o.indexOf(e)>-1&&i(t[o]);return n},_g.searchTest=function(e,t){var i=[];e=_g.search(e,t);for(var n in e)i.push(e[n]._name||e[n].name[_g.lang]);return i};var _ga={counter:function(e,t,i){return debugmode?!0:this.init_count?void("undefined"!=typeof ga&&ga("send","pageview",{location:location.href,page:location.pathname})):void(this.init_count=!0)}},_config={getFullKeyname:function(e){return"config_"+e},get:function(e){if(!localStorage)return!1;var t=localStorage[_config.getFullKeyname(e)];return"true"===t?!0:"undefined"===t?(delete localStorage[_config.getFullKeyname(e)],null):t},set:function(e,t){return localStorage?void(null===t&&localStorage[_config.getFullKeyname(e)]?delete localStorage[_config.getFullKeyname(e)]:localStorage[_config.getFullKeyname(e)]=t):!1}};if(_frame.app_config={init:function(){return _frame.app_config.is_init?!0:void(_frame.app_config.is_init=!0)}},"undefined"==typeof _g)var _g={};_g.lang=_g.lang||"zh_cn";var Formula={equipmentType:{SmallCaliber:1,SmallCaliberHigh:2,SmallCaliberAA:3,MediumCaliber:4,LargeCaliber:5,SuperCaliber:6,SecondaryGun:7,SecondaryGunHigh:8,SecondaryGunAA:9,APShell:11,Torpedo:12,SubmarineTorpedo:13,MidgetSubmarine:14,ReconSeaplane:15,ReconSeaplaneNight:16,SeaplaneBomber:17,CarrierFighter:18,TorpedoBomber:19,DiveBomber:20,CarrierRecon:21,Autogyro:22,AntiSubPatrol:23,SmallRadar:24,LargeRadar:25,DepthCharge:26,Sonar:27,LargeSonar:28,AAGun:29,AAGunConcentrated:30,Searchlight:39,LargeFlyingBoat:45,SearchlightLarge:46,SuparRadar:47,CarrierRecon2:50},shipType:{Carriers:[9,10,11],LightCruisers:[2,3,21,28],Submarines:[13,14]},calculate:function(e,t,i,n,a,o){if(!e||!t)return 0;_instanceof(t,Ship)||(t=_g.data.ships[t]);var s=0,r={main:0,secondary:0,torpedo:0,seaplane:0,apshell:0,radar:0},l=function(e){e=e||{};var a=0;return $.inArray(t.type,Formula.shipType.Carriers)>-1&&!e.isNight?e.returnZero?0:-1:(a=t.stat.torpedo_max||0,t.slot.map(function(t,o){if(i[o]&&(a+=i[o].type!=Formula.equipmentType.TorpedoBomber||e.isNight?i[o].stat.torpedo||0:0,n[o])){var s=0;$.inArray(i[o].type,Formula.equipmentType.Torpedos)>-1&&(s=e.isNight?1:1.2),$.inArray(i[o].type,Formula.equipmentType.AAGuns)>-1&&(s=e.isNight?1:1.2),a+=Math.sqrt(n[o])*s}}),a)},d=0;switch(i=i.map(function(e){return e?_instanceof(e,Equipment)?e:_g.data.items[e]:null})||[],n=n||[],a=a||[],o=o||{},i.forEach(function(e){e&&($.inArray(e.type,Formula.equipmentType.MainGuns)>-1?r.main+=1:$.inArray(e.type,Formula.equipmentType.SecondaryGuns)>-1?r.secondary+=1:$.inArray(e.type,Formula.equipmentType.Torpedos)>-1?r.torpedo+=1:$.inArray(e.type,Formula.equipmentType.Seaplanes)>-1?r.seaplane+=1:e.type==Formula.equipmentType.APShell?r.apshell+=1:$.inArray(e.type,Formula.equipmentType.Radars)>-1&&(r.radar+=1))}),e){case"fighterPower":return d=0,t.slot.map(function(e,t){if(i[t]&&$.inArray(i[t].type,Formula.equipmentType.Fighters)>-1&&e){if(d=Math.sqrt(e)*(i[t].stat.aa||0),i[t].type==Formula.equipmentType.CarrierFighter)switch(a[t]){case 1:case"1":d+=1;break;case 2:case"2":d+=4;break;case 3:case"3":d+=6;break;case 4:case"4":d+=11;break;case 5:case"5":d+=16;break;case 6:case"6":d+=17;break;case 7:case"7":d+=25}else if(-1==$.inArray(i[t].type,Formula.equipmentType.Recons)){var n=i[t].type==Formula.equipmentType.SeaplaneBomber?9:3;d+=1==a[t]?1:n/6*(a[t]-1)}s+=Math.floor(d)}}),s;case"fighterPower_v2":return Formula.calcByShip.fighterPower_v2(t,i,n,a);case"shelling":case"shellingDamage":return $.inArray(t.type,Formula.shipType.Submarines)>-1?"-":(s=Formula.calcByShip.shellingPower(t,i,n,a),s&&s>-1?Math.floor(s):"-");case"torpedo":case"torpedoDamage":return s=l(),s&&s>-1?Math.floor(s):"-";case"nightBattle":return!t.additional_night_shelling&&$.inArray(t.type,Formula.shipType.Carriers)>-1?"-":(s=Formula.calcByShip.shellingPower(t,i,n,a,{isNight:!0})+l({isNight:!0,returnZero:!0}),r.torpedo>=2?"雷击CI "+Math.floor(1.5*s)+" x 2":r.main>=3?"炮击CI "+Math.floor(2*s):2==r.main&&r.secondary>=1?"炮击CI "+Math.floor(1.75*s):r.main>=1&&1==r.torpedo?"炮雷CI "+Math.floor(1.3*s)+" x 2":2==r.main&&r.secondary<=0&&r.torpedo<=0||1==r.main&&r.secondary>=1&&r.torpedo<=0||0==r.main&&r.secondary>=2&&r.torpedo>=0?"连击 "+Math.floor(1.2*s)+" x 2":"通常 "+Math.floor(s));case"addHit":return t.slot.map(function(e,t){i[t]&&(s+=i[t].stat.hit||0)}),s>=0?"+"+s:s;case"addArmor":return t.slot.map(function(e,t){i[t]&&(s+=i[t].stat.armor||0)}),s;case"addEvasion":return t.slot.map(function(e,t){i[t]&&(s+=i[t].stat.evasion||0)}),s;case"losPower":return Formula.calcByShip.losPower(t,i,n,a,o)}return"-"},calcByShip:{},calc:{}};Formula.equipmentType.MainGuns=[Formula.equipmentType.SmallCaliber,Formula.equipmentType.SmallCaliberHigh,Formula.equipmentType.SmallCaliberAA,Formula.equipmentType.MediumCaliber,Formula.equipmentType.LargeCaliber,Formula.equipmentType.SuperCaliber],Formula.equipmentType.LargeCalibers=[Formula.equipmentType.LargeCaliber,Formula.equipmentType.SuperCaliber],Formula.equipmentType.SecondaryGuns=[Formula.equipmentType.SecondaryGun,Formula.equipmentType.SecondaryGunHigh,Formula.equipmentType.SecondaryGunAA],Formula.equipmentType.Torpedos=[Formula.equipmentType.Torpedo,Formula.equipmentType.SubmarineTorpedo],Formula.equipmentType.Seaplanes=[Formula.equipmentType.ReconSeaplane,Formula.equipmentType.ReconSeaplaneNight,Formula.equipmentType.SeaplaneBomber],Formula.equipmentType.Fighters=[Formula.equipmentType.SeaplaneBomber,Formula.equipmentType.CarrierFighter,Formula.equipmentType.TorpedoBomber,Formula.equipmentType.DiveBomber],Formula.equipmentType.Recons=[Formula.equipmentType.ReconSeaplane,Formula.equipmentType.ReconSeaplaneNight,Formula.equipmentType.CarrierRecon,Formula.equipmentType.CarrierRecon2,Formula.equipmentType.LargeFlyingBoat],Formula.equipmentType.SeaplaneRecons=[Formula.equipmentType.ReconSeaplane,Formula.equipmentType.ReconSeaplaneNight,Formula.equipmentType.LargeFlyingBoat],Formula.equipmentType.SeaplaneBombers=[Formula.equipmentType.SeaplaneBomber],Formula.equipmentType.CarrierRecons=[Formula.equipmentType.CarrierRecon,Formula.equipmentType.CarrierRecon2],Formula.equipmentType.CarrierBased=[Formula.equipmentType.CarrierFighter,Formula.equipmentType.TorpedoBomber,Formula.equipmentType.DiveBomber,Formula.equipmentType.CarrierRecon,Formula.equipmentType.CarrierRecon2],Formula.equipmentType.TorpedoBombers=[Formula.equipmentType.TorpedoBomber],Formula.equipmentType.DiveBombers=[Formula.equipmentType.DiveBomber],Formula.equipmentType.Autogyros=[Formula.equipmentType.Autogyro],Formula.equipmentType.AntiSubPatrols=[Formula.equipmentType.AntiSubPatrol],Formula.equipmentType.Aircrafts=[],[].concat(Formula.equipmentType.Seaplanes).concat(Formula.equipmentType.Recons).concat(Formula.equipmentType.CarrierBased).concat(Formula.equipmentType.Autogyros).concat(Formula.equipmentType.AntiSubPatrols).forEach(function(e){Formula.equipmentType.Aircrafts.indexOf(e)<0&&Formula.equipmentType.Aircrafts.push(e)}),Formula.equipmentType.Radars=[Formula.equipmentType.SmallRadar,Formula.equipmentType.LargeRadar,Formula.equipmentType.SuparRadar],Formula.equipmentType.SmallRadars=[Formula.equipmentType.SmallRadar],Formula.equipmentType.LargeRadars=[Formula.equipmentType.LargeRadar,Formula.equipmentType.SuparRadar],Formula.equipmentType.AntiSubmarines=[Formula.equipmentType.DepthCharge,Formula.equipmentType.Sonar,Formula.equipmentType.LargeSonar],Formula.equipmentType.AAGuns=[Formula.equipmentType.AAGun,Formula.equipmentType.AAGunConcentrated],Formula.equipmentType.Searchlights=[Formula.equipmentType.Searchlight,Formula.equipmentType.SearchlightLarge],Formula.shellingDamage=function(e,t,i,n){return this.calculate("shellingDamage",e,t,i,n)},Formula.torpedoDamage=function(e,t,i,n){return this.calculate("torpedoDamage",e,t,i,n)},Formula.fighterPower=function(e,t,i,n){return this.calculate("fighterPower",e,t,i,n)},Formula.fighterPower_v2=function(e,t,i,n){return this.calculate("fighterPower_v2",e,t,i,n)},Formula.nightBattle=function(e,t,i,n){return this.calculate("nightBattle",e,t,i,n)},Formula.addHit=function(e,t,i,n){return this.calculate("addHit",e,t,i,n)},Formula.addArmor=function(e,t,i,n){return this.calculate("addArmor",e,t,i,n)},Formula.addEvasion=function(e,t,i,n){return this.calculate("addEvasion",e,t,i,n)},Formula.losPower=function(e,t,i,n,a){return this.calculate("losPower",e,t,i,n,a)},Formula.calc.losPower=function(e){var t=function(e){e=$.extend({"(Intercept)":1},e),e.hqLv=5*Math.ceil(e.hqLv/5);var t={},s=0;$.each(i,function(){var i=e[this]*n[this];t[this]=i,s+=i});var r={};$.each(i,function(){r[this]=e[this]*a[this]});var l=0;return $.each(i,function(){var e=this;$.each(i,function(){var t=this;l+=r[e]*r[t]*o[e][t]})}),{x_estimate:t,y_estimate:s,x_std_error:r,y_std_error:l}},i=["(Intercept)","DiveBombers","TorpedoBombers","CarrierRecons","SeaplaneRecons","SeaplaneBombers","SmallRadars","LargeRadars","Searchlights","statLos","hqLv"],n={"(Intercept)":0,DiveBombers:1.03745043134563,TorpedoBombers:1.3679056374142,CarrierRecons:1.65940512636315,SeaplaneRecons:2,SeaplaneBombers:1.77886368594467,SmallRadars:1.0045778494921,LargeRadars:.990738063979571,Searchlights:.906965144360512,statLos:1.6841895400986,hqLv:-.614246711531445},a={"(Intercept)":4.66445565766347,DiveBombers:.0965028505325845,TorpedoBombers:.108636184978525,CarrierRecons:.0976055279516298,SeaplaneRecons:.0866229392463539,SeaplaneBombers:.0917722496848294,SmallRadars:.0492773648320346,LargeRadars:.0491221486053861,Searchlights:.0658283797225724,statLos:.0781594211213618,hqLv:.0369222352426548},o={"(Intercept)":{"(Intercept)":1,DiveBombers:-.147020064768061,TorpedoBombers:-.379236131621529,CarrierRecons:-.572858669501918,SeaplaneRecons:-.733913857017495,SeaplaneBombers:-.642621825152428,SmallRadars:-.674829588068364,LargeRadars:-.707418111752863,Searchlights:-.502304601556193,statLos:-.737374218573832,hqLv:-.05071933950163},DiveBombers:{"(Intercept)":-.147020064768061,DiveBombers:1,TorpedoBombers:.288506347076736,CarrierRecons:.365820372770994,SeaplaneRecons:.425744409856409,SeaplaneBombers:.417783698791503,SmallRadars:.409046013184429,LargeRadars:.413855653833994,Searchlights:.308730607324667,statLos:.317984916914851,hqLv:-.386740224500626},TorpedoBombers:{"(Intercept)":-.379236131621529,DiveBombers:.288506347076736,TorpedoBombers:1,CarrierRecons:.482215071254241,SeaplaneRecons:.584455876852325,SeaplaneBombers:.558515133495825,SmallRadars:.547260012897553,LargeRadars:.560437619378443,Searchlights:.437934879351188,statLos:.533934507932748,hqLv:-.405349979885748},CarrierRecons:{"(Intercept)":-.572858669501918,DiveBombers:.365820372770994,TorpedoBombers:.482215071254241,CarrierRecons:1,SeaplaneRecons:.804494553748065,SeaplaneBombers:.75671307047535,SmallRadars:.748420581669228,LargeRadars:.767980338133817,Searchlights:.589651513349878,statLos:.743851348255527,hqLv:-.503544281376776},SeaplaneRecons:{"(Intercept)":-.733913857017495,DiveBombers:.425744409856409,TorpedoBombers:.584455876852325,CarrierRecons:.804494553748065,SeaplaneRecons:1,SeaplaneBombers:.932444440578382,SmallRadars:.923988080549326,LargeRadars:.94904944359066,Searchlights:.727912987329348,statLos:.944434077970518,hqLv:-.614921413821462},SeaplaneBombers:{"(Intercept)":-.642621825152428,DiveBombers:.417783698791503,TorpedoBombers:.558515133495825,CarrierRecons:.75671307047535,SeaplaneRecons:.932444440578382,SeaplaneBombers:1,SmallRadars:.864289865445084,LargeRadars:.886872388674911,Searchlights:.68310647756898,statLos:.88122333327317,hqLv:-.624797255805045},SmallRadars:{"(Intercept)":-.674829588068364,DiveBombers:.409046013184429,TorpedoBombers:.547260012897553,CarrierRecons:.748420581669228,SeaplaneRecons:.923988080549326,SeaplaneBombers:.864289865445084,SmallRadars:1,LargeRadars:.872011318623459,Searchlights:.671926570242336,statLos:.857213501657084,hqLv:-.560018086758868},LargeRadars:{"(Intercept)":-.707418111752863,DiveBombers:.413855653833994,TorpedoBombers:.560437619378443,CarrierRecons:.767980338133817,SeaplaneRecons:.94904944359066,SeaplaneBombers:.886872388674911,SmallRadars:.872011318623459,LargeRadars:1,Searchlights:.690102027588321,statLos:.883771367337743,hqLv:-.561336967269448},Searchlights:{"(Intercept)":-.502304601556193,DiveBombers:.308730607324667,TorpedoBombers:.437934879351188,CarrierRecons:.589651513349878,SeaplaneRecons:.727912987329348,SeaplaneBombers:.68310647756898,SmallRadars:.671926570242336,LargeRadars:.690102027588321,Searchlights:1,statLos:.723228553177704,hqLv:-.518427865593732},statLos:{"(Intercept)":-.737374218573832,DiveBombers:.317984916914851,TorpedoBombers:.533934507932748,CarrierRecons:.743851348255527,SeaplaneRecons:.944434077970518,SeaplaneBombers:.88122333327317,SmallRadars:.857213501657084,LargeRadars:.883771367337743,Searchlights:.723228553177704,statLos:1,hqLv:-.620804120587684},hqLv:{"(Intercept)":-.05071933950163,DiveBombers:-.386740224500626,TorpedoBombers:-.405349979885748,CarrierRecons:-.503544281376776,SeaplaneRecons:-.614921413821462,SeaplaneBombers:-.624797255805045,SmallRadars:-.560018086758868,LargeRadars:-.561336967269448,Searchlights:-.518427865593732,statLos:-.620804120587684,hqLv:1}},s={DiveBombers:0,TorpedoBombers:0,CarrierRecons:0,SeaplaneRecons:0,SeaplaneBombers:0,SmallRadars:0,LargeRadars:0,Searchlights:0,statLos:1,hqLv:1};for(var r in e)s[r]=e[r];return t(s)},Formula.calcByShip.shellingPower=function(e,t,i,n,a){a=a||{};var o=0,s=!1;if($.inArray(e.type,Formula.shipType.Carriers)>-1?s=!0:t.some(function(e){return e&&!s&&$.inArray(e.type,Formula.equipmentType.CarrierBased)>-1?(s=!0,!0):void 0}),s&&!a.isNight){var r=0,l=0;return e.slot.map(function(e,n){t[n]&&(o+=1.5*t[n].stat.fire||0,t[n].type==Formula.equipmentType.TorpedoBomber&&(r+=t[n].stat.torpedo||0),l+=t[n].stat.bomb||0,$.inArray(t[n].type,Formula.equipmentType.SecondaryGuns)>-1&&(o+=Math.sqrt(1.5*(i[n]||0))))}),r||l?o+=Math.floor(1.5*(Math.floor(1.3*l)+r+e.stat.fire_max))+50:-1}o=e.stat.fire_max||0;var d=0,u=0;return e.slot.map(function(n,s){if(t[s]&&(o+=t[s].stat.fire||0,$.inArray(e.type,Formula.shipType.LightCruisers)>-1&&(4==t[s].id&&(d+=1),(119==t[s].id||65==t[s].id||139==t[s].id)&&(u+=1)),i[s]&&$.inArray(t[s].type,Formula.equipmentType.Torpedos.concat(Formula.equipmentType.Radars))<0)){var r=1;$.inArray(t[s].type,Formula.equipmentType.AntiSubmarines)>-1&&(r=a.isNight?0:.75),$.inArray(t[s].type,Formula.equipmentType.LargeCalibers)>-1&&(r=a.isNight?1:1.5),o+=Math.sqrt(i[s])*r}}),o+2*Math.sqrt(u)+Math.sqrt(d)},Formula.calcByShip.fighterPower_v2=function(e,t,i,n){var a=[],o={},s=[0,0];return a[0]=[0,9],a[1]=[10,24],a[2]=[25,39],a[3]=[40,54],a[4]=[55,69],a[5]=[70,84],a[6]=[85,99],a[7]=[100,120],o.CarrierFighter=[0,0,2,5,9,14,14,22],o.SeaplaneBomber=[0,0,1,1,1,3,3,6],e.slot.map(function(e,i){if(t[i]&&$.inArray(t[i].type,Formula.equipmentType.Fighters)>-1&&e){var r=Math.sqrt(e)*(t[i].stat.aa||0),l=n[i]||0,d=a[l],u=0;t[i].type==Formula.equipmentType.CarrierFighter&&(u=o.CarrierFighter[l]),t[i].type==Formula.equipmentType.SeaplaneBomber&&(u=o.SeaplaneBomber[l]),s[0]+=Math.floor(r+Math.sqrt(d[0]/10)+u),s[1]+=Math.floor(r+Math.sqrt(d[1]/10)+u)}}),s},Formula.calcByShip.losPower=function(e,t,i,n,a){a=a||{},a.shipLv=a.shipLv||1,a.hqLv=a.hqLv||1,a.shipLv<0&&(a.shipLv=1),a.hqLv<0&&(a.hqLv=1);var o={DiveBombers:0,TorpedoBombers:0,CarrierRecons:0,SeaplaneRecons:0,SeaplaneBombers:0,SmallRadars:0,LargeRadars:0,Searchlights:0,statLos:Math.sqrt(e.getAttribute("los",a.shipLv)),hqLv:a.hqLv};return t.forEach(function(e){if(e)for(var t in o)Formula.equipmentType[t]&&Formula.equipmentType[t].push&&Formula.equipmentType[t].indexOf(e.type)>-1&&(o[t]+=e.stat.los)}),Formula.calc.losPower(o)};var ItemBase=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"getName",value:function(e){return e=e||_g.lang,this.name?this.name[e]||this.name:null}},{key:"_name",get:function(){return this.getName()}}]),e}(),Entity=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return $.extend(!0,i,e),i}return _inherits(t,e),t}(ItemBase),Equipment=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return $.extend(!0,i,e),i}return _inherits(t,e),_createClass(t,[{key:"getName",value:function(e,t){t=t||_g.lang;var i=ItemBase.prototype.getName.call(this,t),n=e&&!e==!0?e:"small";return e?i.replace(/（([^（^）]+)）/g,"<"+n+">($1)</"+n+">"):i}},{key:"getType",value:function(e){return e=e||_g.lang,this.type?_g.data.item_types[this.type].name[e]:null}
},{key:"getIconId",value:function(){return _g.data.item_types[this.type].icon}},{key:"getCaliber",value:function(){var e=this.getName(!1,"ja_jp"),t=parseFloat(e);return t}},{key:"getPower",value:function(){return this.stat[_g.data.item_types[this.type].main_attribute||"fire"]}},{key:"_icon",get:function(){return"/!/assets/images/itemicon/"+this.getIconId()+".png"}}]),t}(ItemBase),Ship=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return $.extend(!0,i,e),i}return _inherits(t,e),_createClass(t,[{key:"getName",value:function(e,t){e=e||"",t=t||_g.lang;var i=this.getSuffix(t);return(this.name[t]||this.name.ja_jp)+(i?(e===!0?_g.joint:e)+i:"")}},{key:"getNameNoSuffix",value:function(e){return e=e||_g.lang,this.name[e]||this.name.ja_jp}},{key:"getSuffix",value:function(e){return e=e||_g.lang,this.name.suffix?_g.data.ship_namesuffix[this.name.suffix][e]||_g.data.ship_namesuffix[this.name.suffix].ja_jp||"":""}},{key:"getType",value:function(e){return e=e||_g.lang,this.type?_g.data.ship_types[this.type].full_zh:null}},{key:"getSeriesData",value:function(){return this.series?_g.data.ship_series[this.series].ships:[{id:this.id}]}},{key:"getPic",value:function(e){var t=this.getSeriesData();e=parseInt(e||0);for(var i=function(e,t){return"undefined"!=typeof node&&node&&node.path&&_g.path.pics.ships?node.path.join(_g.path.pics.ships,e+"/"+t+".png"):_g.path.pics.ships?_g.path.pics.ships+e+"/"+t+".png":"/"+e+"/"+t+".png"},n=0;n<t.length;n++)if(t[n].id==this.id){switch(e){case 0:case 1:case 2:case 3:case 12:case 13:case 14:return i(this.id,e);default:return t[n].illust_delete?i(t[n-1].id,e):i(this.id,e)}break}}},{key:"getSpeed",value:function(e){return e=e||_g.lang,_g.statSpeed[parseInt(this.stat.speed)]}},{key:"getRange",value:function(e){return e=e||_g.lang,_g.statRange[parseInt(this.stat.range)]}},{key:"getEquipmentTypes",value:function(){return _g.data.ship_types[this.type].equipable.concat(this.additional_item_types||[]).sort(function(e,t){return e-t})}},{key:"getAttribute",value:function(e,i){i=i||1,i>t.lvlMax&&(i=t.lvlMax);var n=function(e,t,i){return e=e||1,t=parseFloat(t),i=parseFloat(i)||t,0>t||0>i?-1:t==i?i:Math.floor(t+(i-t)*e/99)},a=void 0;switch(e){case"hp":return a=this.stat.hp,i>99&&(a=this.stat.hp>=90?this.stat.hp+9:this.stat.hp>=70?this.stat.hp+8:this.stat.hp>=50?this.stat.hp+7:this.stat.hp>=40?this.stat.hp+6:this.stat.hp>=30?this.stat.hp+5:this.stat.hp+4,a>this.stat.hp_max&&(a=this.stat.hp_max)),a;case"speed":return _g.getStatSpeed(this.stat.speed);case"range":return _g.getStatRange(this.stat.range);case"luck":return i>99?this.stat.luck+3:this.stat.luck;case"fuel":case"ammo":return i>99?Math.floor(.85*this.consum[e]):this.consum[e];case"aa":case"armor":case"fire":case"torpedo":return this.stat[e+"_max"]||this.stat[e];default:return n(i,this.stat[e],this.stat[e+"_max"])}}},{key:"getRel",value:function(e){if(e){if(!this.rels[e]&&this.remodel&&this.remodel.prev)for(var t=_g.data.ships[this.remodel.prev];t;){if(t.rels&&t.rels[e])return t.rels[e];t=t.remodel&&t.remodel.prev?_g.data.ships[t.remodel.prev]:null}return this.rels[e]}return this.rels}},{key:"getCV",value:function(e){var t=this.getRel("cv");return t?_g.data.entities[t].getName(e||_g.lang):void 0}},{key:"getIllustrator",value:function(e){var t=this.getRel("illustrator");return t?_g.data.entities[t].getName(e||_g.lang):void 0}},{key:"_type",get:function(){return this.getType()}},{key:"_pics",get:function(){for(var e=[],t=0;15>t;t++)e.push(this.getPic(t));return e}},{key:"_speed",get:function(){return this.getSpeed()}},{key:"_range",get:function(){return this.getRange()}},{key:"_cv",get:function(){return this.getCV()}},{key:"_illustrator",get:function(){return this.getIllustrator()}}]),t}(ItemBase);Ship.lvlMax=155,_g.kancolle_calc={version:3,decode:function(e,t){if(e&&("string"==typeof e&&(e=JSON.parse(e)),"object"==("undefined"==typeof e?"undefined":_typeof(e)))){t=parseInt(e.version)||this.version;var i=void 0,n=0,a=0,o=0,s=void 0,r=void 0,l=void 0,d=4,u=6,c=5;switch(t){case 3:for(i=[],n=0;d>n;){if(s=e["f"+(n+1)],i[n]=[],s)for(a=0;u>a;){if(r=s["s"+(a+1)],r&&r.id){if(i[n][a]=[r.id,[r.lv||null,r.luck||-1],[],[],[]],r.items)for(o=0;c>o;)l=r.items["i"+(o+1)],l&&l.id?(i[n][a][2][o]=l.id,i[n][a][3][o]=l.rf||null,i[n][a][4][o]=l.rp||null):(i[n][a][2][o]=null,i[n][a][3][o]=null,i[n][a][4][o]=null),o++}else i[n][a]=null;a++}n++}}return i}},encode:function(e,t){if(e&&(e.length&&e.push||(e=JSON.parse(e)),e.length&&e.push)){t=parseInt(t)||this.version;var i=void 0;switch(t){case 3:i={version:3},e.forEach(function(e,t){e&&(i["f"+(t+1)]={},e.forEach(function(e,n){e&&e[0]&&(i["f"+(t+1)]["s"+(n+1)]={id:parseInt(e[0]),lv:parseInt(e[1][0])||null,luck:parseInt(e[1][1])||-1,items:{ix:{}}},e[2].forEach(function(a,o){a&&(i["f"+(t+1)]["s"+(n+1)].items["i"+(o+1)]={id:parseInt(a)},e[3]&&(i["f"+(t+1)]["s"+(n+1)].items["i"+(o+1)].rf=parseInt(e[3][o])||0),e[4]&&(i["f"+(t+1)]["s"+(n+1)].items["i"+(o+1)].rp=parseInt(e[4][o])||0))}))}))})}return i}}},_g.db_version="1.9.0.0",_g.bgimg_count=26,_g.event={animationend:"animationend webkitAnimationEnd",animationiteration:"animationiteration webkitAnimationIteration",transitionend:"transitionend webkitTransitionEnd mozTransitionEnd"},_g.path={db:"/!/db/",bgimg_dir:"/!/assets/images/homebg/",pics:{ships:"/!/pics/ships/",items:"/!/pics/items/"}},_g.dbs=["ships","ship_types","ship_series","ship_namesuffix","items","item_types"],_g.data={};var _db={fleets:new Nedb({filename:"fleets"})};Nedb.prototype.updateById=function(e,t,i){this._updateByIdQueue||(this._updateByIdQueue={},Object.defineProperty(this._updateByIdQueue,"running",{enumerable:!1,value:!1,writable:!0})),t=t||{},t._id=e,this._updateByIdQueue[e]={docReplace:t,callback:i||function(){}},this._updateById()},Nedb.prototype._updateById=function(){if(!this._updateByIdQueue||this._updateByIdQueue.running)return!1;var e=void 0;for(var t in this._updateByIdQueue)if(this._updateByIdQueue[t]){e=t;break}if(!e)return!1;var i=this._updateByIdQueue[e];this._updateByIdQueue[e]=null,delete this._updateByIdQueue[e],this._updateByIdQueue.running=!0,this.update({_id:e},i.docReplace,{},function(e,t){i.callback.call(this,e,t),this._updateByIdQueue.running=!1,this._updateById()}.bind(this))},_g.log=function(){console.log.apply(console,arguments)},_g.parseURI=function(e){e=e||location.pathname;var t=e.split("/").filter(function(e){return e});if(!t.length)return{page:"home"};if(1==t.length)return{page:t[0]};if(2==t.length){var i=t[0];switch(i){case"ships":i="ship";break;case"equipments":i="equipment";break;case"entities":i="entity";break;case"fleets":i="fleet",t[1]=_g.uriSearch("i")||"__NEW__"}return{infos:i,id:t[1]}}},_g.state2URI=function(e){if(!e||"home"==e.page)return"/";if(e.page)return"/"+e.page+"/";if(e.infos){var t=e.infos,i="";switch(t){case"ship":t="ships";break;case"equipment":t="equipments";break;case"entity":t="entities";break;case"fleet":t="fleets",i="?i="+e.id,e.id="build"}return"/"+t+"/"+e.id+"/"+i}},_g.save=function(e,t){_g.save_||(_g.save_=document.createElement("a")),_g.save_.href=e,"undefined"!=typeof _g.save_.download?_g.save_.download=t:_g.save_.target="_blank",_g.save_.click()},_g.getScriptCanvas=function(){var e=Q.defer();return $.getScript("/!/assets/lib.canvas.min.js",function(){e.resolve()}),e.promise},_frame.app_main={page:{},page_dom:{},page_html:{},page_title:{},loading:["dbs","bgimgs"],functions_on_ready:[],loaded:function(e,t){_g.log(e+" loaded."),e&&this.loading.indexOf(e)>-1&&(this.loading.splice(this.loading.indexOf(e),1),this.is_loaded=!1),this.loading.length||this.is_loaded||(setTimeout(function(){!_frame.app_main.is_loaded||_frame.app_main.loading.length||$html.hasClass("app-ready")||(_frame.dom.layout.addClass("ready"),$html.addClass("app-ready"),setTimeout(function(){for(var e=0;_frame.app_main.functions_on_ready[e];)_frame.app_main.functions_on_ready[e++]()},1500))},t?300:1e3),this.window_event_bound||($window.on("popstate._global",function(e){e.originalEvent&&e.originalEvent.state?_frame.app_main.state(e.originalEvent.state):_frame.app_main.state(_g.parseURI())}).trigger("popstate._global"),this.window_event_bound=!0),this.is_loaded=!0)},pushState:function(e,t,i){history.pushState(e,t,i),console.log(e)},state:function(e){e.infos?_frame.infos.show_func(e.infos,e.id,null,e.infosHistoryIndex):_frame.infos.hide(),e.page&&this.load_page_func(e.page)},loading_queue:[],loading_state:{},loading_start:function(e,t,i,n,a,o){e=e||location.pathname;var s=!0;"object"==("undefined"==typeof t?"undefined":_typeof(t))?(s="undefined"!=typeof t.isUrl?t.isUrl:!0,i=t.error,n=t.successAfter,a=t.beforeSend,o=t.complete,t=t.success):t===!1&&(s=!1),a=a||function(){},t=t||function(){},n=n||function(){},i=i||function(){},o=o||function(){},this.loading_cur=e,"undefined"==typeof this.loading_state[e]||"fail"==this.loading_state[e]?("fail"!=this.loading_state[e]&&(this.loading_state[e]="loading"),this.loading_queue.push(e),_frame.dom.layout.addClass("is-loading"),s&&$.ajax({url:e,type:"get",dataType:"html",beforeSend:function(t,i){a(e,t,i)},success:function(i){var a=/\<main\>(.+)\<\/main\>/.exec(i),o=/\<title\>([^\<]+)\<\/title\>/.exec(i);o&&o.length>1&&(_frame.app_main.page_title[e]=o[1]),t(a&&a.length>1?a[1]:""),e==_frame.app_main.loading_cur&&n(a&&a.length>1?a[1]:""),_frame.app_main.loading_state[e]="complete"},error:function(t,n,a){return a=a||"",_g.log("Loading Fail: "+e+" ["+n+"] ("+a+")"),"fail"==_frame.app_main.loading_state[e]||["Bad Request","Not Found","Forbidden"].indexOf(a)>-1?_frame.app_main.loading_fail(e,n,a,i):void(_frame.app_main.loading_state[e]="fail")},complete:function(s,r){_frame.app_main.loading_complete(e),o(e,s,r),"fail"==_frame.app_main.loading_state[e]&&(console.log("retry"),_frame.app_main.loading_start(e,t,i,n,a,o))}})):"complete"==this.loading_state[e]&&(t(),n())},loading_complete:function(e){if(e){e==this.loading_cur&&(this.loading_cur=null);var t=this.loading_queue.indexOf(e);t>=0&&this.loading_queue.splice(t,1),this.loading_queue.length||_frame.dom.layout.removeClass("is-loading")}},loading_fail:function(e,t,i,n){return e?(this.loading_state&&delete this.loading_state[e],_frame.dom.layout.attr("data-errorbadge",e+" 载入失败 ("+i+")"),clearTimeout(this.loading_fail_timeout_errorbadge),this.loading_fail_timeout_errorbadge=setTimeout(function(){_frame.dom.layout.removeAttr("data-errorbadge"),delete _frame.app_main.loading_fail_timeout_errorbadge},3e3),console.log(n),n(e,t,i)):void 0},load_page:function(e,t){return this.cur_page!=e&&e?(t=t||{},this.pushState({page:e},null,_g.state2URI({page:e})),void this.load_page_func(e,t)):e},load_page_func:function(e,t){function i(){return _frame.infos.hide(),t.callback_modeSelection_select||(document.title=_frame.app_main.page_title[a],_g.title(_frame.app_main.navtitle[e]||!0),_ga.counter(location.search)),_frame.app_main.cur_page==e?e:(Page.show(e),t.callback_modeSelection_select||"about"!=e&&Lockr.set("last_page",e),_g.log("LOADED: "+e),void(t.callback_modeSelection_select?_frame.app_main.page_dom[e].trigger("modeSelectionEnter",[t.callback_modeSelection_select||function(){},t.callback_modeSelection_enter||function(){}]):_frame.app_main.mode_selection_off()))}if(_g.pageChangeBefore(),_g.log("PREPARE LOADING: "+e),t=t||{},!e)return e;var n=!1;if("donate"==e&&(n=!0),this.cur_page?n=!0:this.nav.forEach(function(t){e==t.page&&(n=!0)}),!n)return e=this.nav[0].page,this.load_page(e,t),e;var a=_g.state2URI({page:e});this.page_dom[e]?i():(this.page_dom[e]=_frame.dom.main.find('.page-container[page="'+e+'"]'),this.page_dom[e].length?(Page.init(e),this.page_title[a]=document.title,i()):this.loading_start(a,{success:function(t){t&&(_frame.app_main.page_dom[e]=$(t).appendTo(_frame.dom.main),a!=location.pathname&&_frame.app_main.page_dom[e].addClass("off"),Page.init(e))},successAfter:i,error:function(){delete _frame.app_main.page_dom[e],history.back()}}))},init:function(){if(this.is_init)return!0;_frame.dom.mobilemenu=_frame.dom.layout.children("#view-mobile-menu"),_frame.dom.logo=$('<div class="logo"/>').on(_g.event.animationend,function(){_frame.dom.logo.addClass("ready-animated")}).appendTo(_frame.dom.layout),_frame.dom.nav=_frame.dom.layout.children("nav"),_frame.dom.navlinks=_frame.dom.nav.children(".pages"),_frame.dom.globaloptions=_frame.dom.nav.children("section.options").append($('<button class="show_only_bg" icon="images"/>').on("click",function(){BgImg.controlsToggle()})),_g.isClient&&(_frame.dom.btnsHistory=$('<div class="history"/>').insertBefore(_frame.dom.navlinks),_frame.dom.btnHistoryBack=$('<button class="button back" icon="arrow-set2-left"/>').on({click:function(){_frame.dom.btnHistoryForward.removeClass("disabled"),history.back()}}).appendTo(_frame.dom.btnsHistory),_frame.dom.btnHistoryForward=$('<button class="button forward disabled" icon="arrow-set2-right"/>').on("click",function(){history.forward()}).appendTo(_frame.dom.btnsHistory)),_frame.dom.main=_frame.dom.layout.children("main"),_frame.dom.title=_frame.dom.nav.children(".title").children("span"),$('<div class="nav-mask"/>').appendTo(_frame.dom.layout).on("click",function(){_frame.dom.mobilemenu.prop("checked",!1)});var e=Q.fcall(function(){});this.nav=[],this.navtitle={},e.then(function(){return _frame.dom.navs={},_frame.dom.navlinks.find("a").each(function(e,t){t=$(t);var i=_g.parseURI(t.attr("href")).page,n=t.text();_frame.app_main.nav.push({title:n,state:t.attr("mod-state"),page:i}),_frame.app_main.navtitle[i]=n,t.hasClass("button")||(t=t.parent()),_frame.dom.navs[i]=t.on("click",function(){Page.resetScroll(i)})}),_frame.app_main.nav}).then(BgImg.init).then(function(){_g.log("Preload All DBs (JSON ver.): START");var e=Q(),t=Q.defer();return _g.dbs.forEach(function(t){e=e.then(function(){var e=Q.defer();return $.ajax({url:"/!/db/"+t+".json?v="+_g.db_version,dataType:"text",success:function(e){e=LZString.decompressFromBase64(e);var i=e.split("\n");switch(t){default:"undefined"==typeof _g.data[t]&&(_g.data[t]={}),i.forEach(function(e){if(e){var i=JSON.parse(e);switch(t){case"ships":_g.data[t][i.id]=new Ship(i);break;case"items":_g.data[t][i.id]=new Equipment(i);break;case"entities":_g.data[t][i.id]=new Entity(i);break;default:_g.data[t][i.id]=i}}})}},complete:function(t,i){e.resolve()}}),e.promise})}),e=e["catch"](function(e){console.log(e)}).done(function(){_g.log("Preload All DBs (JSON ver.): DONE"),t.resolve()}),t.promise}).then(function(){_g.log("Preload All DBs: START");var e=[],t=[],i=0;for(var n in _db)t.push(n);return t.forEach(function(n){function a(e){_g.log("DB "+e+" DONE"),o.resolve(),i++,i>=t.length&&(_g.log("Preload All DBs: DONE"),setTimeout(function(){_frame.app_main.loaded("dbs")},100))}var o=Q.defer();_db[n].loadDatabase(function(e){e?o.reject(new Error(e)):_db[n].find({},function(e,t){e?o.reject(new Error(e)):("undefined"==typeof _g.data[n]&&(_g.data[n]={}),t.forEach(function(e){_g.data[n][e.id]=e}),a(n))})}),e.push(o.promise)}),Q.all(e)}).then(function(){var e=function(e){e.preventDefault(),_frame.app_main.load_page($(this).attr("href").substr("?page=".length))},t=function(e){e.preventDefault();var t=$(this);if(!t.attr("data-infos")){var i=/^[\?]{0,1}infos\=([^\&]+)\&id\=([^\&]+)/gi.exec(t.attr("href"));t.attr("data-infos","[["+i[1].toUpperCase()+"::"+i[2]+"]]"),_frame.infos.click(t)}},i=function(e){e.preventDefault();var t=$(this),i=_g.parseURI(t.attr("href"));i.page?_frame.app_main.load_page(i.page):i.infos&&_frame.infos.click(t.attr("data-infos","[["+i.infos.toUpperCase()+"::"+i.id+"]]"))},n=function(e){return e.currentTarget.getAttribute("href").indexOf("//"+location.host)<0?e.currentTarget.setAttribute("target","_blank"):void 0};return $body.on("click.global_delegate_page",'a[href^="?page="]',e).on("click.global_delegate_infos",'a[href^="?infos="]',t).on("click.global_delegate_default",'a[href^="/"]',i).on("click.global_external_links pointerdown.global_external_links",'a:not([target]):not([href^="/"]):not([href^="javascript:"])',n),!0}).then(function(){_frame.gg(_frame.dom.layout)})["catch"](function(e){_g.error(e)}).done(function(){_g.buildIndex(),_g.log("Global initialization DONE")}),this.is_init=!0}},_g.error=function(e){_instanceof(e,Error)||(e=new Error(e)),_g.badgeError(_instanceof(e,Error)?e.message:e),_g.log(e)};var debugmode=!1,ShareBar=function(){function e(t){return _classCallCheck(this,e),t=t||{},this.settings=$.extend(!0,{},e.defaults,t),this.el=this.create(),this}return _createClass(e,[{key:"create",value:function(){return this.el=$('<div class="sharebar"/>'),this.settings.sites.forEach(function(t){var i=$("<a/>",{"class":"sharebar-share sharebar-site-"+t,"data-share-site":t,href:"javascript:;",target:"_self",icon:e.iconmap[t]||t}).appendTo(this.el);this.settings.modifyItem&&this.settings.modifyItem(i)}.bind(this)),this.el.on("click.sharebar-share","a[data-share-site]",function(e,t){var i=$(e.target),n=i.attr("data-share-site");i.attr({href:"http://www.jiathis.com/send/?webid="+n+"&url="+encodeURIComponent(this.getContent("url",location.href))+"&title="+encodeURIComponent(this.getContent("title",document.title))+"&summary="+encodeURIComponent(this.getContent("summary",$('meta[name="description"]').attr("content")))+(this.settings.uid?"&uid="+this.settings.uid:"")+(this.settings.appkey[n]?"&appkey="+this.settings.appkey[n]:""),target:"_blank"})}.bind(this)),this.el}},{key:"getContent",value:function(e,t){return"function"==typeof this.settings[e]?this.settings[e](this):this.settings[e]?this.settings[e]:t}}]),e}();ShareBar.defaults={sites:["tsina","tqq","cqq","twitter","tieba"],appkey:{}},ShareBar.iconmap={tsina:"weibo",tqq:"tencent-weibo",cqq:"qq"};var duoshuoQuery={short_name:"duoshuo",sso:{login:"/?msg=loginsuccess",logout:"/?msg=logoutsuccess"}};!function(){if(!_g.isClient){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://static.duoshuo.com/embed.js",e.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}(),_tmpl.improvement=function(e,t,i,n){if("undefined"==typeof e)return!1;if("object"!=("undefined"==typeof e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;t=t||0,i=i||[0],n=n||!1;var a=e.improvement[t],o=a.upgrade?_g.data.items[a.upgrade[0]]:!1,s=[],r="";if(i.forEach(function(e){var t=a.req[e];t[1]&&s.mergeFrom(t[1])}),s.length){var l=[];s.forEach(function(e){l.push('<a href="?infos=ship&id='+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+_g.data.ships[e].getName()+"</a>")}),r="<font>"+l.join(" / ")+"</font>"}else r='<font class="no">无秘书舰要求</font>';return _tmpl["export"]('<span class="improvement">'+_tmpl.improvement__title(e,o,a.upgrade[1])+r+_tmpl.improvement__resource(a,o?!0:!1)+"</span>",n)},_tmpl.improvement_detail=function(e,t){if("undefined"==typeof e)return!1;if("object"!=("undefined"==typeof e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;var i="",n=e.improvement||[];return n.forEach(function(t){var n=t.upgrade?_g.data.items[t.upgrade[0]]:!1,a=this.improvement__reqdetails(t.req);i+='<span class="improvement improvement-details">'+_tmpl.improvement__title(e,n,t.upgrade[1])+a+_tmpl.improvement__resource(t,n?!0:!1)+"</span>"},this),_tmpl["export"](i,t)},_tmpl.improvement_inEquipmentInfos=function(e,t){if("undefined"==typeof e)return!1;if("object"!=("undefined"==typeof e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;var i="",n=e.improvement||[];return n.forEach(function(e){var t=e.upgrade?_g.data.items[e.upgrade[0]]:!1,n=this.improvement__reqdetails(e.req);i+='<span class="unit improvement improvement-details"><b>'+(t?'<span class="indicator true">可升级为</span><a class="equiptypeicon mod-left mod-'+t.getIconId()+'" href="?infos=equipment&id='+t.id+'" data-infos="[[EQUIPMENT::'+t.id+']]" data-tip="[[EQUIPMENT::'+t.id+']]">'+t.getName(!0)+"</a>"+(e.upgrade[1]?"<i>+"+e.upgrade[1]+"</i>":""):'<span class="indicator false">不可升级</span>')+"</b>"+n+_tmpl.improvement__resource(e,t?!0:!1)+"</span>"},this),_tmpl["export"](i,t)},_tmpl.improvement__title=function(e,t,i){return'<strong><a class="equiptypeicon mod-left mod-'+e.getIconId()+'" href="?infos=equipment&id='+e.id+'" data-infos="[[EQUIPMENT::'+e.id+']]" data-tip="[[EQUIPMENT::'+e.id+']]">'+e.getName(!0)+"</a>"+(t?'<b></b><a class="equiptypeicon mod-left mod-'+t.getIconId()+'" href="?infos=equipment&id='+t.id+'" data-infos="[[EQUIPMENT::'+t.id+']]" data-tip="[[EQUIPMENT::'+t.id+']]">'+t.getName(!0)+"</a>"+(i?"<i>+"+i+"</i>":""):"")+"</strong>"},_tmpl.improvement__resource=function(e,t){function i(e){return e=parseInt(e),0>e?"?":e}var n={};n.all='<span><em>必要资源</em><i class="fuel">'+i(e.resource[0][0])+'</i><i class="ammo">'+i(e.resource[0][1])+'</i><i class="steel">'+i(e.resource[0][2])+'</i><i class="bauxite">'+i(e.resource[0][3])+"</i></span>";for(var a=1;4>a;a++){var o="";switch(a){case 1:o="★+0 ~ +6";break;case 2:o="★+6 ~ MAX";break;case 3:o="升级"}n[a]="<span><em>"+o+"</em>"+(3!=a||t?'<i class="dev_mat">'+i(e.resource[a][0])+"<i>("+i(e.resource[a][1])+')</i></i><i class="imp_mat">'+i(e.resource[a][2])+"<i>("+i(e.resource[a][3])+")</i></i>"+(e.resource[a][4]?'<a class="equiptypeicon mod-left mod-'+_g.data.items[e.resource[a][4]].getIconId()+'" href="?infos=equipment&id='+e.resource[a][4]+'" data-infos="[[EQUIPMENT::'+e.resource[a][4]+']]" data-tip="[[EQUIPMENT::'+e.resource[a][4]+']]">'+_g.data.items[e.resource[a][4]].getName(!0)+"<i>x"+i(e.resource[a][5])+"</i></a>":""):'<i class="no">-</i>')+"</span>"}return"<span>"+n.all+n[1]+n[2]+n[3]+"</span>"},_tmpl.improvement__reqdetails=function(e){if(!e||!e.push||!e.length)return"";var t="<font>";return e.forEach(function(e){var i,n=[];t+="<b>";for(var a=0;7>a;a++){switch(a){case 0:i="日";break;case 1:i="一";break;case 2:i="二";break;case 3:i="三";break;case 4:i="四";break;case 5:i="五";break;case 6:i="六"}t+="<i"+(e[0][a]?' class="on"':"")+">"+i+"</i>"}e[1]?(e[1].forEach(function(e){n.push('<a href="?infos=ship&id='+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+_g.data.ships[e].getName()+"</a>")}),t+=n.join(" / ")):t+="<b>无秘书舰要求</b>",t+="</b>"}),t+="</font>"},_tmpl.link_entity=function(e,t,i,n){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.link_entity(e,t.tagName||null,t.returnHTML||null,t.count||null);if(t=t||"a",i=i||!1,n="undefined"==typeof n?!1:n,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var a=parseInt(e);e=_g.data.entities[a]}else var a=e.id;return _tmpl["export"]("<"+t+("a"==t?' href="?infos=entity&id='+a+'"':"")+' class="link_entity" data-entityid="'+a+'" data-infos="[[ENTITY::'+a+']]">'+(e.picture&&e.picture.avatar?'<i style="background-image:url('+e.picture.avatar+')"></i>':"<i></i>")+"<span>"+e._name+("undefined"==typeof n?"":" <small>("+n+")</small>")+"</span></"+t+">",i)},_tmpl.link_equipment=function(e,t,i,n){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.link_equipment(e,t.tagName||null,t.returnHTML||null,"undefined"==typeof t.improvementStar?null:t.improvementStar);if(t=t||"a",i=i||!1,n="undefined"==typeof n?null:n,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var a=parseInt(e);e=_g.data.items[a]}else var a=e.id;return _tmpl["export"]("<"+t+("a"==t?' href="?infos=equipment&id='+a+'"':"")+' class="link_equipment" data-equipmentid="'+a+'" data-tip-position="right" data-infos="[[EQUIPMENT::'+a+']]" data-tip="[[EQUIPMENT::'+a+']]"><i style="background-image:url(/!/assets/images/itemicon/'+e.getIconId()+'.png)"></i><span>'+e.getName(!0)+"</span>"+(null!==n?"<em"+(0>=n?' class="zero"':"")+">+"+n+"</em>":"")+"</"+t+">",i)},_tmpl.link_ship=function(e,t,i,n,a){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.link_ship(e,t.tagName||null,t.returnHTML||null,t.mode||null,t.extraIllust||null);if(t=t||"a",i=i||!1,n=n||"default","object"!=("undefined"==typeof e?"undefined":_typeof(e))){var o=parseInt(e);e=_g.data.ships[o]}else var o=e.id;var s="",r=e.getType(),l=!1;switch(n){case"names":var d=[];e.getSeriesData().forEach(function(e){var t=_g.data.ships[e.id].getNameNoSuffix();$.inArray(t,d)<0&&d.push(t)}),s=d.join(" / ");break;default:s=(r?"<small>"+r+"</small>":"")+e.getName(_g.joint)}return a&&!function(){var t=e.getSeriesData();t.forEach(function(e,i){if(l=e.illust_extra&&e.illust_extra.length&&e.illust_extra[0]?!0:!1,!l&&e.illust_delete){var n=i?t[i-1]:null;n&&(l=n.illust_extra&&n.illust_extra.length&&n.illust_extra[0]?!0:!1)}})}(),_tmpl["export"]("<"+t+("a"==t?' href="?infos=ship&id='+o+'"':"")+(' class="link_ship" data-shipid="'+o+'" data-infos="[[SHIP::'+o+']]"')+(l?' icon="hanger"':"")+">"+('<img src="'+node.path.normalize(_g.path.pics.ships)+"/"+o+'/0.png"/>')+("<span>"+s+"</span>")+("</"+t+">"),i)},_tmpl.textlink_entity=function(e,t,i){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.textlink_entity(e,t.tagName||null,t.returnHTML||null);if(t=t||"a",i=i||!1,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var n=parseInt(e);e=_g.data.entities[n]}else var n=e.id;return _tmpl["export"]("<"+t+("a"==t?' href="?infos=entity&id='+n+'"':"")+' data-entityid="'+n+'" data-infos="[[ENTITY::'+n+']]">'+e._name+"</"+t+">",i)},_tmpl.textlink_ship=function(e,t,i){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.textlink_ship(e,t.tagName||null,t.returnHTML||null);if(t=t||"a",i=i||!1,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var n=parseInt(e);e=_g.data.ships[n]}else var n=e.id;var a=e.getType();return _tmpl["export"]("<"+t+("a"==t?' href="?infos=ship&id='+n+'"':"")+' data-shipid="'+n+'" data-infos="[[SHIP::'+n+']]">'+(a?"["+a+"] ":"")+e.getName(_g.joint)+"</"+t+">",i)};var Page=function(){function e(t){_classCallCheck(this,e),t.on({pageHide:function(){this.modeSelectionExit()}.bind(this)})}return _createClass(e,[{key:"modeSelectionEnter",value:function(e,t){var i=void 0;return e=e||function(){},i=function(){e(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8],arguments[9],arguments[10]),setTimeout(function(){this.modeSelectionExit()}.bind(this),10)}.bind(this),_frame.app_main.mode_selection_callback=i,_frame.app_main.mode_selection_on(t),i}},{key:"modeSelectionExit",value:function(){return _frame.dom.layout.hasClass("mode-selection")?void _frame.app_main.mode_selection_off():!1}}]),e}();Page.hide=function(e){if(e=e||_frame.app_main.cur_page,"string"==typeof e)_frame.app_main.page_dom[e]&&_frame.app_main.page_dom[e].addClass("off").trigger("pageHide").detach(),_frame.dom.navs[e]&&_frame.dom.navs[e].removeClass("on");else{e.addClass("off").trigger("pageHide").detach();var t=e.attr("page");t&&_frame.dom.navs[t]&&_frame.dom.navs[t].removeClass("on")}_frame.app_main.cur_page=null},Page.show=function(e){e=e||_frame.app_main.cur_page;var t=void 0;"string"==typeof e?(_frame.app_main.page_dom[e]&&_frame.app_main.page_dom[e].appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),_frame.dom.navs[e]&&_frame.dom.navs[e].addClass("on"),t=e):(e.appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),t=e.attr("page")),_frame.app_main.cur_page&&Page.hide(_frame.app_main.cur_page),t&&(_frame.dom.navs[t]&&_frame.dom.navs[t].addClass("on"),_frame.dom.layout.attr("data-theme",t),_frame.app_main.cur_page=t)},Page.resetScroll=function(e){e=e||_frame.app_main.cur_page,"string"==typeof e&&(e=_frame.app_main.page_dom[e]),e&&e.length&&(e.attr("scrollbody",0),e.find("[scrollbody]").each(function(e,t){t.setAttribute("scrollbody",0)}))},Page.init=function(e){function t(e){e.currentTarget.setAttribute("scrollbody",e.currentTarget.scrollTop)}e=e||_frame.app_main.cur_page;var i=void 0;"string"==typeof e?(i=e,e=_frame.app_main.page_dom[e]):(e.appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),i=e.attr("page")),e&&e.length&&(i&&_frame.app_main.page[i]&&_frame.app_main.page[i].init&&_frame.app_main.page[i].init(e),_p.initDOM(e),e.find("[scrollbody]").on("scroll",t),e.on({scroll:t,"pageShow.scrollbody":function(){e.scrollTop(e.attr("scrollbody")||0),e.find("[scrollbody]").each(function(e,t){t.scrollTop=t.getAttribute("scrollbody")||0,setTimeout(function(){t.scrollTop=t.getAttribute("scrollbody")||0},10)})}}))},_frame.app_main.page.fleets={init:function(e){this.object=new(function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return e.on({pageShow:function(){this.inited&&e.children(".tablelist").data("tablelist").refresh(),this.inited=!0}}),i}return _inherits(t,e),t}(Page))(e)}},_frame.app_main.page.ships={init:function(e){this.object=new(function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return i.tablelist=e.find(".tablelist"),i.tablelistObj=i.tablelist.data("tablelist"),e.on({modeSelectionEnter:function(e,t){this.modeSelectionEnter(t)}.bind(i),pageShow:function(){this.tablelistObj||(this.tablelistObj=this.tablelist.data("tablelist"))}.bind(i),pageHide:function(){this.tablelistObj&&(this.tablelistObj.search(),this.tablelistObj.dom.searchInput.val(""))}.bind(i)}),i}return _inherits(t,e),t}(Page))(e)}},_frame.app_main.page.equipments={init:function(e){this.object=new(function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return i.tablelist=e.find(".tablelist"),i.tablelistObj=i.tablelist.data("tablelist"),e.on({modeSelectionEnter:function(e,t,i){this.modeSelectionEnter(t,i)}.bind(i),pageShow:function(){this.tablelistObj||(this.tablelistObj=this.tablelist.data("tablelist")),this.tablelistObj&&(this.tablelistObj.thead_redraw(),this.tablelistObj.apply_types())}.bind(i),pageHide:function(){TablelistEquipments.types=[],TablelistEquipments.shipId=null,this.tablelistObj&&this.tablelistObj.apply_types()}.bind(i)}),i}return _inherits(t,e),t}(Page))(e)}},_frame.app_main.page.arsenal={},_frame.app_main.page.arsenal.init=function(e){var t=e.find(".akashi");t.attr({animation:Math.floor(3*Math.random()+1)}).on(_g.event.animationiteration,function(){t.attr("animation",Math.floor(3*Math.random()+1))}),this.elMain=e.children(".main"),this.parse_weekday(this.elMain.children(".body-weekday")),this.parse_all(this.elMain.children(".body-all")),e.find('input[type="radio"]').on("change",function(){_frame.app_main.page.arsenal.elMain.scrollTop(0)})},_frame.app_main.page.arsenal.parse_weekday=function(e){var t=e.find("#arsenal_weekday-showmeterials");t.prop("checked",Lockr.get("arsenal_weekday-showmeterials",!0)?!0:!1).on("change",function(){Lockr.set("arsenal_weekday-showmeterials",t.prop("checked")?1:0)});var i=new Date;return i.setTime(i.getTime()+60*i.getTimezoneOffset()*1e3),i.setTime(i.getTime()+324e5),e.find("#arsenal_weekday-"+i.getDay()).prop("checked",!0),e},_frame.app_main.page.arsenal.parse_all=function(e){},_frame.app_main.page.about={},_frame.app_main.page.about.journal_parse=function(e){for(var t,i=/\[\[([^\:]+)\:([0-9]+)\]\]/gi,n=markdown.toHTML(e);t=null!==i.exec(e);)try{n=n.replace(t[0],_tmpl["link_"+t[1].toLowerCase()](t[2],null,!0))}catch(a){}for(t=null,i=/\[\[([^\:]+)\:([0-9]+)\:TEXT\]\]/gi;t=null!==i.exec(e);)try{n=n.replace(t[0],_tmpl["textlink_"+t[1].toLowerCase()](t[2],null,!0))}catch(a){}return n},_frame.app_main.page.about.journaltitle=function(e,t){return e=e||{},t=t||"h3","<h3>"+(e.hotfix?"HOTFIX - ":"")+("app"==e.type?"":("app-db"==e.type?"DB":e.type).toUpperCase()+" / ")+e.version+"<small>"+(e.date?e.date:"WIP")+"</small></h3>"},_frame.app_main.page.about.init=function(e){function t(t){var n="update_journal_"+i++,a=$('<input type="checkbox" id="'+n+'"/>').prop("checked",3>i?!0:!1).appendTo(e),o=$('<section class="update_journal" data-version-'+t.type+'="'+t.version+'"/>').append($('<label for="'+n+'"/>').html(_frame.app_main.page.about.journaltitle(t))).appendTo(e);try{$(_frame.app_main.page.about.journal_parse(t.journal)).appendTo(o)}catch(s){
_g.error(s),a.remove(),o.remove()}}var i=0,n=Q.fcall(function(){});n.then(function(){var e=Q.defer();return _db.updates.find({date:""}).sort({date:-1,version:-1}).exec(function(i,n){n.forEach(function(e){t(e)}),e.resolve(i)}),e.promise}).then(function(){var e=Q.defer();return _db.updates.find({$not:{date:""}}).sort({date:-1,version:-1}).exec(function(i,n){n.forEach(function(e){t(e)}),e.resolve(i)}),e.promise})},_frame.app_main.page.calctp={init:function(e){e.find("form.tpcalculator").each(function(e,t){t=$(t);var i=t.find(".result_a"),n=t.find(".result_s");t.on("input","input",function(){t.trigger("submit")}).on("submit",function(e){e.preventDefault();var a=t.serializeObject(),o=0,s=0;for(var r in a){var l=parseInt(a[r])||0;switch(r){case"dd":s+=5*l;break;case"cl":s+=2*l;break;case"cav":s+=4*l;break;case"av":s+=9.5*l;break;case"lha":s+=12.25*l;break;case"ao":s+=14.75*l;break;case"e75":s+=5*l;break;case"e68":s+=8*l}}o=.7*s,i.html(Math.floor(o)),n.html(Math.floor(s))})})}},_frame.gg=function(){$.ajax({url:"http://fleet.diablohu.com/!/g/",method:"get",dataType:"html",success:function(e){_g.isOnline=!0,e&&_frame.dom.layout.append($('<div class="g"/>').html(e).append($('<button type="button" class="close"/>').on("click",function(){_frame.dom.layout.css("padding-bottom","").removeClass("mod-g")}))).addClass("mod-g")}})};var BgImg=function(){function e(t){_classCallCheck(this,e),t=t||{},$.extend(!0,this,e.defaults,t)}return _createClass(e,[{key:"show",value:function(){return e.change(this)}},{key:"save",value:function(){return e.save(this)}},{key:"append",value:function(){this.isDefault?e.controlsEls.listDefault&&this.elThumbnail.appendTo(e.controlsEls.listDefault):e.controlsEls.listCustomAdd&&this.elThumbnail.insertBefore(e.controlsEls.listCustomAdd),e.cur&&e.cur.name===this.name&&this.elThumbnail.addClass("on")}},{key:"delete",value:function(){e["delete"](this)}},{key:"filename",get:function(){return this.isDefault?this.name.substr(1):this.name}},{key:"index",get:function(){var t=-1;return e.list.some(function(e,i){return e.name===this.name&&(t=i),e.name===this.name}.bind(this)),t}},{key:"els",get:function(){return this._els||(this._els=$('<s class="bgimg"/>').css("background-image","url("+this.path+")").add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")")).add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")")).add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")"))),this._els}},{key:"elThumbnail",get:function(){return this._elThumbnail||(this._elThumbnail=$("<dd/>").on("click",function(){e.change(this)}.bind(this)).append($("<s/>").css("background-image","url("+this.thumbnail+")")).append($("<i/>").on("click",function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),this.visible=!this.visible}.bind(this))),this.isDefault||this._elThumbnail.append($("<del/>").on("click",function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),this["delete"]()}.bind(this)))),this._elThumbnail}},{key:"path",get:function(){return this._path||(this._path=e.getPath(this)),this._path}},{key:"blur",get:function(){return this._blured||(this._blured=e.getPath(this,"blured")),this._blured}},{key:"thumbnail",get:function(){return this._thumbnail||(this._thumbnail=e.getPath(this,"thumbnail")),this._thumbnail}},{key:"visible",get:function(){return this.elThumbnail.hasClass("is-visible")},set:function(t){t?this.visible||(this.elThumbnail.addClass("is-visible"),e.listVisible.push(this),e.namesHidden.forEach(function(t,i){t===this.name&&e.namesHidden.splice(i,1)}.bind(this))):this.visible&&(this.elThumbnail.removeClass("is-visible"),e.listVisible.forEach(function(t,i){t===this&&e.listVisible.splice(i,1)}.bind(this)),e.namesHidden.push(this.name)),Lockr.set("BgImgHidden",e.namesHidden)}}]),e}();BgImg["default"]={isEnable:!0},BgImg.list=[],BgImg.listVisible=[],BgImg.countCustom=0,BgImg.init=function(){if(BgImg.isInit)return BgImg.list;_g.log("背景图: START"),BgImg.controlsInit(),_frame.dom.bgimg=$('<div class="bgimgs"/>').appendTo(_frame.dom.layout).on(_g.event.animationend,"s",function(){BgImg.changeAfter()});var e=Q.defer(),t=void 0;return BgImg.namesHidden=Lockr.get("BgImgHidden",[]),Q.fcall(BgImg.getDefaultImgs).then(function(){BgImg.list.forEach(function(e){BgImg.namesHidden.indexOf(e.name)>-1?e.visible=!1:e.visible=!0}),BgImg.ensureVisible(),BgImg.listVisible.some(function(e){return t||e.name==Lockr.get("BgImgLast","")||(t=e),e.name==Lockr.get("BgImgLast","")}),Lockr.set("BgImgLast",BgImg.listVisible[0].name),BgImg.change(t),_frame.app_main.loaded("bgimgs"),BgImg.isInit=!0,_g.log("背景图: DONE"),e.resolve()}),e.promise},BgImg.getObj=function(e){if("string"==typeof e){var t=void 0;return BgImg.list.some(function(i){return i.name===e&&(t=i),i.name===e}),t}return"number"==typeof e?BgImg.list[e]:"undefined"==typeof e?BgImg.cur:e},BgImg.change=function(e){if(BgImg.list.length){if("undefined"==typeof e){if(BgImg.ensureVisible(),e=BgImg.listVisible[_g.randInt(BgImg.listVisible.length)],BgImg.cur&&e.name===BgImg.cur.name)return 1==BgImg.listVisible.length?e:BgImg.change()}else if(e=BgImg.getObj(e),BgImg.cur&&e.name===BgImg.cur.name)return e;return BgImg.cur&&(BgImg.lastToHide=BgImg.cur,BgImg.cur.elThumbnail.removeClass("on")),e.els.addClass(BgImg.cur?"fadein":""),e.els.eq(0).appendTo(_frame.dom.bgimg),e.els.eq(1).appendTo(_frame.dom.nav),e.els.eq(2).appendTo(_frame.dom.main),e.els.eq(3).appendTo(BgImg.controlsEls.bgimgs),e.elThumbnail.addClass("on"),BgImg.cur=e,e}},BgImg.changeAfter=function(){BgImg.lastToHide&&(BgImg.lastToHide.els.detach(),delete BgImg.lastToHide)},BgImg.upload=function(){BgImg.fileSelector||(BgImg.fileSelector=$('<input type="file" class="none"/>').on("change",function(e){if(BgImg.fileSelector.val()){var t=function(){var t=function(){BgImg.controlsEls.body.removeClass("is-loading"),BgImg.fileSelector.prop("disabled",!1),BgImg.fileSelector.val(""),_g.log("BgImg.add() complete")},i=void 0,n=e.target.files[0].type;return n?(n=n.split("/"),"image"!=n[0].toLowerCase()?(_g.badgeError("请选择图片文件"),t(),{v:void 0}):["bmp","jpg","jpeg","png","gif","tif","tiff","webp"].indexOf(n[1].toLowerCase())<0?(_g.badgeError("当前仅支持以下格式: BMP、JPG、PNG、GIF、TIFF"),t(),{v:void 0}):void Q.fcall(function(){return BgImg.controlsEls.body.addClass("is-loading"),BgImg.fileSelector.prop("disabled",!0),BgImg.readFile(e)}).then(function(e){return i=e,BgImg.list.push(i),BgImg.generate(i,"thumbnail")}).then(function(e){return BgImg.set(i,"thumbnail",e)}).then(function(){return BgImg.generate(i,"blured")}).then(function(e){return BgImg.set(i,"blured",e)}).then(function(){BgImg.countCustom||BgImg.list.forEach(function(e){e.visible&&(e.visible=!1)}),i.append(),i.show(),i.visible=!0,BgImg.countCustom++})["catch"](function(e){_g.error(e,"自定义背景图"),i&&i["delete"]()}).done(t)):(_g.badgeError("文件格式未知"),t(),{v:void 0})}();if("object"===("undefined"==typeof t?"undefined":_typeof(t)))return t.v}})),BgImg.fileSelector.trigger("click")},BgImg.generate=function(e,t){function i(e){n.reject("读取图片文件发生错误")}e=BgImg.getObj(e);var n=Q.defer(),a=void 0;switch(t){case"thumbnail":a=$("<img/>",{src:e.path}).on({load:function(){var e=canvas.downScale(a[0],150/Math.min(a[0].width,a[0].height));a.remove(),n.resolve(e)},error:i}).appendTo($body);break;case"blured":a=$("<img/>",{src:e.path}).on({load:function(){var e=$("<canvas/>");canvas.blur.image(a[0],e[0],20*Math.min(a[0].width,a[0].height)/1080),a.remove(),n.resolve(e[0])},error:i}).appendTo($body)}return n.promise},BgImg.getUniqueName=function(e){var t=void 0,i=1,n=e;for("number"==typeof e&&(e=""+e);t=BgImg.getObj(n);){n=e.split(".");var a=n.pop();n=n.join(".")+"-"+i++ +"."+a}return n},BgImg.ensureVisible=function(){BgImg.listVisible.length||BgImg.list.forEach(function(e){(BgImg.countCustom&&!e.isDefault||!BgImg.countCustom&&e.isDefault)&&(e.visible=!0)})},BgImg.controlsInit=function(){return BgImg.controlsEls?BgImg.controlsEls.container:(BgImg.controlsEls={},BgImg.controlsEls.body=$('<div class="bgcontrols"/>').appendTo(_frame.dom.layout).on(_g.event.animationend,function(e){e.currentTarget==e.target&&(BgImg.controlsShowing?BgImg.controlsHideAfter():BgImg.controlsShowAfter())}).append(BgImg.controlsEls.container=$('<div class="wrapper"/>').append(BgImg.controlsEls.bgimgs=$('<div class="bgimgs"/>'))),BgImg.controlsEls.container)},BgImg.controlsShow=function(){BgImg.controlsEls&&!BgImg.controlsShowing&&(BgImg.controlsEls.listDefault||($('<div class="controls"/>').appendTo(BgImg.controlsEls.container).append(BgImg.controlsEls.btnViewingToggle=$('<button icon="eye"/>').on("click",BgImg.controlsViewingToggle)).append($('<button icon="floppy-disk"/>').on("click",function(){BgImg.save()})).append($('<button icon="arrow-set2-right"/>').on("click",BgImg.controlsHide)),$('<div class="list"/>').appendTo(BgImg.controlsEls.container).append($("<dl/>",{"class":"notes",html:"勾选的图片将会出现在背景图随机队列中"})).append(BgImg.controlsEls.listCustom=$("<dl/>",{html:"<dt>自定义</dt>"}).prepend(function(){return BgImg.quota?$("<small/>").append(BgImg.controlsEls.listCustomQuotaUsed=$("<span>"+_g.getSize(BgImg.quotaUsed,"m")+"</span>")).append(" / <span>"+_g.getSize(BgImg.quota,"m")+"</span>"):void 0}).append(BgImg.controlsEls.listCustomAdd=$("<dd/>",{"class":"add",html:"<s></s>"}).on("click",function(){BgImg.upload()}))).append(BgImg.controlsEls.listDefault=$("<dl/>",{html:"<dt></dt>"})),BgImg.list.forEach(function(e){e.append()})),_frame.dom.layout.addClass("mod-bgcontrols"))},BgImg.controlsShowAfter=function(){BgImg.controlsEls&&!BgImg.controlsShowing&&(BgImg.controlsEls.body.addClass("is-on"),BgImg.controlsShowing=!0)},BgImg.controlsHide=function(){BgImg.controlsEls&&BgImg.controlsShowing&&BgImg.controlsEls.body.addClass("is-hiding")},BgImg.controlsHideAfter=function(){BgImg.controlsEls&&BgImg.controlsShowing&&(_frame.dom.layout.removeClass("mod-bgcontrols"),BgImg.controlsEls.body.removeClass("is-on is-hiding"),BgImg.controlsShowing=!1)},BgImg.controlsToggle=function(){return BgImg.controlsShowing?BgImg.controlsHide():BgImg.controlsShow()},BgImg.controlsViewingToggle=function(){BgImg.controlsEls.body.toggleClass("mod-viewing"),BgImg.controlsEls.btnViewingToggle.toggleClass("on")},BgImg.quota=10485760,BgImg.quotaUsed=0,BgImg.getDefaultImgs=function(){for(var e=Q.defer(),t=_g.bgimg_count-1;t>=0;t--)BgImg.list.push(new BgImg({name:"*"+t+".jpg",isDefault:!0}));return BgImg.dataCustom={},localforage.getItem("bgcustomlist",function(t,i){BgImg.dataCustom=i||{};for(var n in BgImg.dataCustom){var a=BgImg.dataCustom[n];a.name=n,BgImg.list.push(new BgImg(a)),BgImg.countCustom++,BgImg.quotaUsed+=a.size}BgImg.updateQuotaUsed(),e.resolve(BgImg.list)}),e.promise},BgImg.updateQuotaUsed=function(){BgImg.controlsEls.listCustomQuotaUsed&&BgImg.controlsEls.listCustomQuotaUsed.html(_g.getSize(BgImg.quotaUsed,"m"))},BgImg.getPath=function(e,t){return e=BgImg.getObj(e),e.isDefault?_g.path.bgimg_dir+(t?t+"/":"")+e.filename:t?e["_"+t]:e._path},BgImg.save=function(e){e=BgImg.getObj(e),_g.save(e.path,"fleet.diablohu.com - "+e.filename)},BgImg.readFile=function(e){var t=Q.defer();return Q.fcall(_g.getScriptCanvas).then(function(){for(var i=0,n=void 0;n=e.target.files[i];i++){if(BgImg.quotaUsed+n.size>BgImg.quota){t.reject("已超过 "+_g.getSize(BgImg.quota,"m")+" 上限");break}var a=new FileReader;a.onload=function(e){return function(i){var n=BgImg.getUniqueName(e.name);BgImg.quotaUsed+=e.size,BgImg.updateQuotaUsed(),BgImg.dataCustom[n]={_path:i.target.result,size:e.size},localforage.setItem("bgcustomlist",BgImg.dataCustom,function(a,o){t.resolve(new BgImg({name:n,_path:i.target.result,size:e.size}))})}}(n),a.readAsDataURL(n)}}),t.promise},BgImg.set=function(e,t,i){e=BgImg.getObj(e);var n=i.toDataURL("image/jpeg","blured"==t?.4:.6),a=Q.defer();return e["_"+t]=n,BgImg.dataCustom[e.name]["_"+t]=n,localforage.setItem("bgcustomlist",BgImg.dataCustom,function(e,t){a.resolve()}),a.promise},BgImg["delete"]=function(e){e=BgImg.getObj(e);var t=Q.defer();return e.elThumbnail.remove(),e.els.remove(),BgImg.listVisible.forEach(function(t,i){t===e&&BgImg.listVisible.splice(i,1)}),BgImg.namesHidden.forEach(function(t,i){t===e.name&&BgImg.namesHidden.splice(i,1)}),Lockr.set("BgImgHidden",BgImg.namesHidden),delete BgImg.dataCustom[e.name],localforage.setItem("bgcustomlist",BgImg.dataCustom,function(i,n){BgImg.countCustom--,BgImg.quotaUsed-=e.size,BgImg.updateQuotaUsed(),BgImg.list.forEach(function(t,i){t===e&&BgImg.list.splice(i,1)}),BgImg.cur===e&&BgImg.change(),t.resolve()}),t.promise},_frame.infos={historyLength:-1,historyCurrent:-1,contentCache:{},getContent:function(e,t,i){function n(e){return i&&i(e),e}function a(i){return"fleet"==e&&(i=_frame.infos["__"+e](t,i)),_p.initDOM(i.addClass("infosbody").attr({"data-infos-type":e,"data-infos-id":t}))}if(this.contentCache[e]||(this.contentCache[e]={}),!this.firstrun){var o=this.dom.container.children(".infosbody").eq(0);if(this.firstrun=!0,o.attr("data-infos-type")==e&&o.attr("data-infos-id")==t)return this.contentCache[e][t]=_p.initDOM(o),_frame.app_main.page_title[_g.state2URI({infos:e,id:t})]=document.title,n(this.contentCache[e][t]);o.attr("data-infos-type")==e&&o.remove()}return"__NEW__"==t?n(a(this["__"+e](t))):this.contentCache[e][t]?n(this.contentCache[e][t]):void _frame.app_main.loading_start(_g.state2URI({infos:e,id:t}),{success:function(i){if(i){var n=/\<div class\=\"wrapper\"\>(.+)\<\/div\>/.exec(i);_frame.infos.contentCache[e][t]=a($(n.length>1?n[1]:""))}},successAfter:function(){return n(_frame.infos.contentCache[e][t])},error:function(){"undefined"!=typeof _frame.infos.contentCache[e][t]&&delete _frame.infos.contentCache[e][t],history.back()}})},show:function(e,t,i){var n=/^\[\[([^\:]+)\:\:(.+)\]\]$/.exec(e),a=null,o=null;if(!(n&&n.length>2))return!1;switch(a=n[1].toLowerCase(),o=isNaN(n[2])?n[2]:parseInt(n[2]),a){case"item":case"equip":case"equipments":a="equipment"}return this.curContent==a+"::"+o?this.dom.container.children("div:first-child"):(i||(this.historyCurrent++,this.historyLength=this.historyCurrent,_frame.app_main.pushState({infos:a,id:o,infosHistoryIndex:this.historyCurrent},null,_g.state2URI({infos:a,id:o}))),void this.show_func(a,o,i))},show_func:function(e,t,i,n){return e&&t?(_g.pageChangeBefore(),this.curContent==e+"::"+t?this.dom.container.children("div:first-child"):(e=e.toLowerCase(),isNaN(t)||(t=parseInt(t)),this.dom||(this.dom={main:_frame.dom.main.children(".page-container.infos")},this.dom.main.length?this.dom.container=this.dom.main.children(".wrapper"):(this.dom.main=$('<div class="page-container infos"/>').appendTo(_frame.dom.main),this.dom.container=$('<div class="wrapper"/>').appendTo(this.dom.main)),this.dom.main.on(eventName("transitionend","infos_hide"),function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.infos.dom.main.css("opacity")&&_frame.infos.hide_finish()}),_frame.dom.btnHistoryBack&&_frame.dom.btnHistoryBack.on(eventName("transitionend","infos_hide"),function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.dom.btnHistoryBack.css("opacity")&&_frame.infos.hide_finish()})),_frame.dom.layout.addClass("is-infos-show"),this.curContent=e+"::"+t,void this.getContent(e,t,function(i){switch(this.dom.container.children().not(i).each(function(e,t){var i=$(t);0==i.css("opacity")&&i.trigger("hidden")}),e){case"ship":case"equipment":case"entity":this.dom.main.attr("data-infostype",e);break;case"fleet":this.dom.main.attr("data-infostype","fleet"),TablelistEquipments.types=[]}switch(e){case"ship":_g.title(_frame.app_main.navtitle.ships);break;case"equipment":_g.title(_frame.app_main.navtitle.equipments);break;case"entity":_g.title(_frame.app_main.navtitle.entities);break;case"fleet":_g.title(_frame.app_main.navtitle.fleets)}var n=!i.data("is_infosinit");i.data("is_infosinit")||("ship"==e&&!function(){var e=parseInt(_config.get("ship_infos_lvl")||99);i.find('input[type="radio"][name^="ship_infos_lvl_"]').each(function(){var t=$(this),i=t.val();t.prop("checked",e==i).on("change",function(){_config.set("ship_infos_lvl",i)})})}(),_frame.infos["__"+e+"_init"]&&_frame.infos["__"+e+"_init"](i),i.data("is_infosinit",!0).on("hidden",function(){i.detach().data("is_show",!1)}).on(eventName("transitionend","hide"),function(n){n.currentTarget==n.target&&"opacity"==n.originalEvent.propertyName&&0==i.css("opacity")&&i.data("is_show")&&(_frame.infos.curContent==e+"::"+t?i.prependTo(_frame.infos.dom.container):i.trigger("hidden"))})),this.curContent==e+"::"+t&&(i.prependTo(this.dom.container).trigger("show",[n]).data("is_show",!0),this.dom.main.scrollTop(0),_frame.app_main.cur_page&&Page.hide(_frame.app_main.cur_page),_frame.dom.main.attr("data-theme",i.attr("data-theme")||e),_frame.dom.layout.attr("data-theme",i.attr("data-theme")||e),setTimeout(function(){_frame.dom.layout.addClass("is-infos-on"),document.title=_frame.app_main.page_title[_g.state2URI({infos:e,id:t})],_ga.counter(location.search)},1))}.bind(this)))):!1},hide:function(){return this.dom&&this.curContent?(_frame.dom.layout.removeClass("is-infos-on"),void(this.curContent=null)):!1},hide_finish:function(){return this.curContent?!1:(this.dom.container.children().trigger("hidden"),_frame.dom.layout.removeClass("is-infos-show"),this.dom.main.attr({"data-infostype":"","data-theme":""}),this.historyLength=-1,void(this.historyCurrent=-1))},click:function(e){this.show(e.attr("data-infos"),e,e.attr("data-infos-nohistory"))},init:function(){return this.is_init?!0:($body.on("click._infos","[data-infos]",function(e){("input"!=e.target.tagName.toLowerCase()||"compare"!=e.target.className)&&(_frame.infos.click($(this)),"a"==e.target.tagName.toLowerCase()&&e.preventDefault())}),this.is_init=!0,!0)}},_frame.infos.__ship_init=function(e){function t(){l=g.scrollLeft(),w=g.width(),T=parseInt(I.filter(":checked").val())-1,C=Math.floor(w/(.95*v.outerWidth()))}function i(){l>=0&&(r=g.scrollLeft(),m||requestAnimationFrame(n),m=!0)}function n(){var e=r-l,t=(Math.floor(Math.abs(e)/w)+(Math.abs(e%w)>w/2?1:0))*(l>r?-1:1);if(m=!1,0!==e){var i=T+t*C;0>i&&(i=0),i+C>I.length&&(i=I.length-C),I.eq(i).prop("checked",!0)}}function a(){l=-1,I.filter(":checked").trigger("change",0),f&&t()}function o(e){$window.on("resized."+y,a),a()}function s(){$window.off("resized."+y)}var r=void 0,l=-1,d=void 0,u=void 0,c=void 0,h=void 0,p=void 0,m=!1,f=_huCss.csscheck_full("scroll-snap-type")&&!bFirefox,_=e.find(".illustrations"),g=_.children("div"),b=g.children("span"),v=b.eq(0),y="e"+_g.timeNow(),k=_.children("label"),I=_.children('input[type="radio"]').on("change",function(e,t){var n=parseInt(e.target.getAttribute("value"))-1;k.eq(n).is(":visible")||(n--,I.eq(n).prop("checked",!0)),f&&g.off("scroll").animate({scrollLeft:b.eq(n)[0].offsetLeft},"undefined"==typeof t?200:t,function(){g.on("scroll",i)})}),w=0,T=0,C=1;e.on({show:o,hidden:s}),f?(_.addClass("mod-scroll-snap"),g.on({scroll:i,pointerdown:function(e){0>l&&"touch"==e.originalEvent.pointerType&&t()},touchstart:function(){0>l&&t()}})):!function(){var e=function(){g.css("transform","").removeClass("is-panning"),l=0,d=0,u=0,h=0,p=0,C=0,o=!1,$(document).off("touchmove.infosShipIllust touchend.infosShipIllust touchcancel.infosShipIllust")},t=function(){m=!1;var e=0>=T&&h>0||T>=I.length-C&&0>h;g.css("transform","translateX("+(h*(e?.3333:1)+l)+"px)")},i=function(){m||requestAnimationFrame(t),m=!0},n=function(t){if((d||u)&&1==t.originalEvent.targetTouches.length)if(h=t.originalEvent.targetTouches[0].clientX-d,o)i();else{p=t.originalEvent.targetTouches[0].clientY-u;var n=Math.abs(h),a=Math.abs(p);20>n&&20>a||n>a?(t.preventDefault(),n>a&&(o=!0,g.addClass("is-panning"),i())):e()}},a=function(t){requestAnimationFrame(function(){if(h&&(Math.abs(h)>w/3||_g.timeNow()-c<300)){var t=void 0;0>h&&T<I.length-1?t=T+C:h>0&&T>0&&(t=T-1),0>t&&(t=0),t+C>I.length&&(t=I.length-C),I.eq(t).prop("checked",!0).trigger("change")}e()})},o=!1;_.on({touchstart:function(e){if(e.originalEvent.targetTouches&&1==e.originalEvent.targetTouches.length){var t=g.css("transform").replace(/[^0-9\-.,]/g,"").split(",");l=parseInt(t[12]||t[4]||0),d=e.originalEvent.targetTouches[0].clientX,u=e.originalEvent.targetTouches[0].clientY,c=_g.timeNow(),T=parseInt(I.filter(":checked").val())-1,C=Math.floor(g.width()/(.95*v.outerWidth())),w=g.width(),$(document).on({"touchmove.infosShipIllust":n,"touchend.infosShipIllust":a,"touchcancel.infosShipIllust":a})}},touchmove:function(e){o&&e.preventDefault()}})}()},_frame.infos.__fleet=function(e,t,i){return new InfosFleet(e,t,i).el};var InfosFleet=function(){function e(t,i,n){_classCallCheck(this,e),this.el=i||$("<div/>"),this.el.addClass("infos-fleet infosbody loading").attr({"data-infos-type":"fleet","data-infos-title":"舰队 ("+t+")"}),this.doms={},this.fleets=[],this.tip_hqlv_input="输入 0 表示采用默认等级 (Lv.%1$d)",n?this.init(n):"__NEW__"==t?_db.fleets.insert(_tablelist.prototype._fleets_new_data(),function(e,t){e?_g.error(e):"fleet::__NEW__"==_frame.infos.curContent&&_frame.infos.show("[[FLEET::"+t._id+"]]")}.bind(this)):_db.fleets.find({_id:t},function(e,n){if(e||!n)_g.error(e);else if(_frame.infos.curContent=="fleet::"+t)if(n.length)this.init(n[0]);else try{this._infos_state_id=t,this.init(TablelistFleets.prototype.new_data(JSON.parse(LZString.decompressFromEncodedURIComponent(_g.uriSearch("d")))))}catch(a){_g.error(a)}else i.remove(),delete _frame.infos.contentCache.fleet[t]}.bind(this)),e.cur=this}return _createClass(e,[{key:"init",value:function(t){if(!t)return!1;this.el.on({show:function(e,t){if(this.is_showing=!0,InfosFleetShipEquipment.cur&&InfosFleetShipEquipment.cur.trigger("blur"),!t){for(var i=0,n=Lockr.get("hqLvDefault",_g.defaultHqLv);4>i;)this.fleets[i].summaryCalc(!0),i++;this._hqlv||this.doms.hqlvOption.val(n),this.doms.hqlvOptionLabel.data("tip",this.tip_hqlv_input.printf(n)),this.doms.hqlvOption.attr("placeholder",n)}this.is_init&&this.updateURI()}.bind(this),hidden:function(){this.is_showing=!1,InfosFleetShipEquipment.cur&&InfosFleetShipEquipment.cur.trigger("blur")}}).on("focus.number_input_select",'input[type="number"]:not([readonly])',function(e){e.currentTarget.select()}),this.data=t;var i=0,n=Lockr.get("hqLvDefault",_g.defaultHqLv);for(this.el.attr({"data-fleetid":t._id,"data-infos-id":t._id}).removeClass("loading"),this.el.find(".loading-msg").remove(),$("<header/>").append(this.doms.name=$("<h3 contenteditable/>").html("点击编辑标题").on({input:function(){this.doms.name.trigger("namechange")}.bind(this),focus:function(){"点击编辑标题"==this.doms.name.text()&&this.doms.name.html("")}.bind(this),blur:function(){this.doms.name.text()||this.doms.name.html("点击编辑标题")}.bind(this),namechange:function(e,t){return"undefined"==typeof t&&(t=this.doms.name.text()),t!=this.doms.name.html()&&this.doms.name.html(t),this._name=t,this.doms.name}.bind(this),keydown:function(e){13==e.keyCode&&(this.doms.name.blur(),setTimeout(function(){this.doms.name.blur()}.bind(this),1)),setTimeout(function(){this.doms.name.text()||(this._name="")}.bind(this),100)}.bind(this)})).append(this.doms.preview=$('<div class="preview"/>')).appendTo(this.el),$('<div class="fleets"/>').append(this.doms.tabs=$('<div class="tabs"/>')).append(this.doms.options=$('<div class="options"/>').append(this.doms.hqlvOptionLabel=$("<label/>",{"class":"option option-hqlv",html:"司令部等级","data-tip":this.tip_hqlv_input.printf(n)}).on({"mouseenter mouseleave":function(e){_p.tip.is_showing&&!_p.tip.timeout_fade&&this.doms.hqlvOption.is(":focus")&&(e.stopImmediatePropagation(),e.stopPropagation())}.bind(this)}).append(this.doms.hqlvOption=$("<input/>",{type:"number",min:0,max:_g.shipMaxLv,placeholder:n}).val(this._hqlv||n).on({input:function(){this._hqlv=this.doms.hqlvOption.val()}.bind(this),"focus.tipshow":function(){this.doms.hqlvOption.trigger("tipshow")}.bind(this),"blur.tiphide":function(){this.doms.hqlvOption.trigger("tiphide")}.bind(this),click:function(e){e.stopImmediatePropagation(),e.stopPropagation()}}))).append(this.doms.theme=$('<select class="option option-theme-value"/>').on("change",function(){this._theme=this.doms.theme.val()}.bind(this)).append(function(){for(var e=$(),t=1;11>t;t++)e=e.add($("<option/>",{value:t,html:"主题-"+t}));return e})).append(this.doms.themeOption=$('<button class="option option-theme mod-dropdown"/>').html("主题").on("click",function(){var t=this;if(!e.menuTheme){e.menuThemeItems=$("<div/>");for(var i=function(i){$('<button class="theme-'+i+'"/>').html(i).on("click",function(){e.menuCur._theme=i,this.el.attr("data-theme",this._theme)}.bind(t)).appendTo(e.menuThemeItems)},n=1;11>n;n++)i(n);e.menuTheme=new _menu({className:"contextmenu-infos_fleet_themes",items:[e.menuThemeItems]})}e.menuCur=this,e.menuTheme.show(this.doms.themeOption)}.bind(this))).append(this.doms.exportOption=$('<button class="option mod-dropdown"/>').html("分享").on("click",function(){if(!e.menuExport){var t=[];(!_g.isClient||_g.isOnline)&&t.push($('<div class="item"/>').html("分享当前配置"+(_g.isClient?"":"<small>可直接分享网址</small>")).add(new ShareBar({title:function(){return e.menuCur.data.name},summary:"分享自 是谁呼叫舰队 (http://fleet.diablohu.com)",sites:["tsina","tqq","cqq","twitter","tieba"],uid:1552359,modifyItem:function(e){e.addClass("menuitem")},url:function(){return e.menuCur.url}}).el.addClass("item")).add($("<hr/>"))),_g.isClient&&t.push($("<menuitem/>",{html:"在浏览器中打开当前配置"}).on("click",function(){node.gui.Shell.openExternal(e.menuCur.url)})),t=t.concat([$("<menuitem/>",{html:"导出配置代码"}).on("click",function(){e.menuCur.modalExport_show()}),$("<menuitem/>",{html:"导出配置文本"}).on("click",function(){e.menuCur.modalExportText_show()})]),_g.isNWjs&&t.push($("<menuitem/>",{html:"生成图片"}).on("click",function(){e.menuCur.exportPic()})),e.menuExport=new _menu({className:"contextmenu-infos_fleet_themes",items:t})}e.menuCur=this,e.menuExport.show(this.doms.exportOption)}.bind(this))).append(this.doms.optionOptions=$('<button class="icon" icon="cog"/>').on("click",function(){TablelistFleets.menuOptions_show(this.doms.optionOptions)}.bind(this)))).appendTo(this.el),this.doms.ships=$('<div class="ships"/>').appendTo(this.el);4>i;)this.fleets[i]=new InfosFleetSubFleet(this,[],i),$("<input/>",{type:"radio",name:"fleet_"+t._id+"_tab",id:"fleet_"+t._id+"_tab_"+i,value:i}).prop("checked",0==i).prependTo(this.el),$("<label/>",{"for":"fleet_"+t._id+"_tab_"+i,"data-fleet":i,html:"#"+(i+1)}).appendTo(this.doms.tabs),this.fleets[i].el.attr("data-fleet",i).appendTo(this.doms.ships),i++;this.data._id||(this.el.addClass("mod-preview"),this.doms.preview.html("若要编辑配置或保存以备日后查看，请").append($("<button/>",{html:"保存配置"}).on("click",function(){this.previewSave()}.bind(this))),this.doms.name.removeAttr("contenteditable"),this.doms.hqlvOptionLabel.data("tip","若要编辑配置或保存以备日后查看，<br/>请点击上方的“保存配置”按钮"),this.doms.hqlvOption.prop("readonly",!0)),this.update(t),this._theme=this._theme,$body.on("update_defaultHqLv.fleet"+this.data._id,function(e,t){this.is_showing&&(this._hqlv||this.doms.hqlvOption.val(t),this.doms.hqlvOptionLabel.data("tip",this.tip_hqlv_input.printf(t)),this.doms.hqlvOption.attr("placeholder",t))}.bind(this))}},{key:"update",value:function(t){this._updating=!0,t=t||{},t.data=e.decompress(t.data),"undefined"!=typeof t.theme&&(_frame.infos.dom.main.attr("data-theme",t.theme),this.doms.theme.val(t.theme).attr("value",t.theme)),"undefined"!=typeof t.name&&this.doms.name.html(t.name).trigger("namechange",[t.name]).trigger("blur"),t.data&&t.data.push&&t.data.forEach(function(e,t){this.fleets[t].updateEl(e)},this),this._updating=!1}},{key:"update_data",value:function(e){e=e||{},this.update(e)}},{key:"previewSave",value:function(){_db.fleets.insert(TablelistFleets.prototype.new_data(this.data),function(e,t){if(e)_g.error(e);else{this.el.attr({"data-infos-id":t._id}),_frame.infos.curContent="fleet::"+t._id;var i=_frame.infos.__fleet(t._id,null,t);_frame.infos.contentCache.fleet[t._id]=i,_frame.infos.contentCache.fleet[this._infos_state_id]=i,i.insertBefore(this.el),this.el.remove(),delete this,_g.badgeMsg("舰队配置已保存")}}.bind(this))}},{key:"updateURI",value:function(){if(!_g.isNWjs&&this.data._id&&_g.uriSearch()){var e=$.extend(!0,{},this.data),t=e._id;delete e._id,delete e.time_create,delete e.time_modify,delete e.rating,delete e.user,history.replaceState(history.state,document.title,location.pathname+"?i="+t+"&d="+LZString.compressToEncodedURIComponent(JSON.stringify(e)))}}},{key:"save",value:function(t){return this._updating?this:(this.is_init?(this.data.data=[],this.fleets.forEach(function(e,t){this.data.data[t]=e.data},this),e.clean(this.data.data),this.data.time_modify=_g.timeNow(),this.updateURI(),t||(clearTimeout(this.delay_updateDb),this.delay_updateDb=setTimeout(function(){_db.fleets.updateById(this.data._id,e.compressMetaData(this.data),function(){_g.log("saved"),e.decompressMetaData(this.data)}.bind(this)),clearTimeout(this.delay_updateDb),this.delay_updateDb=null}.bind(this),200))):(e.clean(this.data.data),this.updateURI()),this.is_init=!0,this)}},{key:"modalExport_show",value:function(){e.modalExport_show(this.data)}},{key:"modalExportText_show",value:function(){e.modalExportText_show(this.data)}},{key:"exportPic",value:function(){e.fileDialog_export||(e.fileDialog_export=$('<input type="file" accept=".png" nwsaveas/>').on({click:function(t,i,n){e.fileDialog_export.data({windowWidth:i,windowHeight:n}),e.fileDialog_export_showing=!0},change:function(){var t=e.fileDialog_export.val();e.fileDialog_export.val(""),_g.log("changed"),setTimeout(function(){node.win.capturePage(function(e){var i=node.fs.createWriteStream(t);i.write(e),i.end()},{format:"png",datatype:"buffer"})},0)},resetCaptureMode:function(){!e.fileDialog_export.val()&&$body.hasClass("mod-capture")&&($body.removeClass("mod-capture"),node.win.resizeTo(e.fileDialog_export.data("windowWidth"),e.fileDialog_export.data("windowHeight")),e.fileDialog_export.data({windowWidth:null,windowHeight:null}),_menu.hideAll())}}).appendTo(_frame.dom.hidden),$window.on("focus.resetCaptureMode",function(){e.fileDialog_export_showing&&setTimeout(function(){e.fileDialog_export.trigger("resetCaptureMode"),e.fileDialog_export_showing=!1},100)}));var t=$window.width(),i=$window.height();$body.addClass("mod-capture"),node.win.resizeTo(1280,720),e.fileDialog_export.trigger("click",[t,i])}},{key:"remove",value:function(){e.modalRemove_show(this)}},{key:"_name",get:function(){return this.data.name},set:function(e){this.data.name=e,e?this.doms.name.attr("data-content",e):this.doms.name.removeAttr("data-content"),this.save()}},{key:"_theme",get:function(){return this.data.theme},set:function(e){this.data.theme=e||1,this.doms.theme.val(this.data.theme).attr("value",this.data.theme),_frame.infos.dom.main.attr("data-theme",this.data.theme),this.el.attr("data-theme",this.data.theme),_frame.dom.layout.attr("data-theme",this.data.theme),this.save()}},{key:"_hqlv",get:function(){return this.data.hq_lv>0?this.data.hq_lv:0},set:function(e){e=parseInt(e);var t=this._hqlv;if(e&&e>0?(this.data.hq_lv=e,this.doms.hqlvOption.val(e)):(e=-1,this.data.hq_lv=-1,this.doms.hqlvOption.val(Lockr.get("hqLvDefault",_g.defaultHqLv))),t!=e){for(var i=0;4>i;)this.fleets[i].summaryCalc(!0),i++;this.save()}}},{key:"url",get:function(){if(this.data._id){var e=$.extend(!0,{},this.data),t=e._id;return delete e._id,delete e.time_create,delete e.time_modify,delete e.rating,delete e.user,"http://fleet.diablohu.com/fleets/build/?i="+t+"&d="+LZString.compressToEncodedURIComponent(JSON.stringify(e))}}}]),e}();InfosFleet.modalExport=function(e){return InfosFleet.elModalExport||(InfosFleet.elModalExport=$("<div/>").append(InfosFleet.elModalExportTextarea=$("<textarea/>",{readonly:!0})).append($('<p class="note-codeusage"/>').html('* 该配置代码可用于<a href="http://www.kancolle-calc.net/deckbuilder.html">艦載機厨デッキビルダー</a>')).append($('<button class="button"/>').html("复制到剪切板").on("click",function(){node.clipboard.set(InfosFleet.elModalExportTextarea.val(),"text")}))),InfosFleet.elModalExportTextarea.val(e||""),InfosFleet.elModalExport},InfosFleet.modalExport_show=function(e){e=InfosFleet.decompress(e.data||[]),e=JSON.stringify(_g.kancolle_calc.encode(e)),
_frame.modal.show(InfosFleet.modalExport(e),"导出配置代码",{classname:"infos_fleet infos_fleet_export",detach:!0})},InfosFleet.modalExportText_show=function(e){if(!e)return!1;var t="",i=InfosFleet.decompress(e.data).filter(function(e){return e&&e.length})||[];t+=e.name||"",i.forEach(function(e,n){t+=(t?"\n":"")+(i.length>1?"\n第 "+(n+1)+" 舰队":""),e.filter(function(e){return e&&e[0]&&e.length>0}).forEach(function(e,i){t+="\n("+(n?n+1+"-":"")+(i+1)+")"+_g.data.ships[e[0]]._name+(e[1]&&e[1][0]?" Lv."+e[1][0]:"");var a=e[2]||[],o=e[3]||[],s=e[4]||[];a.filter(function(e){return e}).forEach(function(e,i){t+=(i?", ":" | ")+_g.data.items[e]._name+(o[i]?"★"+o[i]:"")+(s[i]?"["+_g.textRank[s[i]]+"]":"")})})}),t+=(t?"\n\n":"")+"* 创建自 是谁呼叫舰队 (fleet.diablohu.com)",_frame.modal.show(InfosFleet.modalExport(t),"导出配置文本",{classname:"infos_fleet infos_fleet_export mod-text",detach:!0})},InfosFleet.modalRemove_show=function(e,t){if("undefined"!=typeof e){var i=void 0;_instanceof(e,InfosFleet)&&(i=e,e=i.data._id),InfosFleet.elModalRemove||(InfosFleet.elModalRemove=$("<form/>").append(InfosFleet.elModalRemoveId=$('<input name="id" type="hidden"/>')).append($("<p/>").html("是否删除该舰队配置？")).append($('<p class="actions"/>').append($("<button/>",{type:"submit","class":"button",html:"是"})).append($("<button/>",{type:"button","class":"button",html:"否"}).on("click",function(){_frame.modal.hide()}))).on("submit",function(e){e.preventDefault();var i=InfosFleet.elModalRemoveId.val();return i&&(_frame.app_main.loading_start("remove_fleet_"+i,!1),_db.fleets.remove({_id:i},{multi:!0},function(e,n){_g.log("Fleet "+i+" removed."),_frame.app_main.loading_complete("remove_fleet_"+i),_frame.modal.hide(),_g.badgeMsg("已删除配置"),t&&_instanceof(t,TablelistFleets)?t.refresh():_frame.dom.navs.fleets.click()})),!1})),InfosFleet.elModalRemoveId.val(e),_frame.modal.show(InfosFleet.elModalRemove,"删除配置",{classname:"infos_fleet infos_fleet_remove",detach:!0})}},InfosFleet.clean=function(e){function t(e){e&&e.length&&e.forEach(function(i,n){i&&i.push?t(i):n==e.length-1&&null===i&&(e.pop(),t(e))})}if(e)return t(e),e},InfosFleet.decompress=function(e){if(e&&!e.push)try{e=JSON.parse(LZString.decompressFromEncodedURIComponent(e))}catch(t){_g.error(t)}return e},InfosFleet.compress=function(e){if(e&&e.push)try{e=LZString.compressToEncodedURIComponent(JSON.stringify(e))}catch(t){_g.error(t)}return e},InfosFleet.compressMetaData=function(e){if(e&&e.data&&e.data.push)try{e.data=InfosFleet.compress(e.data)}catch(t){_g.error(t)}return e},InfosFleet.decompressMetaData=function(e){if(e&&e.data&&!e.data.push)try{e.data=InfosFleet.decompress(e.data)}catch(t){_g.error(t)}return e};var InfosFleetSubFleet=function(){function e(t,i,n){_classCallCheck(this,e),i=i||[],this.data=i,this.el=$('<dl class="fleetships"/>'),this.ships=[];for(var a=0;6>a;)this.ships[a]=new InfosFleetShip(t,this,a),this.ships[a].getEl().appendTo(this.el),a++;this.elSummary=$('<span class="summary"/>').appendTo(this.el).append($('<span class="summary-item"/>').html("航速").append(this.elSummarySpeed=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("制空战力").append(this.elSummaryFighterPower=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("索敌能力").append(this.elSummaryLos=$("<strong/>").html("-"))).append($('<span class="summary-item summary-item-consummation"/>').html("总消耗").append(this.elSummaryConsummation=$("<strong/>").html("-"))),this.infosFleet=t,this.updateEl(),$body.on("update_defaultHqLv.fleet"+t.data._id+"-"+(n+1),function(){this.infosFleet.is_showing&&this.summaryCalc(!0)}.bind(this))}return _createClass(e,[{key:"updateEl",value:function(e){this.data=e||this.data,e&&e.forEach(function(e,t){this.ships[t].updateEl(e)},this)}},{key:"getData",value:function(){return this.data}},{key:"summaryCalc",value:function(e){return this.summaryCalculating?!1:void(this.summaryCalculating=setTimeout(function(){var t=this;e||!function(){var e=[0,0],i="fast",n=0,a=0;if(t.ships.forEach(function(t){if(t.data[0]){var o=_g.data.ships[t.data[0]];o.stat.speed<10&&(i="slow"),t.calculate("fighterPower_v2").forEach(function(t,i){e[i]+=t>0?t:0}),n+=o.getAttribute("fuel",t.shipLv)||0,a+=o.getAttribute("ammo",t.shipLv)||0}}),t.elSummarySpeed.html("fast"==i?"高速":"低速"),Math.max(e[0],e[1])>0){var o=Math.floor(e[0]),s=Math.floor(e[1]);t.elSummaryFighterPower.html(o==s?o:o+"~"+s),t.elSummaryFighterPower.removeClass("empty")}else t.elSummaryFighterPower.html("-"),t.elSummaryFighterPower.addClass("empty");t.elSummaryConsummation.html(n||a?'<span class="fuel">'+n+'</span><span class="ammo">'+a+"</span>":"-")}();var i=this.summaryCalcLos();if(i.y_estimate&&i.y_std_error){var n=(i.y_estimate-i.y_std_error).toFixed(1),a=(i.y_estimate+i.y_std_error).toFixed(1);0>n&&(n=0),0>a&&(a=0),this.elSummaryLos.html(n==a?n:n+"~"+a)}this.summaryCalculating=null}.bind(this),10))}},{key:"summaryCalcLos",value:function(){var e=this.infosFleet.data.hq_lv||Lockr.get("hqLvDefault",_g.defaultHqLv);0>e&&(e=Lockr.get("hqLvDefault",_g.defaultHqLv));var t={DiveBombers:0,TorpedoBombers:0,CarrierRecons:0,SeaplaneRecons:0,SeaplaneBombers:0,SmallRadars:0,LargeRadars:0,Searchlights:0,statLos:0,hqLv:e};return this.ships.forEach(function(e){if(e&&e.shipId){var i=e.data[2].map(function(e){return e?_instanceof(e,Equipment)?e:_g.data.items[e]:null})||[];i.forEach(function(e){if(e)for(var i in t)Formula.equipmentType[i]&&Formula.equipmentType[i].push&&Formula.equipmentType[i].indexOf(e.type)>-1&&(t[i]+=e.stat.los)});var n=e.shipLv||1,a=_g.data.ships[e.shipId].getAttribute("los",n)||1;0>n&&(n=1),0>a&&(a=1),t.statLos+=Math.sqrt(a)}}),Formula.calc.losPower(t)}},{key:"save",value:function(){var e=!0;this.data=this.data||[],this.ships.forEach(function(t,i){this.data[i]=t.data,t.data[0]&&(e=!1)},this),e&&(this.data=null),this.infosFleet&&this.infosFleet.save()}}]),e}(),InfosFleetShip=function(){function e(t,i,n,a){return _classCallCheck(this,e),this.el?this.el:(a=a||[null,[null,-1],[],[],[]],this.data=a,this.infosFleet=t,this.infosFleetSubFleet=i,this.equipments=[],this.index=n,this.el=$('<dd class="ship"/>').append($("<dt/>").append(this.elAvatar=$('<s touch-action="none"/>')).append(this.elInfos=$("<div/>").html("<span>"+(this.infosFleet.data._id?"选择舰娘":"无舰娘")+"...</span>").append(this.elInfosTitle=$('<div class="title"/>')).append($('<div class="info"/>').append($("<label/>").html("Lv.").append(this.elInputLevel=$("<input/>",{type:"number",min:0,max:_g.shipMaxLv}).on({change:function(e){var t=this.elInputLevel.val();"undefined"!=typeof t&&""!==t||!this.data[1][0]||(this.shipLv=null),t=parseInt(t),0>t?(t=0,this.elInputLevel.val(0)):t>_g.shipMaxLv&&(t=_g.shipMaxLv,this.elInputLevel.val(_g.shipMaxLv)),isNaN(t)||this.data[1][0]==t||(this.shipLv=t)}.bind(this),input:function(){this.elInputLevel.trigger("change")}.bind(this)}))).append(this.elInfosInfo=$("<span/>"))))).append($('<div class="equipments"/>').append(function(){for(var e=$(),t=0;4>t;t++)this.equipments[t]=new InfosFleetShipEquipment(this,t),e=e.add(this.equipments[t].el);return e}.bind(this))).append($('<div class="attributes"/>').append(this.elAttrShelling=$('<span class="shelling"/>')).append(this.elAttrTorpedo=$('<span class="torpedo"/>')).append(this.elAttrHitSum=$('<span class="hitsum"/>')).append(this.elAttrHp=$('<span class="hp"/>')).append(this.elAttrArmor=$('<span class="armor"/>')).append(this.elAttrEvasion=$('<span class="evasion"/>')).append(this.elAttrNightBattle=$('<span class="nightbattle" data-text="夜战"/>')).append(_huCss.csscheck_full("mask-image")?null:$('<div class="bg"/>'))).append($('<div class="options"/>').append(this.elBtnOptions=$('<button class="options"/>').on("click",function(e){this.showMenu()}.bind(this)))),this.after=$("<s/>"),this.els=this.el.add(this.after),this.infosFleet.data._id?(this.el.on({click:function(){this.data[0]||this.selectShipStart()}.bind(this),pointerenter:function(){e.dragEnter(this)}.bind(this)}),this.elAvatar.on({pointerdown:function(t){t.preventDefault(),this.data[0]&&(document.activeElement.blur(),e.dragStart(this))}.bind(this)})):this.elInputLevel.prop("readonly",!0),void(_huCss.csscheck_full("mask-image")||this.el.addClass("mod-nomask")))}return _createClass(e,[{key:"getEl",value:function(){return this.els}},{key:"selectShipStart",value:function(){_g.log("开始选择舰娘"),_frame.app_main.load_page("ships",{callback_modeSelection_select:function(e){history.back(),this.shipId=e,this.shipLv=null,this.infosFleet&&_frame.infos.dom.main.attr("data-theme",this.infosFleet.data.theme)}.bind(this)})}},{key:"changeLuck",value:function(e){this.data[1][1]=e||-1}},{key:"updateAttrs",value:function(){this.elAttrShelling.html(this.calculate("shellingDamage")),this.elAttrTorpedo.html(this.calculate("torpedoDamage"));var e=this.calculate("addHit");e>=0?this.elAttrHitSum.removeClass("negative"):this.elAttrHitSum.addClass("negative"),this.elAttrHitSum.html(e),this.elAttrHp.html(this.calculate("attribute","hp")),this.elAttrArmor.html(this.calculate("attribute","armor")+this.calculate("addArmor"));var t=this.shipLv?this.calculate("attribute","evasion"):-1;this.elAttrEvasion.html(t>=0?t+this.calculate("addEvasion"):"-"),this.elAttrNightBattle.html(this.calculate("nightBattle"))}},{key:"calculate",value:function(e,t){if(!this.shipId)return"-";if("attribute"==e)return _g.data.ships[this.shipId].getAttribute(t,this.shipLv);if(Formula[e])switch(e){case"losPower":return Formula[e](this.shipId,this.data[2],this.data[3],this.data[4],{hqLv:this.infosFleet.data.hq_lv,shipLv:this.shipLv});default:return Formula[e](this.shipId,this.data[2],this.data[3],this.data[4])}return"-"}},{key:"updateEl",value:function(e){this._updating=!0,this.data=e||this.data,"string"==typeof this.data[0]&&(this.data[0]=parseInt(this.data[0])),this.data[2]||(this.data[2]=[]),this.data[3]||(this.data[3]=[]),this.data[4]||(this.data[4]=[]),this.data[0]&&(this.shipId=this.data[0]),this.data[1][0]&&(this.shipLv=this.data[1][0]);for(var t=0;4>t;t++)this.equipments[t].id=this.data[2][t],this.equipments[t].star=this.data[3][t],this.equipments[t].rank=this.data[4][t];this.updateAttrs(),this._updating=!1}},{key:"getData",value:function(){return this.data}},{key:"showMenu",value:function(){e.menuCurObj=this,e.menu||(e.menuItems=[$('<menuitem class="move move-up"/>').html(" ").on({click:function(t){e.menuCurObj.moveUp()},show:function(){e.menuCurObj.index?e.menuItems[0].removeClass("disabled"):e.menuItems[0].addClass("disabled")}}),$('<menuitem class="move move-down"/>').html(" ").on({click:function(t){e.menuCurObj.moveDown()},show:function(){e.menuCurObj.index<5?e.menuItems[1].removeClass("disabled"):e.menuItems[1].addClass("disabled")}}),$("<hr/>"),$("<menuitem/>").html("查看资料").on({show:function(){e.menuItems[3].attr("data-infos","[[SHIP::"+e.menuCurObj.shipId+"]]")}}),$("<menuitem/>").html("移除").on({click:function(t){e.menuCurObj.shipId=null}}),$("<menuitem/>").html("替换为 ...").on({click:function(t){e.menuCurObj.selectShipStart()}}),$("<div/>").on("show",function(){var t=e.menuItems[6].empty();if(e.menuCurObj.shipId){var i=_g.data.ships[e.menuCurObj.shipId].getSeriesData()||[];i.length>1&&i.forEach(function(i,n){n||t.append($("<hr/>")),i.id!=e.menuCurObj.shipId&&t.append($("<menuitem/>").html("替换为 "+_g.data.ships[i.id].getName(!0)).on({click:function(){e.menuCurObj.shipId=i.id}}))})}})],e.menu=new _menu({className:"contextmenu-ship",items:e.menuItems})),e.menu.show(this.elBtnOptions)}},{key:"swap",value:function(e,t){"number"==typeof e&&(e=this.infosFleetSubFleet.ships[e]),this.index>e.index?this.el.insertBefore(e.el):this.el.insertAfter(e.after),this.after.insertAfter(this.el);var i=e.index,n=this.index;console.log(i,n),this.index=i,e.index=n,this.infosFleetSubFleet.ships[i]=this,this.infosFleetSubFleet.ships[n]=e,t&&this.save()}},{key:"moveUp",value:function(){this.index<=0||this.swap(this.index-1,!0)}},{key:"moveDown",value:function(){this.index>=5||this.swap(this.index+1,!0)}},{key:"save",value:function(){return this._updating?!1:void(this._updateTimeout||(this._updateTimeout=setTimeout(function(){this.updateAttrs(),this.infosFleetSubFleet&&(this.infosFleetSubFleet.summaryCalc(),this.infosFleetSubFleet.save()),this._updateTimeout=null}.bind(this),50)))}},{key:"shipId",get:function(){return this.data[0]},set:function(e){if(e!=this.data[0]&&(this.data[0]=e,this.shipLv=null),e){var t=_g.data.ships[e],i=t.getSuffix(),n=t._speed,a=t._type;a=a.replace(n,""),this.el.attr("data-shipId",e),this.elAvatar.html('<img src="'+t.getPic(10)+'"/>'),this.elInfosTitle.html('<h4 data-content="'+t.name[_g.lang]+'">'+t.name[_g.lang]+"</h4>"+(i?'<h5 data-content="'+i+'">'+i+"</h5>":"")),this.elInfosInfo.html(n+" "+a);for(var o=0;4>o;o++)this.equipments[o].carry=t.slot[o],this._updating||(this.equipments[o].id=null,this.equipments[o].star=null,this.equipments[o].rank=null)}else this.el.removeAttr("data-shipId"),this.elAvatar.html(""),this.data[2]=[],this.data[3]=[],this.data[4]=[];this.save()}},{key:"shipLv",get:function(){return this.data[1][0]},set:function(e){this.data[1][0]=e||null,e&&e>0?this.elInputLevel.val(e):this.elInputLevel.val(""),this.save()}}]),e}();InfosFleetShip.dragStart=function(e){return InfosFleetShip.dragging||!e?!1:(InfosFleetShip.dragging=e,e.el.addClass("moving"),void(InfosFleetShip.isInit||($body.on({"pointerup.InfosFleetShip_dragend pointercancel.InfosFleetShip_dragend":function(){InfosFleetShip.dragging&&(InfosFleetShip.dragging.el.removeClass("moving"),InfosFleetShip.dragging.save(),InfosFleetShip.dragging=null)}}),InfosFleetShip.isInit=!0)))},InfosFleetShip.dragEnter=function(e){return InfosFleetShip.dragging&&e&&InfosFleetShip.dragging!=e?void InfosFleetShip.dragging.swap(e):!1};var InfosFleetShipEquipment=function(){function e(t,i){return _classCallCheck(this,e),this.index=i||0,this.infosFleetShip=t,this.el?this.el:void(this.el=$('<div class="equipment" tabindex="0"/>').on({focus:function(){e.cur=this.el.addClass("is-hover")}.bind(this),blur:function(){this.el.removeClass("is-hover"),e.cur=null}.bind(this),pointerenter:function(t){"touch"!=t.originalEvent.pointerType&&(e.cur=this.el.addClass("is-hover"))}.bind(this),pointerleave:function(t){"touch"!=t.originalEvent.pointerType&&(this.el.removeClass("is-hover").blur(),e.cur=null)}.bind(this)}).append(this.elCarry=$('<div class="equipment-layer equipment-add"/>').on("click",function(){this.selectEquipmentStart()}.bind(this))).append($('<div class="equipment-layer equipment-infos"/>').append(this.elName=$('<span class="equipment-name"/>')).append(this.elStar=$('<span class="equipment-star"/>').html(0)).append(this.elRank=$('<span class="equipment-rank"/>')).append(function(){var e=$('<span class="equipment-carry"/>').html(0);return this.elCarry=this.elCarry.add(e),e}.bind(this))).append($('<div class="equipment-layer equipment-options"/>').append(this.elInputStar=$("<input/>",{"class":"equipment-starinput",type:"number",placeholder:0}).on({input:function(){var e=this.elInputStar.val();"undefined"!=typeof e&&""!==e||!this.star||(this.star=null),e=parseInt(e),isNaN(e)||this.star==e||(this.star=e)}.bind(this),focus:function(){this.el.addClass("is-hover"),console.log("focus")}.bind(this),blur:function(){setTimeout(function(){this.el.is(":focus")||this.el.removeClass("is-hover")}.bind(this),10)}.bind(this)})).append(this.elSelectRank=$("<div/>",{"class":"equipment-rankselect",html:"<span>无</span>"}).on("click",function(){if(!InfosFleet.menuRankSelect){InfosFleet.menuRankSelectItems=$("<div/>");for(var e=function(e){$('<button class="rank-'+e+'"/>').html(e?"":"无").on("click",function(){InfosFleet.menuRankSelectCur.rank=e}).appendTo(InfosFleet.menuRankSelectItems)},t=0;8>t;t++)e(t);InfosFleet.menuRankSelect=new _menu({className:"contextmenu-infos_fleet_rank_select",items:[InfosFleet.menuRankSelectItems]})}InfosFleet.menuRankSelectCur=this,InfosFleet.menuRankSelect.show(this.elSelectRank)}.bind(this))).append(this.elButtonInspect=$('<span class="button inspect" icon="search"/>').on("click",function(){this.id&&_frame.infos.show("[[EQUIPMENT::"+this.id+"]]")}.bind(this))).append($('<span class="button change" icon="loop"/>').on("click",function(){this.selectEquipmentStart()}.bind(this))).append($('<span class="button remove"/>').on("click",function(){this.id=null}.bind(this)))))}return _createClass(e,[{key:"getEl",value:function(){return this.el}},{key:"selectEquipmentStart",value:function(){_g.log("开始选择装备"),_frame.app_main.load_page("equipments",{callback_modeSelection_select:function(e){history.back(),this.id=e,this.star=0,this.rank=Lockr.get("fleetlist-option-aircraftdefaultmax")&&e&&_g.data.items[e].rankupgradable&&$.inArray(_g.data.items[e].type,Formula.equipmentType.Aircrafts)>-1?7:0,this.infosFleetShip.infosFleet&&_frame.infos.dom.main.attr("data-theme",this.infosFleetShip.infosFleet.data.theme)}.bind(this),callback_modeSelection_enter:function(){TablelistEquipments.types=_g.data.ships[this.infosFleetShip.shipId].getEquipmentTypes(),TablelistEquipments.shipId=this.infosFleetShip.shipId,_frame.app_main.page.equipments.object.tablelistObj.apply_types()}.bind(this)})}},{key:"getData",value:function(){return this.data}},{key:"save",value:function(){return this._updating?!1:void(this.infosFleetShip&&this.infosFleetShip.save())}},{key:"id",get:function(){return this.infosFleetShip.data[2][this.index]},set:function(e){e=parseInt(e)||null,_p.tip.hide(),this.el.removeData(["tip","tip-filtered"]),e!=this.infosFleetShip.data[2][this.index]&&(this.star=0),e&&!isNaN(e)?(this.infosFleetShip.data[2][this.index]=e,this.improvable=_g.data.items[e].improvable||!1,this.el.attr({"data-equipmentid":e,"data-tip":"[[EQUIPMENT::"+e+"]]","touch-action":"none"}).css("background-image","url("+_g.data.items[e]._icon+")"),this.elName.html(_g.data.items[e]._name),$.inArray(_g.data.items[e].type,Formula.equipmentType.Aircrafts)>-1?(this.el.addClass("is-aircraft"),_g.data.items[e].rankupgradable&&this.el.addClass("is-rankupgradable")):this.el.removeClass("is-aircraft is-rankupgradable")):(this.infosFleetShip.data[2][this.index]=null,this.improvable=!1,this.el.removeAttr("data-equipmentId").removeAttr("data-tip").removeAttr("data-star").removeAttr("data-rank").removeAttr("touch-action").css("background-image","").removeClass("is-aircraft is-rankupgradable"),this.elName.html("")),this.infosFleetShip.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"star",get:function(){return this.infosFleetShip.data[3][this.index]},set:function(e){this._improvable?(e=parseInt(e)||null,e>10&&(e=10),0>e&&(e=0),e?(this.infosFleetShip.data[3][this.index]=e,this.elInputStar.val(e),this.elStar.html(e),this.el.attr("data-star",e)):(this.infosFleetShip.data[3][this.index]=null,this.elInputStar.val(""),this.elStar.html(0),this.el.attr("data-star",""))):(this.infosFleetShip.data[3][this.index]=null,this.el.removeAttr("data-star")),this.infosFleetShip.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"rank",get:function(){return this.infosFleetShip.data[4][this.index]},set:function(e){this.id&&$.inArray(_g.data.items[this.id].type,Formula.equipmentType.Aircrafts)>-1?(e=parseInt(e)||null,e>7&&(e=7),0>e&&(e=0),e?(this.infosFleetShip.data[4][this.index]=e,this.el.attr("data-rank",e)):(this.infosFleetShip.data[4][this.index]=null,this.el.attr("data-rank",""))):(this.infosFleetShip.data[4][this.index]=null,this.el.removeAttr("data-rank")),this.infosFleetShip.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"carry",set:function(e){"undefined"==typeof e?(this.el.removeAttr("data-carry"),this.elCarry.html(0)):(e=parseInt(e)||0,this.el.attr("data-carry",e),this.elCarry.html(e))}},{key:"improvable",set:function(e){e?(this.el.attr("data-star",""),this.elInputStar.prop("disabled",!1).attr("placeholder","0"),this._improvable=!0):(this.el.removeAttr("data-star"),this.elInputStar.prop("disabled",!0).attr("placeholder","--"),this._improvable=!1)}}]),e}();_frame.app_main.is_mode_selection=function(){return $html.hasClass("mode-selection")||_frame.dom.layout.hasClass("mode-selection")},_frame.app_main.mode_selection_callback=null,_frame.app_main.mode_selection_on=function(e){_frame.dom.navSelectionInfo||(_frame.dom.navSelectionInfo=$('<div class="selection-info"/>').html("请选择……").appendTo(_frame.dom.nav)),e=e||function(){},e(),_frame.dom.layout.addClass("mode-selection")},_frame.app_main.mode_selection_off=function(){this.cur_page&&this.page_dom[this.cur_page].trigger("modeSelectionExit"),_frame.dom.layout.removeClass("mode-selection")},"undefined"!=typeof _p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[EQUIPMENT\:\:([0-9]+)\]\]$/.exec(e);return t&&t.length>1?_p.tip.content_equipment(_g.data.items[parseInt(t[1])]):void 0}),_p.tip.content_equipment=function(e){function t(t,i){if(!e.stat[t])return"";switch(t){case"range":return"<span>射程: "+_g.getStatRange(e.stat[t])+"</span>";default:var n=parseInt(e.stat[t]);return"<span>"+(n>0?"+":"")+n+" "+i+"</span>"}}var i=e.getName();return'<h3 class="itemstat"><s class="equiptypeicon mod-'+e.getIconId()+'"></s><strong data-content="'+i+'">'+i+"</strong><small>"+_g.data.item_types[e.type].name.zh_cn+"</small></h3>"+t("fire","火力")+t("torpedo","雷装")+t("aa","对空")+t("asw","对潜")+t("bomb","爆装")+t("hit","命中")+t("armor","装甲")+t("evasion","回避")+t("los","索敌")+t("range","射程")}),"undefined"!=typeof _p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[SHIP\:\:([0-9]+)\]\]$/.exec(e);return t&&t.length>1?_p.tip.content_ship(_g.data.ships[parseInt(t[1])]):void 0}),_p.tip.content_ship=function(e){var t=e.getName(_g.joint),i='<h3 class="shipinfo"><img src="'+_g.path.pics.ships+"/"+e.id+'/0.png" width="160" height="40"/><strong data-content="'+t+'">'+t+"</strong>"+(e.type?"<small>"+_g.data.ship_types[e.type].full_zh+"</span>":"")+"</h3>";return i}),_p.el.tablelist={init_el:function(e){return e.data("tablelist")?!0:void(e.hasClass("ships")?e.data({tablelist:new TablelistShips(e)}):e.hasClass("tablelist-equipments")?e.data({tablelist:new TablelistEquipments(e)}):e.hasClass("fleets")?e.data({tablelist:new TablelistFleets(e)}):e.hasClass("entities")&&e.data({tablelist:new TablelistEntities(e)}))},init:function(e,t){e=e||$body,t=t||e.find(".tablelist"),t.each(function(){_p.el.tablelist.init_el($(this))})}};var Tablelist=function(){function e(t,i){_classCallCheck(this,e),this.dom={container:t},i=i||{},this._index=e.index++,this.trIndex=0,this.flexgrid_empty_count=i.flexgrid_empty_count||8,this.sort_data_by_stat=i.sort_data_by_stat||{},this.sort_default_order_by_stat=i.sort_default_order_by_stat||{},t.on("mouseenter.hovercolumn",".tablelist-body dd",this.hovercolumn_delegate.bind(this)).on("mouseleave.hovercolumn",".tablelist-body dd",this.hovercolumn_delegate_leave.bind(this))}return _createClass(e,[{key:"append_option",value:function(t,i,n,a,o,s){function r(){var n=void 0,o=void 0,r=void 0,l=e.genId();switch(t){case"text":case"number":case"hidden":n=$('<input type="'+t+'" name="'+i+'" id="'+l+'" />').val(a);break;case"select":n=$('<select name="'+i+'" id="'+l+'" />'),o=$('<option value=""/>').html("").appendTo(n),a.forEach(function(e,t){r="object"==("undefined"==typeof e?"undefined":_typeof(e))?$('<option value="'+("undefined"==typeof e.val?e.value:e.val)+'"/>').html(e.title||e.name).appendTo(n):$('<option value="'+e+'"/>').html(e).appendTo(n),"undefined"!=typeof s["default"]&&r.val()==s["default"]&&r.prop("selected",!0)}),a&&a.length||(o.remove(),$('<option value=""/>').html("...").appendTo(n)),s["new"]&&($('<option value=""/>').html("==========").insertAfter(o),$('<option value="___new___"/>').html("+ 新建").insertAfter(o),n.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),s["new"](n))}));break;case"checkbox":n=$('<input type="'+t+'" name="'+i+'" id="'+l+'" />').prop("checked",a);break;case"radio":n=$(),a.forEach(function(e,t){var o,r,d=!1;a[t].push?(r=a[t][0],o=a[t][1]):(r=a[t].val||a[t].value,o=a[t].title||a[t].name),s.radio_default&&s.radio_default==r&&(d=!0),n=n.add($('<input type="radio" name="'+i+'" id="'+l+"-"+r+'" ischecked="'+d+'" />').val(r).prop("checked",d||!d&&0==t)),n=n.add($('<label for="'+l+"-"+r+'"/>').html(o))})}return s.required&&n.prop("required",!0),s.onchange&&(n.on("change.___onchange___",function(e){s.onchange(e,$(this))}),s["default"]&&n.trigger("change")),i||n.attr("name",null),n}s=s||{};var l=$("<p/>").addClass(i).appendTo(this.dom.filters),d=r().appendTo(l),u=d.attr("id")||e.genId();return n=n?$("<label"+("checkbox"==t?' class="checkbox"':"")+' for="'+u+'"/>').html(n).appendTo(l):null,"checkbox"==t&&n&&n.insertAfter(d),o&&$('<label for="'+u+'"/>').html(o).appendTo(l),l}},{key:"thead_redraw",value:function(e){}},{key:"sort_column",value:function(e,t,i){if(!i){var n=this.dom.tbody;n&&n.length||(n=this.dom.table.children(".tablelist-body")),i=n.children("dl:visible:not([data-donotcompare])")}e=e||1,this._tmp_values=[],this._tmp_value_map_cell={},i.children("dd:nth-of-type("+e+")").each(function(e,t){var i=$(t),n=i.attr("value");n=parseFloat(n),$.inArray(n,this._tmp_values)<0&&this._tmp_values.push(n),this._tmp_value_map_cell[n]||(this._tmp_value_map_cell[n]=$()),this._tmp_value_map_cell[n]=this._tmp_value_map_cell[n].add(i)}.bind(this)),this._tmp_values.sort(function(e,i){return t?e-i:i-e});var a=[];return this._tmp_values.forEach(function(e){a.push(this._tmp_value_map_cell[e])},this),delete this._tmp_values,delete this._tmp_value_map_cell,a}},{key:"mark_high",value:function(e){var t=this.dom.tbody;t&&t.length||(t=this.dom.table.children(".tablelist-body"));var i=t.children("dl:visible:not([data-donotcompare])");return i.children("dd[value]").removeClass("sort-first sort-second"),i.eq(0).children("dd[value]").each(function(t,n){var a=!1,o=$(n),s=o.attr("stat"),r=s.match(/\b(speed|range|extra_illust)\b/);"undefined"==typeof this.sort_default_order_by_stat[s]?(s.match(/\b(consum_fuel|consum_ammo)\b/)&&(a=!0),this.sort_default_order_by_stat[s]=a?"asc":"desc"):a="asc"==this.sort_default_order_by_stat[s]?!0:!1;var l=this.sort_column(t+1,a,i),d=Math.min(6,Math.ceil(i.length/2)+1);!r&&l.length>1&&l[0].length<d&&(l[0].addClass("sort-first"),l.length>2&&l[1].length<d&&l[1].addClass("sort-second")),e?this.sort_data_by_stat[s]=l:delete this.sort_data_by_stat[s]}.bind(this)),i}},{key:"sort_table_from_theadcell",value:function(e){if(e){var t=e.attr("stat"),i=this.sort_data_by_stat[t];if(console.log(t,i),!t||!i)return!1;t!=this.lastSortedStat&&(this.lastSortedHeader&&this.lastSortedHeader.removeClass("sorting desc asc"),e.addClass("sorting"));var n=t==this.lastSortedStat&&"obverse"==this.lastSortedOrder?"reverse":"obverse",a="reverse"==n?i.length-1:0;if(this.sort_default_order_by_stat[t]){var o="asc"==this.sort_default_order_by_stat[t]?"desc":"asc";"obverse"==n?e.removeClass(o).addClass(this.sort_default_order_by_stat[t]):e.removeClass(this.sort_default_order_by_stat[t]).addClass(o)}for(this.sortedRow=$();i[a];)this._tmpDOM=i[a].parent(),this.sortedRow=this.sortedRow.add(this._tmpDOM),this._tmpDOM.appendTo(this.dom.tbody),a="reverse"==n?a-1:a+1;this.dom.btn_compare_sort.removeClass("disabled").html("取消排序"),this.lastSortedStat=t,this.lastSortedOrder=n,this.lastSortedHeader=e,delete this._tmpDOM}}},{key:"sort_table_restore",value:function(){if(!this.sortedRow)return!0;var e=void 0,t=[];return this.sortedRow.each(function(i,n){var a=$(n),o=parseInt(a.attr("trindex"));e=e||a.parent(),t.push({index:o,el:a,prev:e.children('[trindex="'+(o-1)+'"]')})}),t.sort(function(e,t){return e.index-t.index}),t.forEach(function(e){e.el.insertAfter(e.prev)}),this.dom.btn_compare_sort.addClass("disabled").html("点击表格标题可排序"),this.lastSortedHeader.removeClass("sorting desc asc"),delete this.sortedRow,delete this.lastSortedStat,delete this.lastSortedOrder,delete this.lastSortedHeader,!0}},{key:"hovercolumn_delegate",value:function(e){if(!$body_preventMouseover&&e&&e.originalEvent.path&&this.dom.tbody){var t=e.currentTarget.getAttribute("data-index");if(t)t=parseInt(t);else{var i=$(e.currentTarget);t=i.index(),i.attr("data-index",t)}this.dom.tbody.find("dl:visible dd:nth-child("+(t+1)+")").addClass("is-hover")}}},{key:"hovercolumn_delegate_leave",value:function(e){!$body_preventMouseover&&e&&e.originalEvent.path&&this.dom.tbody&&(this.dom.tbody.find("dd.is-hover").removeClass("is-hover"),_p.el.tablelist.hovercolumn_mouseleave_delay=null)}}]),e}();Tablelist.index=0,Tablelist.genId=function(e){var t,i,n,a=0;if(e=e||(new Date).toISOString()+_g.randInt(1e4),0==e.length)return a;for(t=0,n=e.length;n>t;t++)i=e.charCodeAt(t),a=(a<<5)-a+i,a|=0;return"tablelist"+a};var TablelistEntities=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,i));return _frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,e.children(".tablelist-list").length?n.init_parse():n.init_new&&n.init_new(i),n}return _inherits(t,e),_createClass(t,[{key:"init_parse",value:function(){this.generated=!0,_frame.app_main.loaded("tablelist_"+this._index,!0)}}]),t}(Tablelist),TablelistShips=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,i));return n.columns=["  ",["火力","fire"],["雷装","torpedo"],["夜战","nightpower"],["对空","aa"],["对潜","asw"],["耐久","hp"],["装甲","armor"],["回避","evasion"],["搭载","carry"],["航速","speed"],["射程","range"],["索敌","los"],["运","luck"],["油耗","consum_fuel"],["弹耗","consum_ammo"],["多立绘","extra_illust"]],n.header_checkbox=[],n.mode_selection_filters=$(),n.rows=$(),n.rowsById={},_frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,e.children(".tablelist-container").length&&n.init_parse(),n}return _inherits(t,e),_createClass(t,[{key:"compare_btn_show",value:function(e){!e&&this.rows.filter('[compare="true"]').length||e?this.dom.msg_container.attr("data-msgs","comparestart"):this.dom.msg_container.removeAttr("data-msgs")}},{key:"compare_start",value:function(){this.dom.msg_container.removeAttr("data-msgs"),this.last_viewtype=this.dom.filter_container.attr("viewtype"),_config.set("shiplist-viewtype",this.last_viewtype),this.last_scrollTop=this.dom.tbody.scrollTop(),this.dom.filter_container.attr("viewtype","compare"),this.dom.tbody.scrollTop(0),this.dom.table.addClass("sortable"),this.mark_high(!0),this.thead_redraw(500)}},{key:"compare_off",value:function(){this.dom.filter_container.attr("viewtype",this.last_viewtype),this.sort_table_restore(),this.mark_high(),this.thead_redraw(500),this.dom.tbody.scrollTop(this.last_scrollTop),this.dom.table.removeClass("sortable"),delete this.last_viewtype,delete this.last_scrollTop}},{key:"compare_end",value:function(){this.rows.filter('[compare="true"]').each(function(e,t){this.check(t,!1)}.bind(this)),this.dom.msg_container.removeAttr("data-msgs"),this.compare_off()}},{key:"compare_continue",value:function(){this.dom.msg_container.attr("data-msgs","comparestart"),this.compare_off()}},{key:"contextmenu_show",value:function(e,i,n){return"compare"==this.dom.filter_container.attr("viewtype")||"true"==e.attr("data-donotcompare")?!1:(t.contextmenu||(t.contextmenu=new _menu({className:"contextmenu-ship",items:[$("<menuitem/>").html("选择").on({click:function(e){_frame.app_main.is_mode_selection()&&_frame.app_main.mode_selection_callback(t.contextmenu._curid)},show:function(){_frame.app_main.is_mode_selection()?$(this).show():$(this).hide()}}),$("<menuitem/>").html("查看资料").on({click:function(e){t.contextmenu._curel.trigger("click",[!0])}}),$("<menuitem/>").html("将该舰娘加入对比").on({click:function(e){this.check(this.rowsById[t.contextmenu._curid])}.bind(this),show:function(e){return t.contextmenu._curid?(_g.data.ship_types[_g.data.ships[t.contextmenu._curid].type].donotcompare?$(e.target).hide():$(e.target).show(),void("true"===this.rowsById[t.contextmenu._curid].attr("compare")?$(e.target).html("取消对比"):$(e.target).html("将该舰娘加入对比"))):!1}.bind(this)}),$("<div/>").on("show",function(e){var i=$(e.target).empty();if(t.contextmenu._curid){var n=_g.data.ships[t.contextmenu._curid].getSeriesData()||[];n.forEach(function(e,t){t||i.append($("<hr/>"));var n=null;try{n=this.rowsById[e.id];
}catch(a){}i.append($('<div class="item"/>').html("<span>"+_g.data.ships[e.id].getName(!0)+"</span>").append($('<div class="group"/>').append(function(){var t=$();return _frame.app_main.is_mode_selection()&&(t=t.add($("<menuitem/>").html("选择").on({click:function(){_frame.app_main.is_mode_selection()&&_frame.app_main.mode_selection_callback(e.id)}}))),t}).append($('<menuitem data-infos="[[SHIP::'+e.id+']]"/>').html("查看资料")).append($("<menuitem/>").html(n&&"true"===n.attr("compare")?"取消对比":"加入对比").on({click:function(e){n&&this.check(n)}.bind(this)}))))},this)}}.bind(this))]})),t.contextmenu._curid=i||e.data("shipid"),t.contextmenu._curel=e,void(n?t.contextmenu.show(n.clientX,n.clientY):t.contextmenu.show(e)))}},{key:"init_parse",value:function(){this.dom.filter_container=this.dom.container.children(".options"),this.dom.filters=this.dom.filter_container.children(".filters"),this.dom.exit_compare=this.dom.filter_container.children(".exit_compare"),this.dom.exit_compare.children('button[icon="arrow-set2-left"]').on("click",function(){this.compare_end()}.bind(this)),this.dom.exit_compare.children('button[icon="checkbox-checked"]').on("click",function(){this.compare_continue()}.bind(this)),this.dom.btn_compare_sort=this.dom.exit_compare.children('button[icon="sort-amount-desc"]').on("click",function(){this.dom.btn_compare_sort.hasClass("disabled")||this.sort_table_restore()}.bind(this)),this.dom.search=$('<p class="search"/>').prependTo(this.dom.filters).append(this.dom.searchInput=$('<input type="search" placeholder="搜索舰娘..."/>').on({input:function(e){clearTimeout(this.searchDelay),this.searchDelay=setTimeout(function(){this.search(e.target.value)}.bind(this),100)}.bind(this),focus:function(){this.dom.search.addClass("on")}.bind(this),blur:function(){this.dom.container.hasClass("mod-search")||this.dom.search.removeClass("on")}.bind(this)})),this.dom.btn_hide_premodel=this.dom.filters.find('[name="hide-premodel"]').prop("checked","false"===_config.get("shiplist-filter-hide-premodel")?null:!0).on("change",function(e){_config.set("shiplist-filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.dom.filter_container.attr("filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.thead_redraw()}.bind(this)),this.dom.filters.find('[name="viewtype"]').each(function(e,t){t=$(t);var i=_config.get("shiplist-viewtype")||"card";t.val()==i&&t.prop("checked",!0),t.on("change",function(e){t.is(":checked")&&(_config.set("shiplist-viewtype",t.val()),this.dom.filter_container.attr("viewtype",t.val()),this.thead_redraw())}.bind(this))}.bind(this)),this.dom.filters.find("input").trigger("change"),this.dom.table=this.dom.container.children(".tablelist-container"),this.dom.thead=this.dom.table.children(".tablelist-header").on("click","[stat]",function(e){this.sort_table_from_theadcell($(e.currentTarget))}.bind(this)),this.dom.tbody=this.dom.table.children(".tablelist-body").on("contextmenu.contextmenu_ship","[data-shipid]",function(e){this.contextmenu_show($(e.currentTarget),null,e),e.preventDefault()}.bind(this)).on("click","[data-shipid]",function(e,t){"label"==e.target.tagName.toLowerCase()?(this.check(e.currentTarget),e.stopPropagation()):"em"==e.target.tagName.toLowerCase()?(this.contextmenu_show($(e.target),e.currentTarget.getAttribute("data-shipid")),e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()):!t&&_frame.app_main.is_mode_selection()&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.currentTarget.getAttribute("data-donotcompare")||_frame.app_main.mode_selection_callback(e.currentTarget.getAttribute("data-shipid")))}.bind(this)),this.dom.msg_container=this.dom.container.children(".msgs"),_config.get("hide-compareinfos")?this.dom.msg_container.removeAttr("data-msgs"):this.dom.msg_container.attr("data-msgs","compareinfos"),this.parse_all_items();var e=this.dom.msg_container.children(".compareinfos");e.children("button").on("click",function(){this.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-compareinfos",!0)}.bind(this)),this.dom.msg_container.children(".comparestart").on("click",function(){this.compare_start()}.bind(this))}},{key:"parse_all_items",value:function(){var e=-1;this.dom.tbody.children("h4, dl").each(function(t,i){var n=this;if(i=$(i),i.attr("trindex",t),"H4"==i[0].tagName)!function(){e++,n.last_item=i;var t=i.find('input[type="checkbox"]').on({change:function(){t.data("ships").filter(":visible").each(function(e,i){this.check(i,t.prop("checked"),!0)}.bind(this))}.bind(n),docheck:function(){var e=t.data("ships").filter(":visible"),i=e.filter('[compare="true"]');i.length?i.length<e.length?t.prop({checked:!1,indeterminate:!0}):t.prop({checked:!0,indeterminate:!1}):t.prop({checked:!1,indeterminate:!1})}}).data("ships",$());n.header_checkbox[e]=t,n.mode_selection_filters.add($("<input/>",{value:e,type:"checkbox","class":"shiptype",id:"shiptype-"+e}).prop("checked",!e).prependTo(n.dom.container)),$("<label/>",{"for":"shiptype-"+e,"class":"shiptype"}).prependTo(i)}();else if(i.attr("data-shipid")){var a=i.attr("data-shipid"),o=e;i.attr("titleindex",e),this.header_checkbox[o].data("ships",this.header_checkbox[o].data("ships").add(i)),this.rowsById[a]=i,this.rows=this.rows.add(i)}}.bind(this)),this.mark_high(),this.thead_redraw(),_frame.app_main.loaded("tablelist_"+this._index,!0),delete this.last_item}},{key:"check",value:function(e,t,i){e.length&&(e=e[0]),("undefined"==typeof t||null===t)&&(t=!("true"==e.getAttribute("compare"))),t?e.setAttribute("compare","true"):e.removeAttribute("compare"),this.compare_btn_show(t),i||this.header_checkbox[parseInt(e.getAttribute("titleindex"))].trigger("docheck")}},{key:"search",value:function(e){if(this.dom.style||(this.dom.style=$("<style/>").appendTo(this.dom.container)),!e)return this.dom.container.removeClass("mod-search"),this.dom.filter_container.attr("filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.dom.style.empty(),e;if(e=_g.search(e,"ships"),!e.length)return e;this.dom.container.addClass("mod-search"),this.dom.filter_container.attr("filter-hide-premodel",!1);var t=".tablelist.ships .tablelist-body dl:not(:empty)";return e.forEach(function(e){t+=':not([data-shipid="'+e.id+'"])'}),t+="{display:none!important}",this.dom.style.html(t),e}}]),t}(Tablelist),TablelistEquipments=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,i));return n.columns=["  ",["火力","fire"],["雷装","torpedo"],["对空","aa"],["对潜","asw"],["爆装","bomb"],["命中","hit"],["装甲","armor"],["回避","evasion"],["索敌","los"],["射程","range"],["可改修","improvable"]],_frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,e.children(".tablelist-container").length&&n.init_parse(),n}return _inherits(t,e),_createClass(t,[{key:"apply_types",value:function(){this.dom.filter_types.removeAttr("class"),t.types.length&&(this.dom.filter_types.addClass("type"+t.types.join(" type")),this.generated&&this.apply_types_check())}},{key:"apply_types_check",value:function(){if(!t.shipIdLast||t.shipIdLast!=t.shipId){if(t.shipIdLast=t.shipId,t.shipId&&$.inArray(_g.data.ships[t.shipId].type,[9,10,11])>-1){for(var e=0,i=void 0,n=void 0;3!=this.dom.types[e++].attr("data-equipmentcollection")||$.inArray(parseInt(this.dom.types[e].attr("data-type"))||null,t.types)<=-1;)i=this.dom.types[e+1];return i=i||this.dom.types[0],this.dom.type_radios[3].prop("checked",!0).trigger("change"),n=i[0].offsetTop,n&&(n-=32),void this.dom.tbody.scrollTop(n||0)}if(t.types.length){for(var e=0,a=void 0,n=void 0;$.inArray(parseInt(this.dom.types[e++].attr("data-type"))||null,t.types)<=-1;)a=this.dom.types[e];a=a||this.dom.types[0],this.dom.type_radios[parseInt(a.attr("data-equipmentcollection"))||1].prop("checked",!0).trigger("change"),n=a[0].offsetTop,n&&(n-=32),this.dom.tbody.scrollTop(n||0)}}}},{key:"init_parse",value:function(){this.dom.filter_container=this.dom.container.children(".options"),this.dom.filters=this.dom.filter_container.children(".filters"),this.dom.type_radios={},this.dom.container.children('input[type="radio"][name="equipmentcollection"]').each(function(e,t){t=$(t);var i=parseInt(t.val());this.dom.type_radios[i]=t.prop("checked",1==i).on("change",function(){this.dom.tbody.scrollTop(0),this.thead_redraw()}.bind(this))}.bind(this)),this.dom.filter_types=this.dom.container.children('input[name="types"][type="hidden"]'),this.dom.table=this.dom.container.children(".tablelist-container"),this.dom.thead=this.dom.table.children(".tablelist-header"),this.dom.tbody=this.dom.table.children(".tablelist-body"),this.parse_all_items(),this.dom.msg_container=this.dom.container.children(".msgs"),_config.get("hide-equipmentsinfos")?this.dom.msg_container.removeAttr("data-msgs"):this.dom.msg_container.attr("data-msgs","equipmentsinfos");var e=this.dom.msg_container.children(".equipmentsinfos");e.children("button").on("click",function(){this.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-equipmentsinfos",!0)}.bind(this))}},{key:"parse_all_items",value:function(){this.generated=!1,this.dom.types=[];var e=-1;this.dom.tbody.children("h4, dl").each(function(i,n){n=$(n),"H4"==n[0].tagName?(e++,this.dom.types[e]=n):!function(){var e=parseInt(n.attr("data-equipmenttype"))||-1,i=n.attr("data-equipmentid");n.on("click",function(n,a){!a&&_frame.app_main.is_mode_selection()&&(n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),$.inArray(e,t.types)>-1&&_frame.app_main.mode_selection_callback(i))})}()}.bind(this)),this.thead_redraw(),this.generated=!0,this.apply_types_check(),_frame.app_main.loaded("tablelist_"+this._index,!0)}}]),t}(Tablelist);TablelistEquipments.gen_helper_equipable_on=function(e){var t="";return _g.data.item_types[e].equipable_on_type.forEach(function(i,n){var a=_g.data.item_types[e].equipable_on_type[n];t+="<span>"+_g.data.ship_types[a].full_zh+(n<_g.data.item_types[e].equipable_on_type.length-1?",&nbsp;":"")+"</span>"}),'<em class="helper" data-tip="<h4 class=item_equipable_on>可装备于</h4>'+t+'">?</em>'},TablelistEquipments.types=[],TablelistEquipments.shipId=null,TablelistEquipments.shipIdLast=null;var TablelistFleets=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,i));return n.columns=["  ",["创建者","user"],["修改时间","time_modify"],["评价","rating"],["","options"]],n.kancolle_calc={_ApplicationId:"l1aps8iaIfcq2ZzhOHJWNUU2XrNySIzRahodijXW",_ClientVersion:"js1.2.19",_InstallationId:"62522018-ec82-b434-f5a5-08c3ab61d932",_JavaScriptKey:"xOrFpWEQZFxUDK2fN1DwbKoj3zTKAEkgJHzwTuZ4"},_frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,n.dom.filter_container=$('<div class="options" viewtype="card"/>').appendTo(n.dom.container),n.dom.filters=$('<div class="filters"/>').appendTo(n.dom.filter_container),n.dom.btn_new=$('<button class="new" icon="import"/>').html("新建/导入").on("click",function(e,t){this.btn_new(t)}.bind(n)).appendTo(n.dom.filters),t.support.buildfile&&(n.dom.btn_exportFile=$('<button class="export" icon="floppy-disk"/>').html("导出配置文件").on("click",function(){_db.fleets.persistence.compactDatafile(),_g.isNWjs?_g.save(_db.fleets.filename,"fleets.json"):!function(){_frame.app_main.loading_start("tablelist_fleets_export",!1);var e="";_db.fleets.find({},function(t,i){if(t)_g.error(t);else{i.forEach(function(t){e+=JSON.stringify(t)+"\n"});var n=new Blob([e],{type:"application/json"});_g.save(URL.createObjectURL(n),"fleets.json")}_frame.app_main.loading_complete("tablelist_fleets_export")})}()}).appendTo(n.dom.filters)),n.dom.buttons_right=$('<div class="buttons_right"/>').appendTo(n.dom.filters),n.dom.setting_hqlv=$("<label/>",{"class":"setting setting-hqlv",html:"默认司令部等级","data-tip":"如果舰队配置没有设置司令部等级，<br/>则会使用该默认数值<br/>司令部等级会影响索敌能力的计算"}).on({"mouseenter mouseleave":function(e){_p.tip.is_showing&&!_p.tip.timeout_fade&&this.dom.setting_hqlv_input.is(":focus")&&(e.stopImmediatePropagation(),e.stopPropagation())}.bind(n)}).append(n.dom.setting_hqlv_input=$("<input/>",{type:"number",min:0,max:_g.shipMaxLv}).val(Lockr.get("hqLvDefault",_g.defaultHqLv)).on({input:function(){_g.updateDefaultHqLv(this.dom.setting_hqlv_input.val())}.bind(n),"focus.tipshow":function(){this.dom.setting_hqlv_input.trigger("tipshow")}.bind(n),"blur.tiphide":function(){this.dom.setting_hqlv_input.trigger("tiphide")}.bind(n),click:function(e){e.stopImmediatePropagation(),e.stopPropagation()}})).appendTo(n.dom.buttons_right),$body.on("update_defaultHqLv.update_fleets_hqlv_input",function(e,t){this.dom.setting_hqlv_input.val(t)}.bind(n)),n.dom.btn_settings=$('<button icon="cog"/>').on("click",function(){this.btn_settings()}.bind(n)).appendTo(n.dom.buttons_right),n.dom.table=$('<div class="tablelist-container"/>').appendTo(n.dom.container),n.dom.thead=$("<dl/>").appendTo($('<div class="tablelist-header"/>').appendTo(n.dom.table)),n.dom.tbody=$('<div class="tablelist-body" scrollbody/>').appendTo(n.dom.table).on("contextmenu.contextmenu_fleet","[data-fleetid]",function(e){this.contextmenu_show($(e.currentTarget),null,e),e.preventDefault()}.bind(n)).on("click.contextmenu_fleet","[data-fleetid]>dt>em",function(e){this.contextmenu_show($(e.currentTarget).parent().parent(),$(e.currentTarget)),e.stopImmediatePropagation(),e.stopPropagation()}.bind(n)),n.columns.forEach(function(e,t){"object"==("undefined"==typeof e?"undefined":_typeof(e))?$("<dd/>",{stat:e[1],html:e[0]}).appendTo(this.dom.thead):$("<dt/>").html(e[0]).appendTo(this.dom.thead)}.bind(n)),$('<div class="nocontent container"/>').append($($("<div/>").append($("<span>").html("暂无舰队配置")).append($("<button>").html("新建/导入").on("click",function(e){this.dom.btn_new.trigger("click",[e])}.bind(n))))).appendTo(n.dom.table),n.dom.container.on("focus.number_input_select",'input[type="number"]',function(e){e.currentTarget.select()}),n.genlist(),n}return _inherits(t,e),_createClass(t,[{key:"new_data",value:function(e){return $.extend({data:[],time_create:(new Date).valueOf(),time_modify:(new Date).valueOf(),hq_lv:-1,name:"",note:"",user:{},rating:-1,theme:_g.randNumber(10)},e||{})}},{key:"loaddata",value:function(){var e=Q.defer();return _db.fleets.find({}).sort({name:1}).exec(function(t,i){t?e.resolve([]):(i.forEach(function(e){e.data=InfosFleet.decompress(e.data)}),console.log(i),e.resolve(i))}),e.promise}},{key:"validdata",value:function(e){for(var t=Q.defer(),i=[],n=0,a=function(e){if(e.hq_lv>-1||e.name||e.note||e.rating>-1)return!0;if(!e.data||!e.data.length||!e.data.push)return!1;var t=!1,i=!0,n=!1,a=void 0;try{for(var o,s=e.data[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var r=o.value;if(r&&r.length&&r.push){var l=!0,d=!1,u=void 0;try{for(var c,h=r[Symbol.iterator]();!(l=(c=h.next()).done);l=!0){var p=c.value;"undefined"!=typeof p&&p&&p.push&&"undefined"!=typeof p[0]&&p[0]&&(t=!0)}}catch(m){d=!0,u=m}finally{try{!l&&h["return"]&&h["return"]()}finally{if(d)throw u}}}}}catch(m){n=!0,a=m}finally{try{!i&&s["return"]&&s["return"]()}finally{if(n)throw a}}return t};n<e.length;)a(e[n])?n++:(i.push(e[n]._id),e.splice(n,1));return i.length?_db.fleets.remove({_id:{$in:i}},{multi:!0},function(i,n){t.resolve(e)}):t.resolve(e),t.promise}},{key:"datacheck",value:function(e){return e=e||[],e.length?this.dom.container.removeClass("nocontent"):this.dom.container.addClass("nocontent"),e}},{key:"append_all_items",value:function(e){var t=this;e=e||[],e.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),this.trIndex=0,"undefined"==typeof Lockr.get("fleetlist-option-groupbytheme")&&Lockr.set("fleetlist-option-groupbytheme",!0);var i=Q.defer(),n=0;if(Lockr.get("fleetlist-option-groupbytheme"))!function(){var a={},o=0;e.forEach(function(e,t){a[e.theme]||(a[e.theme]=[]),a[e.theme].push(t)});for(var s in a){for(n=0;n<t.flexgrid_empty_count;)n?$('<dl data-fleetid trindex="99999"/>').appendTo(t.dom.tbody):t.flexgrid_ph=$('<dl data-fleetid trindex="99999"/>').appendTo(t.dom.tbody),n++;a[s].forEach(function(t){setTimeout(function(t){this.append_item(e[t]),o++,o>=e.length-1&&i.resolve()}.bind(this)(t),0)}.bind(t)),$("<h4/>",{trindex:++t.trIndex,html:"&nbsp;"}).appendTo(t.dom.tbody),t.trIndex++}}();else{for(;n<this.flexgrid_empty_count;)n?$('<dl data-fleetid trindex="99999"/>').appendTo(this.dom.tbody):this.flexgrid_ph=$('<dl data-fleetid trindex="99999"/>').appendTo(this.dom.tbody),n++;e.forEach(function(t,n){setTimeout(function(t){this.append_item(e[t]),t>=e.length-1&&i.resolve()}.bind(this)(n),0)}.bind(this))}return e.length||i.resolve(),i.promise}},{key:"append_item",value:function(e,t,i){if(!e)return!1;"undefined"==typeof t&&(t=this.trIndex,this.trIndex++);var n=$("<dl/>").attr({trindex:t,"data-fleetid":e._id||"PLACEHOLDER","data-infos":"[[FLEET::"+e._id+"]]","data-theme":e.theme}).data({initdata:e});return this.columns.forEach(function(t){switch(t[1]){case" ":for(var i="<i>",a=e.data[0]||[],o=0;6>o;)i+=a[o]&&a[o][0]?'<img class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'" src="'+_g.path.pics.ships+"/"+a[o][0]+"/0"+(_huCss.csscheck_full("mask-image")?".png":"-mask-2.png")+'" contextmenu="disabled"/>':'<s class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'"/>',o++;i+="</i>",$("<dt/>").attr("value",e.name).html(i+"<strong>"+e.name+"</strong><em></em>").appendTo(n);break;default:var s=e[t[1]];$("<dd/>").attr("value",s).html(s).appendTo(n)}}),i?n.prependTo(this.dom.tbody):n.insertBefore(this.flexgrid_ph),n}},{key:"btn_new",value:function(e){return this.menu_new||(this.menu_new=new _menu({target:this.dom.btn_new,className:"menu-fleets-new",items:[$('<div class="menu-fleets-new"/>').append($("<menuitem/>").html("新建配置").on("click",function(){this.action_new()}.bind(this))).append($("<menuitem/>").html("导入配置代码").on("click",function(){t.modalImport||(t.modalImport=$("<div/>").append(t.modalImportTextarea=$("<textarea/>",{placeholder:"输入配置代码..."})).append($("<p/>").html('* 配置代码兼容<a href="http://www.kancolle-calc.net/deckbuilder.html">艦載機厨デッキビルダー</a>')).append($('<p class="aircraftimportmax"/>').append(t.modalImportCheckAircraftMax=$("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftimportmax"))).append($("<label/>",{"class":"checkbox","for":"_input_g"+_g.inputIndex++,html:"飞行器熟练度自动提升至"}))).append(t.modalImportBtn=$('<button class="button"/>').html("导入").on("click",function(){var e=t.modalImportTextarea.val();e&&(e=JSON.parse(e),e.length&&e.push||(e=_g.kancolle_calc.decode(e)),this.action_new({data:e},{aircraftmax:t.modalImportCheckAircraftMax.prop("checked")||Lockr.get("fleetlist-option-aircraftimportmax")}),_frame.modal.hide(),t.modalImportTextarea.val(""))}.bind(this)))),t.modalImportTextarea.val(""),_frame.modal.show(t.modalImport,"导入配置代码",{classname:"infos_fleet infos_fleet_import",detach:!0})}.bind(this))).append(t.support.buildfile?$('<menuitem class="import_file"/>').html("导入配置文件").on("click",function(){this.dbfile_selector.trigger("click")}.bind(this)):null)]}),this.dbfile_selector=$('<input type="file" class="none"/>').on("change",function(e){_frame.app_main.loading_start("tablelist_fleets_import",!1),this.dbfile_selector.prop("disabled",!0);var t=this.dbfile_selector.val(),i=Q.fcall(function(){});i.then(function(){var i=Q.defer();if(_g.isNWjs)node.fs.readFile(t,"utf8",function(e,t){e?i.reject("文件载入失败",new Error(e)):i.resolve(t)});else for(var n=0,a=void 0;a=e.target.files[n];n++){var o=new FileReader;o.onload=function(e){return function(e){return i.resolve(e.target.result)}}(a),o.readAsText(a)}return i.promise}).then(function(e){this.dbfile_selector.val("");var t=[],i=Q.defer();return e.split("\n").forEach(function(e){if(e){try{t.push(JSON.parse(e))}catch(n){i.reject("文件格式错误",n)}i.resolve(t)}else i.reject("文件无内容")}),i.promise}.bind(this)).then(function(e){var t=[],i=0;return e.forEach(function(e){var n=Q.defer();t.push(n.promise),_db.fleets.insert(e,function(t){i++,t&&"uniqueViolated"==t.errorType?_db.fleets.update({_id:e._id},e,{},function(e,t){n.resolve(),e?_g.log(e):_g.log(t)}):n.resolve()})}),Q.all(t)}).then(function(){this.refresh(),_g.badgeMsg("成功导入配置")}.bind(this))["catch"](function(e,t){_g.log(e),_g.error(t),_g.badgeError(e)}).done(function(){_g.log("import complete"),_frame.app_main.loading_complete("tablelist_fleets_import"),this.dbfile_selector.prop("disabled",!1)}.bind(this))}.bind(this)).appendTo(this.dom.filters)),e&&e.clientX?this.menu_new.show(e.clientX,e.clientY):this.menu_new.show(e)}},{key:"btn_settings",value:function(){t.menuOptions_show(this.dom.btn_settings,this)}},{key:"action_new",value:function(e,t){e=e||{},t=t||{},e.data&&(e.data.forEach(function(e){e&&e.push&&e.forEach(function(e){e&&e.push&&e[2].forEach(function(i,n){i&&$.inArray(_g.data.items[i].type,Formula.equipmentType.Aircrafts)>-1&&(_g.data.items[i].rankupgradable&&(t.aircraftmax?e[4][n]=7:e[4][n]=e[3][n]||null),e[3][n]=null)})})}),InfosFleet.clean(e.data)),_db.fleets.insert(this.new_data(e,t),function(e,t){console.log(e,t),e?_g.error(e):"fleets"==_frame.app_main.cur_page&&(_frame.infos.show("[[FLEET::"+t._id+"]]"),this.menu_new.hide())}.bind(this))}},{key:"parse_kancolle_calc_data",value:function(e){return this.new_data(e)}},{key:"contextmenu_show",value:function(e,i,n){t.contextmenu||(t.contextmenu=new _menu({className:"contextmenu-fleet",items:[$("<menuitem/>").html("详情").on({click:function(e){t.contextmenu.curel.trigger("click",[!0])}}),$("<menuitem/>").html("导出配置代码").on({click:function(e){InfosFleet.modalExport_show(t.contextmenu.curel.data("initdata"))}}),$("<menuitem/>").html("导出配置文本").on({click:function(e){InfosFleet.modalExportText_show(t.contextmenu.curel.data("initdata"))}}),$("<menuitem/>").html("移除").on({click:function(e){var i=t.contextmenu.curel.attr("data-fleetid");i&&InfosFleet.modalRemove_show(i,t.contextmenu.curobject)}})]})),t.contextmenu.curobject=this,t.contextmenu.curel=e,n?t.contextmenu.show(n.clientX,n.clientY):t.contextmenu.show(i||e)}},{key:"genlist",value:function(e){Q.fcall(function(){}).then(function(){return this.loaddata()}.bind(this)).then(function(e){return this.validdata(e)}.bind(this)).then(function(e){return this.datacheck(e)}.bind(this)).then(function(e){return this.append_all_items(e)}.bind(this)).then(function(){setTimeout(function(){_frame.app_main.loaded("tablelist_"+this._index,!0)}.bind(this),100)}.bind(this))["catch"](function(e){_g.log(e)}).done(function(){e&&e(),_g.log("Fleets list DONE")})}},{key:"refresh",value:function(){console.log("refresh"),this.dom.tbody.empty(),this.genlist(function(){this.dom.tbody.scrollTop(this.dom.tbody.attr("scrollbody")||0)}.bind(this))}}]),t}(Tablelist);TablelistFleets.menuOptions_show=function(e,t){if(!TablelistFleets.menuOptions){var i=[$('<menuitem class="mod-checkbox donot_hide option-in-tablelist option-groupbytheme"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-groupbytheme")).on("change",function(e){Lockr.set("fleetlist-option-groupbytheme",e.target.checked),TablelistFleets.menuOptions.curTablelist&&(TablelistFleets.menuOptions.curTablelist.dom.tbody.empty(),TablelistFleets.menuOptions.curTablelist.genlist())})).append($("<label/>",{"for":"_input_g"+_g.inputIndex++,html:"按主题颜色进行分组"})),$('<menuitem class="mod-checkbox donot_hide option-in-tablelist option-aircraftdefaultmax option-aircraftimportmax"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftimportmax")).on("change",function(e){Lockr.set("fleetlist-option-aircraftimportmax",e.target.checked)})).append($("<label/>",{"for":"_input_g"+_g.inputIndex++,html:"导入配置时提升飞行器熟练度至"})),$('<menuitem class="mod-checkbox donot_hide option-aircraftdefaultmax"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftdefaultmax")).on("change",function(e){Lockr.set("fleetlist-option-aircraftdefaultmax",e.target.checked)})).append($("<label/>",{"for":"_input_g"+_g.inputIndex++,html:'<span class="inline option-in-tablelist">配装时</span>新增飞行器熟练度默认为'})),$('<hr class="option-in-infos"/>'),$("<menuitem/>",{"class":"option-in-infos",html:"移除配置"}).on("click",function(){InfosFleet.cur&&InfosFleet.cur.remove()})];_g.isNWjs&&(i=i.concat([$('<hr class="option-in-tablelist"/>'),$('<div class="option-in-tablelist option-filelocation"/>').html("<span>置配置文件位置</span>").append(TablelistFleets.filelocation_selector=$('<input type="file" class="none" webkitdirectory/>').on("change",function(e){TablelistFleets.moveBuildsLocation(TablelistFleets.filelocation_selector.val())})).append($('<button type="button">还原</button>').on("click",function(){TablelistFleets.moveBuildsLocation(node.path.join(node.gui.App.dataPath,"NeDB"))})).append($('<button type="button">选择</button>').on("click",function(){TablelistFleets.filelocation_selector.click()}))])),TablelistFleets.menuOptions=new _menu({className:"menu-tablelistfleets-options",items:i})}TablelistFleets.menuOptions.curTablelist=t||null,t?TablelistFleets.menuOptions.dom.menu.addClass("is-tablelist"):TablelistFleets.menuOptions.dom.menu.removeClass("is-tablelist"),TablelistFleets.menuOptions.show(e)},TablelistFleets.support={},TablelistFleets.support.buildfile=_g.isNWjs||window.File&&window.FileReader&&window.FileList&&window.Blob&&window.URL?!0:!1,TablelistFleets.moveBuildsLocation=function(e){if(e){_frame.app_main.loading_start("tablelist_fleets_newlocation",!1),TablelistFleets.filelocation_selector.prop("disabled",!0);var t="fleets.json",i=1,n=!1,a=Lockr.get("fleets-builds-file",node.path.join(node.gui.App.dataPath,"NeDB","fleets.json"));try{n=node.fs.lstatSync(node.path.join(e,t))?!0:!1}catch(o){n=!1}for(;n;){t="fleets-"+i++ +".json";try{n=node.fs.lstatSync(node.path.join(e,t))?!0:!1}catch(o){n=!1}}var s=node.path.join(e,t);Lockr.set("fleets-builds-file",s),_db.fleets=new node.nedb({filename:s}),node.mkdirp.sync(e),Q.fcall(function(){function e(e){i||(t.resolve(),i=!0)}var t=Q.defer(),i=!1,n=node.fs.createReadStream(a);n.on("error",function(t){e(t)});var o=node.fs.createWriteStream(s);return o.on("error",function(t){e(t)}),o.on("close",function(t){e()}),n.pipe(o),t.promise}).then(function(){var e=Q.defer();return _db.fleets.loadDatabase(function(){e.resolve()}),e.promise}).done(function(){_frame.app_main.loading_complete("tablelist_fleets_newlocation"),TablelistFleets.filelocation_selector.prop("disabled",!1),TablelistFleets.filelocation_selector.val("")})}};